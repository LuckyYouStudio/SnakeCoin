<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🐍 LuckSnake - 幸运数字生成器</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.1/dist/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 3rem;
            color: #333;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header p {
            font-size: 1.2rem;
            color: #666;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .wallet-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }

        .wallet-info {
            display: none;
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .wallet-info.show {
            display: block;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .stat-card h3 {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .stat-card p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-panel {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .control-panel h3 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .numbers-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .numbers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }

        .number-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 10px;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1rem;
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        }

        .query-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .query-result {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            min-height: 50px;
            color: #333;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .alert.success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .alert.error {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        .alert.info {
            background: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }

        .transaction-hash {
            font-family: monospace;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            word-break: break-all;
            margin-top: 10px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .controls {
                grid-template-columns: 1fr;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🐍 LuckSnake</h1>
            <p>支付 0.0001 ETH 获取你的幸运数字 (000-999)</p>
        </div>

        <!-- 钱包连接区域 -->
        <div class="wallet-section">
            <button id="connectWallet" class="btn">连接钱包</button>
            <div id="walletInfo" class="wallet-info">
                <p><strong>已连接钱包:</strong> <span id="walletAddress"></span></p>
                <p><strong>余额:</strong> <span id="walletBalance"></span> ETH</p>
                <p><strong>网络:</strong> <span id="networkName"></span></p>
            </div>
        </div>

        <!-- 系统状态 -->
        <div class="stats">
            <div class="stat-card">
                <h3 id="totalGenerated">-</h3>
                <p>已生成数字</p>
            </div>
            <div class="stat-card">
                <h3 id="remainingNumbers">-</h3>
                <p>剩余数字</p>
            </div>
            <div class="stat-card">
                <h3 id="contractBalance">-</h3>
                <p>合约余额 (ETH)</p>
            </div>
            <div class="stat-card">
                <h3>0.0001</h3>
                <p>生成价格 (ETH)</p>
            </div>
        </div>

        <!-- 功能控制区域 -->
        <div class="controls">
            <!-- 生成数字 -->
            <div class="control-panel">
                <h3>🎲 生成幸运数字</h3>
                <button id="generateNumber" class="btn" disabled>生成数字 (0.0001 ETH)</button>
            </div>

            <!-- 查询功能 -->
            <div class="control-panel">
                <h3>🔍 查询功能</h3>
                <div class="form-group">
                    <label for="queryAddress">查询地址拥有的数字:</label>
                    <input type="text" id="queryAddress" placeholder="输入钱包地址">
                    <button id="queryUserNumbers" class="btn">查询用户数字</button>
                </div>
                <div class="form-group">
                    <label for="queryNumber">查询数字的所有者:</label>
                    <input type="number" id="queryNumber" placeholder="输入数字 (0-999)" min="0" max="999">
                    <button id="queryNumberOwner" class="btn">查询数字所有者</button>
                </div>
            </div>
        </div>

        <!-- 消息显示区域 -->
        <div id="messageArea"></div>

        <!-- 我的数字 -->
        <div class="numbers-section">
            <h3>🎯 我的幸运数字</h3>
            <p>数量: <span id="myNumberCount">0</span></p>
            <div id="myNumbers" class="numbers-grid">
                <!-- 用户的数字将在这里显示 -->
            </div>
        </div>

        <!-- 查询结果 -->
        <div class="query-section">
            <h3>📊 查询结果</h3>
            <div id="queryResult" class="query-result">
                点击上方按钮开始查询...
            </div>
        </div>
    </div>

    <script>
        // 合约配置
        const CONTRACT_ADDRESS = '0x68B1D87F95878fE05B998F19b66F4baba5De1aed';
        const CONTRACT_ABI = [
            "function generateNumber() external payable",
            "function getUserNumbers(address user) external view returns (uint256[])",
            "function getNumberOwner(uint256 number) external view returns (address)",
            "function isNumberTaken(uint256 number) external view returns (bool)",
            "function getUserNumberCount(address user) external view returns (uint256)",
            "function getSystemInfo() external view returns (uint256 price, uint256 totalGenerated, uint256 remaining, uint256 contractBalance)",
            "function GENERATION_PRICE() external view returns (uint256)",
            "function owner() external view returns (address)",
            "event NumberGenerated(address indexed user, uint256 indexed number, uint256 price)"
        ];

        let provider, signer, contract, userAccount;

        // 页面加载完成后初始化
        window.addEventListener('load', async () => {
            await initializeApp();
        });

        // 初始化应用
        async function initializeApp() {
            if (window.ethereum) {
                provider = new ethers.BrowserProvider(window.ethereum);
                
                // 检查是否已连接
                const accounts = await provider.listAccounts();
                if (accounts.length > 0) {
                    await connectWallet();
                }
            } else {
                showMessage('请安装MetaMask钱包', 'error');
            }
        }

        // 连接钱包
        async function connectWallet() {
            try {
                if (!window.ethereum) {
                    throw new Error('请安装MetaMask钱包');
                }

                await window.ethereum.request({ method: 'eth_requestAccounts' });
                signer = await provider.getSigner();
                userAccount = await signer.getAddress();
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

                // 更新UI
                document.getElementById('walletAddress').textContent = userAccount.substring(0, 6) + '...' + userAccount.substring(38);
                document.getElementById('walletInfo').classList.add('show');
                document.getElementById('connectWallet').textContent = '已连接';
                document.getElementById('connectWallet').disabled = true;

                // 启用功能按钮
                document.getElementById('generateNumber').disabled = false;

                // 更新余额和网络信息
                await updateWalletInfo();
                await updateContractInfo();
                await updateUserNumbers();

                showMessage('钱包连接成功！', 'success');
            } catch (error) {
                console.error('连接钱包失败:', error);
                showMessage('连接钱包失败: ' + error.message, 'error');
            }
        }

        // 更新钱包信息
        async function updateWalletInfo() {
            try {
                const balance = await provider.getBalance(userAccount);
                document.getElementById('walletBalance').textContent = ethers.formatEther(balance);

                const network = await provider.getNetwork();
                document.getElementById('networkName').textContent = network.name || 'Unknown';
            } catch (error) {
                console.error('更新钱包信息失败:', error);
            }
        }

        // 更新合约信息
        async function updateContractInfo() {
            try {
                const systemInfo = await contract.getSystemInfo();
                document.getElementById('totalGenerated').textContent = systemInfo.totalGenerated.toString();
                document.getElementById('remainingNumbers').textContent = systemInfo.remaining.toString();
                document.getElementById('contractBalance').textContent = ethers.formatEther(systemInfo.contractBalance);
            } catch (error) {
                console.error('更新合约信息失败:', error);
            }
        }

        // 更新用户数字
        async function updateUserNumbers() {
            try {
                const numbers = await contract.getUserNumbers(userAccount);
                const count = numbers.length;
                
                document.getElementById('myNumberCount').textContent = count;
                
                const numbersGrid = document.getElementById('myNumbers');
                numbersGrid.innerHTML = '';
                
                if (count === 0) {
                    numbersGrid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #666;">暂无数字</p>';
                } else {
                    numbers.forEach(number => {
                        const badge = document.createElement('div');
                        badge.className = 'number-badge';
                        badge.textContent = number.toString().padStart(3, '0');
                        numbersGrid.appendChild(badge);
                    });
                }
            } catch (error) {
                console.error('更新用户数字失败:', error);
            }
        }

        // 生成数字
        async function generateNumber() {
            try {
                const button = document.getElementById('generateNumber');
                button.innerHTML = '<span class="loading"></span>生成中...';
                button.disabled = true;

                const generationPrice = await contract.GENERATION_PRICE();
                const tx = await contract.generateNumber({ value: generationPrice });
                
                showMessage('交易已提交，等待确认...', 'info');
                showMessage('<div class="transaction-hash">交易哈希: ' + tx.hash + '</div>', 'info');

                const receipt = await tx.wait();
                
                // 查找事件
                const event = receipt.logs.find(log => {
                    try {
                        const parsed = contract.interface.parseLog(log);
                        return parsed.name === 'NumberGenerated';
                    } catch (e) {
                        return false;
                    }
                });

                if (event) {
                    const parsedEvent = contract.interface.parseLog(event);
                    const generatedNumber = parsedEvent.args.number.toString();
                    showMessage(`🎉 恭喜！你获得了数字: ${generatedNumber.padStart(3, '0')}`, 'success');
                } else {
                    showMessage('数字生成成功！', 'success');
                }

                // 更新信息
                await updateContractInfo();
                await updateUserNumbers();
                await updateWalletInfo();

            } catch (error) {
                console.error('生成数字失败:', error);
                showMessage('生成数字失败: ' + error.message, 'error');
            } finally {
                const button = document.getElementById('generateNumber');
                button.innerHTML = '生成数字 (0.0001 ETH)';
                button.disabled = false;
            }
        }

        // 查询用户数字
        async function queryUserNumbers() {
            try {
                const address = document.getElementById('queryAddress').value.trim();
                if (!address) {
                    showMessage('请输入要查询的地址', 'error');
                    return;
                }

                if (!ethers.isAddress(address)) {
                    showMessage('请输入有效的以太坊地址', 'error');
                    return;
                }

                const numbers = await contract.getUserNumbers(address);
                const count = numbers.length;

                let result = `<p><strong>地址:</strong> ${address}</p>`;
                result += `<p><strong>拥有数字数量:</strong> ${count}</p>`;
                
                if (count > 0) {
                    result += `<p><strong>拥有的数字:</strong></p>`;
                    result += `<div class="numbers-grid">`;
                    numbers.forEach(number => {
                        result += `<div class="number-badge">${number.toString().padStart(3, '0')}</div>`;
                    });
                    result += `</div>`;
                } else {
                    result += `<p>该地址暂无数字</p>`;
                }

                document.getElementById('queryResult').innerHTML = result;
            } catch (error) {
                console.error('查询用户数字失败:', error);
                document.getElementById('queryResult').innerHTML = `<p style="color: red;">查询失败: ${error.message}</p>`;
            }
        }

        // 查询数字所有者
        async function queryNumberOwner() {
            try {
                const number = parseInt(document.getElementById('queryNumber').value);
                if (isNaN(number) || number < 0 || number > 999) {
                    showMessage('请输入有效的数字 (0-999)', 'error');
                    return;
                }

                const owner = await contract.getNumberOwner(number);
                const isTaken = await contract.isNumberTaken(number);

                let result = `<p><strong>查询数字:</strong> ${number.toString().padStart(3, '0')}</p>`;
                result += `<p><strong>是否已被占用:</strong> ${isTaken ? '是' : '否'}</p>`;
                
                if (isTaken && owner !== '0x0000000000000000000000000000000000000000') {
                    result += `<p><strong>所有者:</strong> ${owner}</p>`;
                } else {
                    result += `<p><strong>所有者:</strong> 暂无</p>`;
                }

                document.getElementById('queryResult').innerHTML = result;
            } catch (error) {
                console.error('查询数字所有者失败:', error);
                document.getElementById('queryResult').innerHTML = `<p style="color: red;">查询失败: ${error.message}</p>`;
            }
        }

        // 显示消息
        function showMessage(message, type) {
            const messageArea = document.getElementById('messageArea');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${type}`;
            alertDiv.innerHTML = message;
            
            messageArea.appendChild(alertDiv);
            
            // 5秒后自动移除消息
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }

        // 事件监听器
        document.getElementById('connectWallet').addEventListener('click', connectWallet);
        document.getElementById('generateNumber').addEventListener('click', generateNumber);
        document.getElementById('queryUserNumbers').addEventListener('click', queryUserNumbers);
        document.getElementById('queryNumberOwner').addEventListener('click', queryNumberOwner);

        // 监听账户变化
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', async (accounts) => {
                if (accounts.length === 0) {
                    // 用户断开连接
                    location.reload();
                } else {
                    // 用户切换账户
                    await connectWallet();
                }
            });

            window.ethereum.on('chainChanged', () => {
                // 网络变化时重新加载页面
                location.reload();
            });
        }
    </script>
</body>
</html>