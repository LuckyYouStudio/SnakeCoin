<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ LuckSnake - å¹¸è¿æ•°å­—ç”Ÿæˆå™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.1/dist/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 3rem;
            color: #333;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header p {
            font-size: 1.2rem;
            color: #666;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .wallet-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }

        .wallet-info {
            display: none;
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .wallet-info.show {
            display: block;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .stat-card h3 {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .stat-card p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-panel {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .control-panel h3 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .numbers-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .numbers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }

        .number-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 10px;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1rem;
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        }

        .query-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .query-result {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            min-height: 50px;
            color: #333;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .alert.success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .alert.error {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        .alert.info {
            background: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }

        .transaction-hash {
            font-family: monospace;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            word-break: break-all;
            margin-top: 10px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .controls {
                grid-template-columns: 1fr;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ LuckSnake</h1>
            <p>æ”¯ä»˜ 0.0001 ETH è·å–ä½ çš„å¹¸è¿æ•°å­— (000-999)</p>
        </div>

        <!-- é’±åŒ…è¿æ¥åŒºåŸŸ -->
        <div class="wallet-section">
            <button id="connectWallet" class="btn">è¿æ¥é’±åŒ…</button>
            <div id="walletInfo" class="wallet-info">
                <p><strong>å·²è¿æ¥é’±åŒ…:</strong> <span id="walletAddress"></span></p>
                <p><strong>ä½™é¢:</strong> <span id="walletBalance"></span> ETH</p>
                <p><strong>ç½‘ç»œ:</strong> <span id="networkName"></span></p>
            </div>
        </div>

        <!-- ç³»ç»ŸçŠ¶æ€ -->
        <div class="stats">
            <div class="stat-card">
                <h3 id="totalGenerated">-</h3>
                <p>å·²ç”Ÿæˆæ•°å­—</p>
            </div>
            <div class="stat-card">
                <h3 id="remainingNumbers">-</h3>
                <p>å‰©ä½™æ•°å­—</p>
            </div>
            <div class="stat-card">
                <h3 id="contractBalance">-</h3>
                <p>åˆçº¦ä½™é¢ (ETH)</p>
            </div>
            <div class="stat-card">
                <h3>0.0001</h3>
                <p>ç”Ÿæˆä»·æ ¼ (ETH)</p>
            </div>
        </div>

        <!-- åŠŸèƒ½æ§åˆ¶åŒºåŸŸ -->
        <div class="controls">
            <!-- ç”Ÿæˆæ•°å­— -->
            <div class="control-panel">
                <h3>ğŸ² ç”Ÿæˆå¹¸è¿æ•°å­—</h3>
                <button id="generateNumber" class="btn" disabled>ç”Ÿæˆæ•°å­— (0.0001 ETH)</button>
            </div>

            <!-- æŸ¥è¯¢åŠŸèƒ½ -->
            <div class="control-panel">
                <h3>ğŸ” æŸ¥è¯¢åŠŸèƒ½</h3>
                <div class="form-group">
                    <label for="queryAddress">æŸ¥è¯¢åœ°å€æ‹¥æœ‰çš„æ•°å­—:</label>
                    <input type="text" id="queryAddress" placeholder="è¾“å…¥é’±åŒ…åœ°å€">
                    <button id="queryUserNumbers" class="btn">æŸ¥è¯¢ç”¨æˆ·æ•°å­—</button>
                </div>
                <div class="form-group">
                    <label for="queryNumber">æŸ¥è¯¢æ•°å­—çš„æ‰€æœ‰è€…:</label>
                    <input type="number" id="queryNumber" placeholder="è¾“å…¥æ•°å­— (0-999)" min="0" max="999">
                    <button id="queryNumberOwner" class="btn">æŸ¥è¯¢æ•°å­—æ‰€æœ‰è€…</button>
                </div>
            </div>
        </div>

        <!-- æ¶ˆæ¯æ˜¾ç¤ºåŒºåŸŸ -->
        <div id="messageArea"></div>

        <!-- æˆ‘çš„æ•°å­— -->
        <div class="numbers-section">
            <h3>ğŸ¯ æˆ‘çš„å¹¸è¿æ•°å­—</h3>
            <p>æ•°é‡: <span id="myNumberCount">0</span></p>
            <div id="myNumbers" class="numbers-grid">
                <!-- ç”¨æˆ·çš„æ•°å­—å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>

        <!-- æŸ¥è¯¢ç»“æœ -->
        <div class="query-section">
            <h3>ğŸ“Š æŸ¥è¯¢ç»“æœ</h3>
            <div id="queryResult" class="query-result">
                ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æŸ¥è¯¢...
            </div>
        </div>
    </div>

    <script>
        // åˆçº¦é…ç½®
        const CONTRACT_ADDRESS = '0x68B1D87F95878fE05B998F19b66F4baba5De1aed';
        const CONTRACT_ABI = [
            "function generateNumber() external payable",
            "function getUserNumbers(address user) external view returns (uint256[])",
            "function getNumberOwner(uint256 number) external view returns (address)",
            "function isNumberTaken(uint256 number) external view returns (bool)",
            "function getUserNumberCount(address user) external view returns (uint256)",
            "function getSystemInfo() external view returns (uint256 price, uint256 totalGenerated, uint256 remaining, uint256 contractBalance)",
            "function GENERATION_PRICE() external view returns (uint256)",
            "function owner() external view returns (address)",
            "event NumberGenerated(address indexed user, uint256 indexed number, uint256 price)"
        ];

        let provider, signer, contract, userAccount;

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', async () => {
            await initializeApp();
        });

        // åˆå§‹åŒ–åº”ç”¨
        async function initializeApp() {
            if (window.ethereum) {
                provider = new ethers.BrowserProvider(window.ethereum);
                
                // æ£€æŸ¥æ˜¯å¦å·²è¿æ¥
                const accounts = await provider.listAccounts();
                if (accounts.length > 0) {
                    await connectWallet();
                }
            } else {
                showMessage('è¯·å®‰è£…MetaMaské’±åŒ…', 'error');
            }
        }

        // è¿æ¥é’±åŒ…
        async function connectWallet() {
            try {
                if (!window.ethereum) {
                    throw new Error('è¯·å®‰è£…MetaMaské’±åŒ…');
                }

                await window.ethereum.request({ method: 'eth_requestAccounts' });
                signer = await provider.getSigner();
                userAccount = await signer.getAddress();
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

                // æ›´æ–°UI
                document.getElementById('walletAddress').textContent = userAccount.substring(0, 6) + '...' + userAccount.substring(38);
                document.getElementById('walletInfo').classList.add('show');
                document.getElementById('connectWallet').textContent = 'å·²è¿æ¥';
                document.getElementById('connectWallet').disabled = true;

                // å¯ç”¨åŠŸèƒ½æŒ‰é’®
                document.getElementById('generateNumber').disabled = false;

                // æ›´æ–°ä½™é¢å’Œç½‘ç»œä¿¡æ¯
                await updateWalletInfo();
                await updateContractInfo();
                await updateUserNumbers();

                showMessage('é’±åŒ…è¿æ¥æˆåŠŸï¼', 'success');
            } catch (error) {
                console.error('è¿æ¥é’±åŒ…å¤±è´¥:', error);
                showMessage('è¿æ¥é’±åŒ…å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ›´æ–°é’±åŒ…ä¿¡æ¯
        async function updateWalletInfo() {
            try {
                const balance = await provider.getBalance(userAccount);
                document.getElementById('walletBalance').textContent = ethers.formatEther(balance);

                const network = await provider.getNetwork();
                document.getElementById('networkName').textContent = network.name || 'Unknown';
            } catch (error) {
                console.error('æ›´æ–°é’±åŒ…ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        // æ›´æ–°åˆçº¦ä¿¡æ¯
        async function updateContractInfo() {
            try {
                const systemInfo = await contract.getSystemInfo();
                document.getElementById('totalGenerated').textContent = systemInfo.totalGenerated.toString();
                document.getElementById('remainingNumbers').textContent = systemInfo.remaining.toString();
                document.getElementById('contractBalance').textContent = ethers.formatEther(systemInfo.contractBalance);
            } catch (error) {
                console.error('æ›´æ–°åˆçº¦ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        // æ›´æ–°ç”¨æˆ·æ•°å­—
        async function updateUserNumbers() {
            try {
                const numbers = await contract.getUserNumbers(userAccount);
                const count = numbers.length;
                
                document.getElementById('myNumberCount').textContent = count;
                
                const numbersGrid = document.getElementById('myNumbers');
                numbersGrid.innerHTML = '';
                
                if (count === 0) {
                    numbersGrid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #666;">æš‚æ— æ•°å­—</p>';
                } else {
                    numbers.forEach(number => {
                        const badge = document.createElement('div');
                        badge.className = 'number-badge';
                        badge.textContent = number.toString().padStart(3, '0');
                        numbersGrid.appendChild(badge);
                    });
                }
            } catch (error) {
                console.error('æ›´æ–°ç”¨æˆ·æ•°å­—å¤±è´¥:', error);
            }
        }

        // ç”Ÿæˆæ•°å­—
        async function generateNumber() {
            try {
                const button = document.getElementById('generateNumber');
                button.innerHTML = '<span class="loading"></span>ç”Ÿæˆä¸­...';
                button.disabled = true;

                const generationPrice = await contract.GENERATION_PRICE();
                const tx = await contract.generateNumber({ value: generationPrice });
                
                showMessage('äº¤æ˜“å·²æäº¤ï¼Œç­‰å¾…ç¡®è®¤...', 'info');
                showMessage('<div class="transaction-hash">äº¤æ˜“å“ˆå¸Œ: ' + tx.hash + '</div>', 'info');

                const receipt = await tx.wait();
                
                // æŸ¥æ‰¾äº‹ä»¶
                const event = receipt.logs.find(log => {
                    try {
                        const parsed = contract.interface.parseLog(log);
                        return parsed.name === 'NumberGenerated';
                    } catch (e) {
                        return false;
                    }
                });

                if (event) {
                    const parsedEvent = contract.interface.parseLog(event);
                    const generatedNumber = parsedEvent.args.number.toString();
                    showMessage(`ğŸ‰ æ­å–œï¼ä½ è·å¾—äº†æ•°å­—: ${generatedNumber.padStart(3, '0')}`, 'success');
                } else {
                    showMessage('æ•°å­—ç”ŸæˆæˆåŠŸï¼', 'success');
                }

                // æ›´æ–°ä¿¡æ¯
                await updateContractInfo();
                await updateUserNumbers();
                await updateWalletInfo();

            } catch (error) {
                console.error('ç”Ÿæˆæ•°å­—å¤±è´¥:', error);
                showMessage('ç”Ÿæˆæ•°å­—å¤±è´¥: ' + error.message, 'error');
            } finally {
                const button = document.getElementById('generateNumber');
                button.innerHTML = 'ç”Ÿæˆæ•°å­— (0.0001 ETH)';
                button.disabled = false;
            }
        }

        // æŸ¥è¯¢ç”¨æˆ·æ•°å­—
        async function queryUserNumbers() {
            try {
                const address = document.getElementById('queryAddress').value.trim();
                if (!address) {
                    showMessage('è¯·è¾“å…¥è¦æŸ¥è¯¢çš„åœ°å€', 'error');
                    return;
                }

                if (!ethers.isAddress(address)) {
                    showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„ä»¥å¤ªåŠåœ°å€', 'error');
                    return;
                }

                const numbers = await contract.getUserNumbers(address);
                const count = numbers.length;

                let result = `<p><strong>åœ°å€:</strong> ${address}</p>`;
                result += `<p><strong>æ‹¥æœ‰æ•°å­—æ•°é‡:</strong> ${count}</p>`;
                
                if (count > 0) {
                    result += `<p><strong>æ‹¥æœ‰çš„æ•°å­—:</strong></p>`;
                    result += `<div class="numbers-grid">`;
                    numbers.forEach(number => {
                        result += `<div class="number-badge">${number.toString().padStart(3, '0')}</div>`;
                    });
                    result += `</div>`;
                } else {
                    result += `<p>è¯¥åœ°å€æš‚æ— æ•°å­—</p>`;
                }

                document.getElementById('queryResult').innerHTML = result;
            } catch (error) {
                console.error('æŸ¥è¯¢ç”¨æˆ·æ•°å­—å¤±è´¥:', error);
                document.getElementById('queryResult').innerHTML = `<p style="color: red;">æŸ¥è¯¢å¤±è´¥: ${error.message}</p>`;
            }
        }

        // æŸ¥è¯¢æ•°å­—æ‰€æœ‰è€…
        async function queryNumberOwner() {
            try {
                const number = parseInt(document.getElementById('queryNumber').value);
                if (isNaN(number) || number < 0 || number > 999) {
                    showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­— (0-999)', 'error');
                    return;
                }

                const owner = await contract.getNumberOwner(number);
                const isTaken = await contract.isNumberTaken(number);

                let result = `<p><strong>æŸ¥è¯¢æ•°å­—:</strong> ${number.toString().padStart(3, '0')}</p>`;
                result += `<p><strong>æ˜¯å¦å·²è¢«å ç”¨:</strong> ${isTaken ? 'æ˜¯' : 'å¦'}</p>`;
                
                if (isTaken && owner !== '0x0000000000000000000000000000000000000000') {
                    result += `<p><strong>æ‰€æœ‰è€…:</strong> ${owner}</p>`;
                } else {
                    result += `<p><strong>æ‰€æœ‰è€…:</strong> æš‚æ— </p>`;
                }

                document.getElementById('queryResult').innerHTML = result;
            } catch (error) {
                console.error('æŸ¥è¯¢æ•°å­—æ‰€æœ‰è€…å¤±è´¥:', error);
                document.getElementById('queryResult').innerHTML = `<p style="color: red;">æŸ¥è¯¢å¤±è´¥: ${error.message}</p>`;
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type) {
            const messageArea = document.getElementById('messageArea');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${type}`;
            alertDiv.innerHTML = message;
            
            messageArea.appendChild(alertDiv);
            
            // 5ç§’åè‡ªåŠ¨ç§»é™¤æ¶ˆæ¯
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }

        // äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('connectWallet').addEventListener('click', connectWallet);
        document.getElementById('generateNumber').addEventListener('click', generateNumber);
        document.getElementById('queryUserNumbers').addEventListener('click', queryUserNumbers);
        document.getElementById('queryNumberOwner').addEventListener('click', queryNumberOwner);

        // ç›‘å¬è´¦æˆ·å˜åŒ–
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', async (accounts) => {
                if (accounts.length === 0) {
                    // ç”¨æˆ·æ–­å¼€è¿æ¥
                    location.reload();
                } else {
                    // ç”¨æˆ·åˆ‡æ¢è´¦æˆ·
                    await connectWallet();
                }
            });

            window.ethereum.on('chainChanged', () => {
                // ç½‘ç»œå˜åŒ–æ—¶é‡æ–°åŠ è½½é¡µé¢
                location.reload();
            });
        }
    </script>
</body>
</html>