<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ LuckSnake - äº¤æ˜“è°ƒè¯•ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.1/dist/ethers.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .debug-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid #007bff;
        }
        .error {
            background: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }
        .success {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }
        .warning {
            background: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .log {
            background: #f8f9fa;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 3px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .info { color: #0066cc; }
        .error-log { color: #dc3545; }
        .success-log { color: #28a745; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ LuckSnake äº¤æ˜“è°ƒè¯•</h1>
        <p>è¿™ä¸ªé¡µé¢ç”¨äºè°ƒè¯•äº¤æ˜“é—®é¢˜ï¼ŒåŒ…å«è¯¦ç»†çš„æ—¥å¿—è¾“å‡ºã€‚</p>

        <!-- è¿æ¥çŠ¶æ€ -->
        <div class="debug-section">
            <h3>è¿æ¥çŠ¶æ€</h3>
            <p><strong>é’±åŒ…çŠ¶æ€:</strong> <span id="walletStatus">æœªè¿æ¥</span></p>
            <p><strong>åˆçº¦åœ°å€:</strong> 0xe342E701f808D942FF70a5a48E596fF9056406F7</p>
            <p><strong>ç½‘ç»œ:</strong> <span id="networkInfo">æœªçŸ¥</span></p>
            <p><strong>è´¦æˆ·:</strong> <span id="accountInfo">æœªè¿æ¥</span></p>
            <p><strong>ä½™é¢:</strong> <span id="balanceInfo">-</span> ETH</p>
        </div>

        <!-- æ§åˆ¶æŒ‰é’® -->
        <div class="debug-section">
            <h3>æ“ä½œæ§åˆ¶</h3>
            <button id="connectBtn" onclick="connectWallet()">è¿æ¥é’±åŒ…</button>
            <button id="checkContractBtn" onclick="checkContract()">æ£€æŸ¥åˆçº¦</button>
            <button id="getPriceBtn" onclick="getPrice()">è·å–ä»·æ ¼</button>
            <button id="generateBtn" onclick="generateNumberDebug()" disabled>ç”Ÿæˆæ•°å­— (è°ƒè¯•ç‰ˆ)</button>
        </div>

        <!-- è°ƒè¯•æ—¥å¿— -->
        <div class="debug-section">
            <h3>è°ƒè¯•æ—¥å¿—</h3>
            <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
            <div id="debugLog" class="log"></div>
        </div>
    </div>

    <script>
        // åˆçº¦é…ç½®
        const CONTRACT_ADDRESS = '0xe342E701f808D942FF70a5a48E596fF9056406F7';
        const SEPOLIA_CHAIN_ID = '0xaa36a7';
        const CONTRACT_ABI = [
            "function generateNumber() external payable",
            "function getUserNumbers(address user) external view returns (uint256[])",
            "function getNumberOwner(uint256 number) external view returns (address)",
            "function isNumberTaken(uint256 number) external view returns (bool)",
            "function getUserNumberCount(address user) external view returns (uint256)",
            "function getSystemInfo() external view returns (uint256 price, uint256 totalGenerated, uint256 remaining, uint256 contractBalance)",
            "function GENERATION_PRICE() external view returns (uint256)",
            "function owner() external view returns (address)",
            "event NumberGenerated(address indexed user, uint256 indexed number, uint256 price)"
        ];

        let provider, signer, contract, userAccount;

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('debugLog');
            const logClass = type === 'error' ? 'error-log' : type === 'success' ? 'success-log' : 'info';
            logElement.innerHTML += `<div class="${logClass}">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLog() {
            document.getElementById('debugLog').innerHTML = '';
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus() {
            document.getElementById('walletStatus').textContent = provider ? 'å·²è¿æ¥' : 'æœªè¿æ¥';
            document.getElementById('accountInfo').textContent = userAccount || 'æœªè¿æ¥';
        }

        // è¿æ¥é’±åŒ…
        async function connectWallet() {
            try {
                log('å¼€å§‹è¿æ¥é’±åŒ…...');
                
                if (!window.ethereum) {
                    throw new Error('æœªæ£€æµ‹åˆ°é’±åŒ…æ‰©å±•');
                }

                log('æ£€æµ‹åˆ°é’±åŒ…æ‰©å±•');
                
                // æ£€æŸ¥ç½‘ç»œ
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                log(`å½“å‰ç½‘ç»œ Chain ID: ${chainId}`);
                
                if (chainId !== SEPOLIA_CHAIN_ID) {
                    log('ç½‘ç»œä¸æ­£ç¡®ï¼Œå°è¯•åˆ‡æ¢åˆ°Sepolia...', 'warning');
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: SEPOLIA_CHAIN_ID }],
                        });
                        log('ç½‘ç»œåˆ‡æ¢æˆåŠŸ', 'success');
                    } catch (switchError) {
                        log(`ç½‘ç»œåˆ‡æ¢å¤±è´¥: ${switchError.message}`, 'error');
                        throw switchError;
                    }
                }

                // è¯·æ±‚è´¦æˆ·
                log('è¯·æ±‚è´¦æˆ·è®¿é—®æƒé™...');
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                log(`è·å–åˆ°è´¦æˆ·: ${accounts[0]}`);

                // åˆ›å»ºproviderå’Œsigner
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                userAccount = await signer.getAddress();
                
                log(`Signeråœ°å€: ${userAccount}`, 'success');

                // è·å–ä½™é¢
                const balance = await provider.getBalance(userAccount);
                document.getElementById('balanceInfo').textContent = ethers.formatEther(balance);
                log(`è´¦æˆ·ä½™é¢: ${ethers.formatEther(balance)} ETH`);

                // è·å–ç½‘ç»œä¿¡æ¯
                const network = await provider.getNetwork();
                document.getElementById('networkInfo').textContent = `${network.name} (${network.chainId})`;
                log(`ç½‘ç»œä¿¡æ¯: ${network.name} (Chain ID: ${network.chainId})`);

                updateStatus();
                document.getElementById('generateBtn').disabled = false;
                log('é’±åŒ…è¿æ¥æˆåŠŸï¼', 'success');

            } catch (error) {
                log(`è¿æ¥é’±åŒ…å¤±è´¥: ${error.message}`, 'error');
                console.error('è¿æ¥é’±åŒ…å¤±è´¥:', error);
            }
        }

        // æ£€æŸ¥åˆçº¦
        async function checkContract() {
            try {
                log('æ£€æŸ¥åˆçº¦è¿æ¥...');
                
                if (!provider) {
                    throw new Error('è¯·å…ˆè¿æ¥é’±åŒ…');
                }

                // åˆ›å»ºåˆçº¦å®ä¾‹
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                log('åˆçº¦å®ä¾‹åˆ›å»ºæˆåŠŸ');

                // æ£€æŸ¥åˆçº¦ä»£ç 
                const code = await provider.getCode(CONTRACT_ADDRESS);
                if (code === '0x') {
                    throw new Error('åˆçº¦åœ°å€æ— æ•ˆæˆ–åˆçº¦ä¸å­˜åœ¨');
                }
                log(`åˆçº¦ä»£ç é•¿åº¦: ${code.length} å­—ç¬¦`, 'success');

                // æµ‹è¯•åªè¯»å‡½æ•°
                try {
                    const owner = await contract.owner();
                    log(`åˆçº¦æ‰€æœ‰è€…: ${owner}`, 'success');
                } catch (e) {
                    log(`è·å–åˆçº¦æ‰€æœ‰è€…å¤±è´¥: ${e.message}`, 'error');
                }

                log('åˆçº¦æ£€æŸ¥å®Œæˆ', 'success');

            } catch (error) {
                log(`åˆçº¦æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
                console.error('åˆçº¦æ£€æŸ¥å¤±è´¥:', error);
            }
        }

        // è·å–ä»·æ ¼
        async function getPrice() {
            try {
                log('è·å–ç”Ÿæˆä»·æ ¼...');
                
                if (!contract) {
                    await checkContract();
                }

                const generationPrice = await contract.GENERATION_PRICE();
                log(`ç”Ÿæˆä»·æ ¼: ${ethers.formatEther(generationPrice)} ETH`, 'success');
                
                return generationPrice;

            } catch (error) {
                log(`è·å–ä»·æ ¼å¤±è´¥: ${error.message}`, 'error');
                console.error('è·å–ä»·æ ¼å¤±è´¥:', error);
                throw error;
            }
        }

        // è°ƒè¯•ç‰ˆæœ¬çš„ç”Ÿæˆæ•°å­—
        async function generateNumberDebug() {
            try {
                log('=== å¼€å§‹ç”Ÿæˆæ•°å­— (è°ƒè¯•ç‰ˆ) ===');
                
                const button = document.getElementById('generateBtn');
                button.disabled = true;
                button.textContent = 'ç”Ÿæˆä¸­...';

                // æ­¥éª¤1: æ£€æŸ¥é’±åŒ…è¿æ¥
                if (!provider || !signer || !userAccount) {
                    throw new Error('é’±åŒ…æœªæ­£ç¡®è¿æ¥');
                }
                log('âœ… é’±åŒ…è¿æ¥æ£€æŸ¥é€šè¿‡');

                // æ­¥éª¤2: æ£€æŸ¥åˆçº¦
                if (!contract) {
                    log('åˆ›å»ºåˆçº¦å®ä¾‹...');
                    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                }
                log('âœ… åˆçº¦å®ä¾‹å·²å‡†å¤‡');

                // æ­¥éª¤3: è·å–ä»·æ ¼
                log('è·å–ç”Ÿæˆä»·æ ¼...');
                const generationPrice = await contract.GENERATION_PRICE();
                log(`âœ… ç”Ÿæˆä»·æ ¼: ${ethers.formatEther(generationPrice)} ETH`);

                // æ­¥éª¤4: æ£€æŸ¥ä½™é¢
                const balance = await provider.getBalance(userAccount);
                log(`å½“å‰ä½™é¢: ${ethers.formatEther(balance)} ETH`);
                
                if (balance < generationPrice) {
                    throw new Error(`ä½™é¢ä¸è¶³ã€‚éœ€è¦: ${ethers.formatEther(generationPrice)} ETH, å½“å‰: ${ethers.formatEther(balance)} ETH`);
                }
                log('âœ… ä½™é¢æ£€æŸ¥é€šè¿‡');

                // æ­¥éª¤5: ä¼°ç®—Gas
                log('ä¼°ç®—Gasè´¹ç”¨...');
                try {
                    const gasEstimate = await contract.generateNumber.estimateGas({ value: generationPrice });
                    log(`âœ… ä¼°ç®—Gas: ${gasEstimate.toString()}`);
                } catch (gasError) {
                    log(`âš ï¸  Gasä¼°ç®—å¤±è´¥: ${gasError.message}`, 'warning');
                    // ç»§ç»­æ‰§è¡Œï¼Œå¯èƒ½æ˜¯åˆçº¦çŠ¶æ€é—®é¢˜
                }

                // æ­¥éª¤6: å‘é€äº¤æ˜“
                log('ğŸš€ å‘é€äº¤æ˜“...');
                
                const txParams = {
                    value: generationPrice,
                    gasLimit: 300000n // è®¾ç½®å›ºå®šçš„gasé™åˆ¶
                };
                
                log(`äº¤æ˜“å‚æ•°: value=${ethers.formatEther(generationPrice)} ETH, gasLimit=${txParams.gasLimit}`);
                
                const tx = await contract.generateNumber(txParams);
                log(`âœ… äº¤æ˜“å·²å‘é€! å“ˆå¸Œ: ${tx.hash}`, 'success');
                log(`ğŸ”— Etherscan: https://sepolia.etherscan.io/tx/${tx.hash}`);

                // æ­¥éª¤7: ç­‰å¾…ç¡®è®¤
                log('â³ ç­‰å¾…äº¤æ˜“ç¡®è®¤...');
                const receipt = await tx.wait();
                log(`âœ… äº¤æ˜“å·²ç¡®è®¤! Gas used: ${receipt.gasUsed}`, 'success');

                // æ­¥éª¤8: è§£æäº‹ä»¶
                const event = receipt.logs.find(log => {
                    try {
                        const parsed = contract.interface.parseLog(log);
                        return parsed.name === 'NumberGenerated';
                    } catch (e) {
                        return false;
                    }
                });

                if (event) {
                    const parsedEvent = contract.interface.parseLog(event);
                    const generatedNumber = parsedEvent.args.number.toString();
                    log(`ğŸ‰ æˆåŠŸç”Ÿæˆæ•°å­—: ${generatedNumber.padStart(3, '0')}`, 'success');
                } else {
                    log('âš ï¸  æœªæ‰¾åˆ°NumberGeneratedäº‹ä»¶', 'warning');
                }

                log('=== ç”Ÿæˆæ•°å­—å®Œæˆ ===', 'success');

            } catch (error) {
                log(`âŒ ç”Ÿæˆæ•°å­—å¤±è´¥: ${error.message}`, 'error');
                
                // è¯¦ç»†é”™è¯¯ä¿¡æ¯
                if (error.code) {
                    log(`é”™è¯¯ä»£ç : ${error.code}`, 'error');
                }
                if (error.reason) {
                    log(`é”™è¯¯åŸå› : ${error.reason}`, 'error');
                }
                if (error.transaction) {
                    log(`äº¤æ˜“æ•°æ®: ${JSON.stringify(error.transaction)}`, 'error');
                }
                
                console.error('è¯¦ç»†é”™è¯¯:', error);
                
            } finally {
                const button = document.getElementById('generateBtn');
                button.disabled = false;
                button.textContent = 'ç”Ÿæˆæ•°å­— (è°ƒè¯•ç‰ˆ)';
            }
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.addEventListener('load', () => {
            log('é¡µé¢åŠ è½½å®Œæˆ');
            log('è¯·ç‚¹å‡»"è¿æ¥é’±åŒ…"å¼€å§‹è°ƒè¯•');
        });
    </script>
</body>
</html>