<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🐍 LuckSnake - 交易调试版</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.1/dist/ethers.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .debug-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid #007bff;
        }
        .error {
            background: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }
        .success {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }
        .warning {
            background: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .log {
            background: #f8f9fa;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 3px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .info { color: #0066cc; }
        .error-log { color: #dc3545; }
        .success-log { color: #28a745; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🐍 LuckSnake 交易调试</h1>
        <p>这个页面用于调试交易问题，包含详细的日志输出。</p>

        <!-- 连接状态 -->
        <div class="debug-section">
            <h3>连接状态</h3>
            <p><strong>钱包状态:</strong> <span id="walletStatus">未连接</span></p>
            <p><strong>合约地址:</strong> 0xe342E701f808D942FF70a5a48E596fF9056406F7</p>
            <p><strong>网络:</strong> <span id="networkInfo">未知</span></p>
            <p><strong>账户:</strong> <span id="accountInfo">未连接</span></p>
            <p><strong>余额:</strong> <span id="balanceInfo">-</span> ETH</p>
        </div>

        <!-- 控制按钮 -->
        <div class="debug-section">
            <h3>操作控制</h3>
            <button id="connectBtn" onclick="connectWallet()">连接钱包</button>
            <button id="checkContractBtn" onclick="checkContract()">检查合约</button>
            <button id="getPriceBtn" onclick="getPrice()">获取价格</button>
            <button id="generateBtn" onclick="generateNumberDebug()" disabled>生成数字 (调试版)</button>
        </div>

        <!-- 调试日志 -->
        <div class="debug-section">
            <h3>调试日志</h3>
            <button onclick="clearLog()">清除日志</button>
            <div id="debugLog" class="log"></div>
        </div>
    </div>

    <script>
        // 合约配置
        const CONTRACT_ADDRESS = '0xe342E701f808D942FF70a5a48E596fF9056406F7';
        const SEPOLIA_CHAIN_ID = '0xaa36a7';
        const CONTRACT_ABI = [
            "function generateNumber() external payable",
            "function getUserNumbers(address user) external view returns (uint256[])",
            "function getNumberOwner(uint256 number) external view returns (address)",
            "function isNumberTaken(uint256 number) external view returns (bool)",
            "function getUserNumberCount(address user) external view returns (uint256)",
            "function getSystemInfo() external view returns (uint256 price, uint256 totalGenerated, uint256 remaining, uint256 contractBalance)",
            "function GENERATION_PRICE() external view returns (uint256)",
            "function owner() external view returns (address)",
            "event NumberGenerated(address indexed user, uint256 indexed number, uint256 price)"
        ];

        let provider, signer, contract, userAccount;

        // 日志函数
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('debugLog');
            const logClass = type === 'error' ? 'error-log' : type === 'success' ? 'success-log' : 'info';
            logElement.innerHTML += `<div class="${logClass}">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLog() {
            document.getElementById('debugLog').innerHTML = '';
        }

        // 更新状态显示
        function updateStatus() {
            document.getElementById('walletStatus').textContent = provider ? '已连接' : '未连接';
            document.getElementById('accountInfo').textContent = userAccount || '未连接';
        }

        // 连接钱包
        async function connectWallet() {
            try {
                log('开始连接钱包...');
                
                if (!window.ethereum) {
                    throw new Error('未检测到钱包扩展');
                }

                log('检测到钱包扩展');
                
                // 检查网络
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                log(`当前网络 Chain ID: ${chainId}`);
                
                if (chainId !== SEPOLIA_CHAIN_ID) {
                    log('网络不正确，尝试切换到Sepolia...', 'warning');
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: SEPOLIA_CHAIN_ID }],
                        });
                        log('网络切换成功', 'success');
                    } catch (switchError) {
                        log(`网络切换失败: ${switchError.message}`, 'error');
                        throw switchError;
                    }
                }

                // 请求账户
                log('请求账户访问权限...');
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                log(`获取到账户: ${accounts[0]}`);

                // 创建provider和signer
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                userAccount = await signer.getAddress();
                
                log(`Signer地址: ${userAccount}`, 'success');

                // 获取余额
                const balance = await provider.getBalance(userAccount);
                document.getElementById('balanceInfo').textContent = ethers.formatEther(balance);
                log(`账户余额: ${ethers.formatEther(balance)} ETH`);

                // 获取网络信息
                const network = await provider.getNetwork();
                document.getElementById('networkInfo').textContent = `${network.name} (${network.chainId})`;
                log(`网络信息: ${network.name} (Chain ID: ${network.chainId})`);

                updateStatus();
                document.getElementById('generateBtn').disabled = false;
                log('钱包连接成功！', 'success');

            } catch (error) {
                log(`连接钱包失败: ${error.message}`, 'error');
                console.error('连接钱包失败:', error);
            }
        }

        // 检查合约
        async function checkContract() {
            try {
                log('检查合约连接...');
                
                if (!provider) {
                    throw new Error('请先连接钱包');
                }

                // 创建合约实例
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                log('合约实例创建成功');

                // 检查合约代码
                const code = await provider.getCode(CONTRACT_ADDRESS);
                if (code === '0x') {
                    throw new Error('合约地址无效或合约不存在');
                }
                log(`合约代码长度: ${code.length} 字符`, 'success');

                // 测试只读函数
                try {
                    const owner = await contract.owner();
                    log(`合约所有者: ${owner}`, 'success');
                } catch (e) {
                    log(`获取合约所有者失败: ${e.message}`, 'error');
                }

                log('合约检查完成', 'success');

            } catch (error) {
                log(`合约检查失败: ${error.message}`, 'error');
                console.error('合约检查失败:', error);
            }
        }

        // 获取价格
        async function getPrice() {
            try {
                log('获取生成价格...');
                
                if (!contract) {
                    await checkContract();
                }

                const generationPrice = await contract.GENERATION_PRICE();
                log(`生成价格: ${ethers.formatEther(generationPrice)} ETH`, 'success');
                
                return generationPrice;

            } catch (error) {
                log(`获取价格失败: ${error.message}`, 'error');
                console.error('获取价格失败:', error);
                throw error;
            }
        }

        // 调试版本的生成数字
        async function generateNumberDebug() {
            try {
                log('=== 开始生成数字 (调试版) ===');
                
                const button = document.getElementById('generateBtn');
                button.disabled = true;
                button.textContent = '生成中...';

                // 步骤1: 检查钱包连接
                if (!provider || !signer || !userAccount) {
                    throw new Error('钱包未正确连接');
                }
                log('✅ 钱包连接检查通过');

                // 步骤2: 检查合约
                if (!contract) {
                    log('创建合约实例...');
                    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                }
                log('✅ 合约实例已准备');

                // 步骤3: 获取价格
                log('获取生成价格...');
                const generationPrice = await contract.GENERATION_PRICE();
                log(`✅ 生成价格: ${ethers.formatEther(generationPrice)} ETH`);

                // 步骤4: 检查余额
                const balance = await provider.getBalance(userAccount);
                log(`当前余额: ${ethers.formatEther(balance)} ETH`);
                
                if (balance < generationPrice) {
                    throw new Error(`余额不足。需要: ${ethers.formatEther(generationPrice)} ETH, 当前: ${ethers.formatEther(balance)} ETH`);
                }
                log('✅ 余额检查通过');

                // 步骤5: 估算Gas
                log('估算Gas费用...');
                try {
                    const gasEstimate = await contract.generateNumber.estimateGas({ value: generationPrice });
                    log(`✅ 估算Gas: ${gasEstimate.toString()}`);
                } catch (gasError) {
                    log(`⚠️  Gas估算失败: ${gasError.message}`, 'warning');
                    // 继续执行，可能是合约状态问题
                }

                // 步骤6: 发送交易
                log('🚀 发送交易...');
                
                const txParams = {
                    value: generationPrice,
                    gasLimit: 300000n // 设置固定的gas限制
                };
                
                log(`交易参数: value=${ethers.formatEther(generationPrice)} ETH, gasLimit=${txParams.gasLimit}`);
                
                const tx = await contract.generateNumber(txParams);
                log(`✅ 交易已发送! 哈希: ${tx.hash}`, 'success');
                log(`🔗 Etherscan: https://sepolia.etherscan.io/tx/${tx.hash}`);

                // 步骤7: 等待确认
                log('⏳ 等待交易确认...');
                const receipt = await tx.wait();
                log(`✅ 交易已确认! Gas used: ${receipt.gasUsed}`, 'success');

                // 步骤8: 解析事件
                const event = receipt.logs.find(log => {
                    try {
                        const parsed = contract.interface.parseLog(log);
                        return parsed.name === 'NumberGenerated';
                    } catch (e) {
                        return false;
                    }
                });

                if (event) {
                    const parsedEvent = contract.interface.parseLog(event);
                    const generatedNumber = parsedEvent.args.number.toString();
                    log(`🎉 成功生成数字: ${generatedNumber.padStart(3, '0')}`, 'success');
                } else {
                    log('⚠️  未找到NumberGenerated事件', 'warning');
                }

                log('=== 生成数字完成 ===', 'success');

            } catch (error) {
                log(`❌ 生成数字失败: ${error.message}`, 'error');
                
                // 详细错误信息
                if (error.code) {
                    log(`错误代码: ${error.code}`, 'error');
                }
                if (error.reason) {
                    log(`错误原因: ${error.reason}`, 'error');
                }
                if (error.transaction) {
                    log(`交易数据: ${JSON.stringify(error.transaction)}`, 'error');
                }
                
                console.error('详细错误:', error);
                
            } finally {
                const button = document.getElementById('generateBtn');
                button.disabled = false;
                button.textContent = '生成数字 (调试版)';
            }
        }

        // 页面加载时的初始化
        window.addEventListener('load', () => {
            log('页面加载完成');
            log('请点击"连接钱包"开始调试');
        });
    </script>
</body>
</html>