<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ LuckSnake - å¹¸è¿æ•°å­—ç”Ÿæˆå™¨ (å¤šé’±åŒ…æ”¯æŒ)</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.1/dist/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 3rem;
            color: #333;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header p {
            font-size: 1.2rem;
            color: #666;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .wallet-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }

        .wallet-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .wallet-option {
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .wallet-option:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .wallet-option.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .wallet-option.unavailable {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f5f5f5;
        }

        .wallet-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .wallet-info {
            display: none;
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            text-align: left;
        }

        .wallet-info.show {
            display: block;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .stat-card h3 {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .stat-card p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-panel {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .control-panel h3 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn.wallet-btn {
            margin: 5px;
            padding: 10px 20px;
            width: auto;
            display: inline-block;
        }

        .numbers-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .numbers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }

        .number-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 10px;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1rem;
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        }

        .query-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .query-result {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            min-height: 50px;
            color: #333;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .alert.success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .alert.error {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        .alert.info {
            background: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }

        .transaction-hash {
            font-family: monospace;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            word-break: break-all;
            margin-top: 10px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .wallet-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 10px;
        }

        .wallet-status.available {
            background: #d4edda;
            color: #155724;
        }

        .wallet-status.unavailable {
            background: #f8d7da;
            color: #721c24;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .controls {
                grid-template-columns: 1fr;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .wallet-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ LuckSnake</h1>
            <p>æ”¯ä»˜ 0.0001 ETH è·å–ä½ çš„å¹¸è¿æ•°å­— (000-999) - æ”¯æŒå¤šç§é’±åŒ…</p>
        </div>

        <!-- é’±åŒ…è¿æ¥åŒºåŸŸ -->
        <div class="wallet-section">
            <h3>é€‰æ‹©é’±åŒ…</h3>
            <div class="wallet-options" id="walletOptions">
                <!-- é’±åŒ…é€‰é¡¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <div id="walletActions" style="display: none;">
                <button id="connectWallet" class="btn wallet-btn">è¿æ¥é€‰ä¸­çš„é’±åŒ…</button>
                <button id="disconnectWallet" class="btn wallet-btn" style="display: none;">æ–­å¼€è¿æ¥</button>
            </div>

            <div id="walletInfo" class="wallet-info">
                <p><strong>å·²è¿æ¥é’±åŒ…:</strong> <span id="walletType"></span> <span id="walletAddress"></span></p>
                <p><strong>ä½™é¢:</strong> <span id="walletBalance"></span> ETH</p>
                <p><strong>ç½‘ç»œ:</strong> <span id="networkName"></span></p>
            </div>
        </div>

        <!-- ç³»ç»ŸçŠ¶æ€ -->
        <div class="stats">
            <div class="stat-card">
                <h3 id="totalGenerated">-</h3>
                <p>å·²ç”Ÿæˆæ•°å­—</p>
            </div>
            <div class="stat-card">
                <h3 id="remainingNumbers">-</h3>
                <p>å‰©ä½™æ•°å­—</p>
            </div>
            <div class="stat-card">
                <h3 id="contractBalance">-</h3>
                <p>åˆçº¦ä½™é¢ (ETH)</p>
            </div>
            <div class="stat-card">
                <h3>0.0001</h3>
                <p>ç”Ÿæˆä»·æ ¼ (ETH)</p>
            </div>
        </div>

        <!-- åŠŸèƒ½æ§åˆ¶åŒºåŸŸ -->
        <div class="controls">
            <!-- ç”Ÿæˆæ•°å­— -->
            <div class="control-panel">
                <h3>ğŸ² ç”Ÿæˆå¹¸è¿æ•°å­—</h3>
                <button id="generateNumber" class="btn" disabled>ç”Ÿæˆæ•°å­— (0.0001 ETH)</button>
            </div>

            <!-- æŸ¥è¯¢åŠŸèƒ½ -->
            <div class="control-panel">
                <h3>ğŸ” æŸ¥è¯¢åŠŸèƒ½</h3>
                <div class="form-group">
                    <label for="queryAddress">æŸ¥è¯¢åœ°å€æ‹¥æœ‰çš„æ•°å­—:</label>
                    <input type="text" id="queryAddress" placeholder="è¾“å…¥é’±åŒ…åœ°å€">
                    <button id="queryUserNumbers" class="btn">æŸ¥è¯¢ç”¨æˆ·æ•°å­—</button>
                </div>
                <div class="form-group">
                    <label for="queryNumber">æŸ¥è¯¢æ•°å­—çš„æ‰€æœ‰è€…:</label>
                    <input type="number" id="queryNumber" placeholder="è¾“å…¥æ•°å­— (0-999)" min="0" max="999">
                    <button id="queryNumberOwner" class="btn">æŸ¥è¯¢æ•°å­—æ‰€æœ‰è€…</button>
                </div>
            </div>
        </div>

        <!-- æ¶ˆæ¯æ˜¾ç¤ºåŒºåŸŸ -->
        <div id="messageArea"></div>

        <!-- æˆ‘çš„æ•°å­— -->
        <div class="numbers-section">
            <h3>ğŸ¯ æˆ‘çš„å¹¸è¿æ•°å­—</h3>
            <p>æ•°é‡: <span id="myNumberCount">0</span></p>
            <div id="myNumbers" class="numbers-grid">
                <!-- ç”¨æˆ·çš„æ•°å­—å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>

        <!-- æŸ¥è¯¢ç»“æœ -->
        <div class="query-section">
            <h3>ğŸ“Š æŸ¥è¯¢ç»“æœ</h3>
            <div id="queryResult" class="query-result">
                ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æŸ¥è¯¢...
            </div>
        </div>
    </div>

    <script>
        // åˆçº¦é…ç½®
        const CONTRACT_ADDRESS = '0x68B1D87F95878fE05B998F19b66F4baba5De1aed';
        const CONTRACT_ABI = [
            "function generateNumber() external payable",
            "function getUserNumbers(address user) external view returns (uint256[])",
            "function getNumberOwner(uint256 number) external view returns (address)",
            "function isNumberTaken(uint256 number) external view returns (bool)",
            "function getUserNumberCount(address user) external view returns (uint256)",
            "function getSystemInfo() external view returns (uint256 price, uint256 totalGenerated, uint256 remaining, uint256 contractBalance)",
            "function GENERATION_PRICE() external view returns (uint256)",
            "function owner() external view returns (address)",
            "event NumberGenerated(address indexed user, uint256 indexed number, uint256 price)"
        ];

        let provider, signer, contract, userAccount, selectedWallet, currentWalletType;

        // é’±åŒ…é…ç½®
        const walletConfigs = {
            metamask: {
                name: 'MetaMask',
                icon: 'ğŸ¦Š',
                description: 'MetaMask æµè§ˆå™¨é’±åŒ…',
                checkFunction: () => window.ethereum && window.ethereum.isMetaMask,
                getProvider: () => window.ethereum
            },
            luckyou: {
                name: 'LuckYou Wallet',
                icon: 'ğŸ€',
                description: 'LuckYou è‡ªå®šä¹‰é’±åŒ…',
                checkFunction: () => {
                    return window.luckyouWallet || 
                           (window.ethereum && window.ethereum.isLuckYouWallet);
                },
                getProvider: () => {
                    return window.luckyouWallet || 
                           (window.ethereum && window.ethereum.isLuckYouWallet ? window.ethereum : null);
                }
            }
        };

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', async () => {
            await initializeApp();
        });

        // åˆå§‹åŒ–åº”ç”¨
        async function initializeApp() {
            console.log('Initializing multi-wallet app...');
            
            // ç­‰å¾…ä¸€æ®µæ—¶é—´ç¡®ä¿æ‰€æœ‰é’±åŒ…æ‰©å±•éƒ½å·²åŠ è½½
            setTimeout(async () => {
                await detectAndDisplayWallets();
                await checkExistingConnection();
            }, 500);
        }

        // æ£€æµ‹å¹¶æ˜¾ç¤ºå¯ç”¨é’±åŒ…
        async function detectAndDisplayWallets() {
            const walletOptionsContainer = document.getElementById('walletOptions');
            walletOptionsContainer.innerHTML = '';

            let hasAvailableWallet = false;

            for (const [key, config] of Object.entries(walletConfigs)) {
                const isAvailable = config.checkFunction();
                console.log(`${config.name} available:`, isAvailable);

                const walletOption = document.createElement('div');
                walletOption.className = `wallet-option ${isAvailable ? '' : 'unavailable'}`;
                walletOption.setAttribute('data-wallet', key);

                walletOption.innerHTML = `
                    <div class="wallet-icon">${config.icon}</div>
                    <h4>${config.name}</h4>
                    <p>${config.description}</p>
                    <span class="wallet-status ${isAvailable ? 'available' : 'unavailable'}">
                        ${isAvailable ? 'å¯ç”¨' : 'æœªå®‰è£…'}
                    </span>
                `;

                if (isAvailable) {
                    hasAvailableWallet = true;
                    walletOption.addEventListener('click', () => selectWallet(key));
                }

                walletOptionsContainer.appendChild(walletOption);
            }

            if (hasAvailableWallet) {
                document.getElementById('walletActions').style.display = 'block';
            } else {
                showMessage('æœªæ£€æµ‹åˆ°æ”¯æŒçš„é’±åŒ…ã€‚è¯·å®‰è£… MetaMask æˆ– LuckYou Walletã€‚', 'error');
            }
        }

        // é€‰æ‹©é’±åŒ…
        function selectWallet(walletKey) {
            // ç§»é™¤ä¹‹å‰çš„é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.wallet-option').forEach(option => {
                option.classList.remove('selected');
            });

            // è®¾ç½®æ–°çš„é€‰ä¸­çŠ¶æ€
            const selectedOption = document.querySelector(`[data-wallet="${walletKey}"]`);
            if (selectedOption && !selectedOption.classList.contains('unavailable')) {
                selectedOption.classList.add('selected');
                selectedWallet = walletKey;
                
                // å¯ç”¨è¿æ¥æŒ‰é’®
                document.getElementById('connectWallet').disabled = false;
                
                showMessage(`å·²é€‰æ‹© ${walletConfigs[walletKey].name}`, 'info');
            }
        }

        // æ£€æŸ¥ç°æœ‰è¿æ¥
        async function checkExistingConnection() {
            // æ£€æŸ¥ MetaMask
            if (window.ethereum && window.ethereum.isMetaMask) {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        selectedWallet = 'metamask';
                        await connectWallet();
                        return;
                    }
                } catch (error) {
                    console.log('MetaMask check failed:', error);
                }
            }

            // æ£€æŸ¥ LuckYou Wallet
            const luckyouProvider = walletConfigs.luckyou.getProvider();
            if (luckyouProvider) {
                try {
                    const accounts = await luckyouProvider.request({ method: 'eth_accounts' });
                    if (accounts && accounts.length > 0) {
                        selectedWallet = 'luckyou';
                        await connectWallet();
                        return;
                    }
                } catch (error) {
                    console.log('LuckYou Wallet check failed:', error);
                }
            }
        }

        // è¿æ¥é’±åŒ…
        async function connectWallet() {
            try {
                if (!selectedWallet) {
                    showMessage('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé’±åŒ…', 'error');
                    return;
                }

                const walletConfig = walletConfigs[selectedWallet];
                const walletProvider = walletConfig.getProvider();

                if (!walletProvider) {
                    throw new Error(`${walletConfig.name} ä¸å¯ç”¨`);
                }

                console.log(`Connecting to ${walletConfig.name}...`);

                // è¯·æ±‚è´¦æˆ·è¿æ¥
                await walletProvider.request({ method: 'eth_requestAccounts' });

                // åˆ›å»º ethers provider
                provider = new ethers.BrowserProvider(walletProvider);
                signer = await provider.getSigner();
                userAccount = await signer.getAddress();
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                currentWalletType = selectedWallet;

                // æ›´æ–°UI
                document.getElementById('walletType').textContent = walletConfig.name;
                document.getElementById('walletAddress').textContent = userAccount.substring(0, 6) + '...' + userAccount.substring(38);
                document.getElementById('walletInfo').classList.add('show');
                document.getElementById('connectWallet').style.display = 'none';
                document.getElementById('disconnectWallet').style.display = 'inline-block';

                // å¯ç”¨åŠŸèƒ½æŒ‰é’®
                document.getElementById('generateNumber').disabled = false;

                // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
                setupWalletEventListeners(walletProvider);

                // æ›´æ–°ä¿¡æ¯
                await updateWalletInfo();
                await updateContractInfo();
                await updateUserNumbers();

                showMessage(`${walletConfig.name} è¿æ¥æˆåŠŸï¼`, 'success');

            } catch (error) {
                console.error('è¿æ¥é’±åŒ…å¤±è´¥:', error);
                showMessage('è¿æ¥é’±åŒ…å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ–­å¼€é’±åŒ…è¿æ¥
        function disconnectWallet() {
            provider = null;
            signer = null;
            contract = null;
            userAccount = null;
            selectedWallet = null;
            currentWalletType = null;

            // é‡ç½®UI
            document.getElementById('walletInfo').classList.remove('show');
            document.getElementById('connectWallet').style.display = 'inline-block';
            document.getElementById('disconnectWallet').style.display = 'none';
            document.getElementById('generateNumber').disabled = true;

            // æ¸…é™¤é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.wallet-option').forEach(option => {
                option.classList.remove('selected');
            });

            // é‡ç½®æ•°æ®æ˜¾ç¤º
            document.getElementById('myNumberCount').textContent = '0';
            document.getElementById('myNumbers').innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #666;">è¯·å…ˆè¿æ¥é’±åŒ…</p>';

            showMessage('é’±åŒ…å·²æ–­å¼€è¿æ¥', 'info');
        }

        // è®¾ç½®é’±åŒ…äº‹ä»¶ç›‘å¬å™¨
        function setupWalletEventListeners(walletProvider) {
            if (walletProvider.on) {
                // è´¦æˆ·å˜åŒ–ç›‘å¬
                walletProvider.on('accountsChanged', async (accounts) => {
                    if (accounts.length === 0) {
                        disconnectWallet();
                    } else {
                        userAccount = accounts[0];
                        await updateWalletInfo();
                        await updateUserNumbers();
                        showMessage('è´¦æˆ·å·²åˆ‡æ¢', 'info');
                    }
                });

                // ç½‘ç»œå˜åŒ–ç›‘å¬
                walletProvider.on('chainChanged', async (chainId) => {
                    await updateWalletInfo();
                    await updateContractInfo();
                    showMessage('ç½‘ç»œå·²åˆ‡æ¢', 'info');
                });

                // è¿æ¥çŠ¶æ€ç›‘å¬
                walletProvider.on('connect', (connectInfo) => {
                    console.log('Wallet connected:', connectInfo);
                });

                walletProvider.on('disconnect', (error) => {
                    console.log('Wallet disconnected:', error);
                    disconnectWallet();
                });
            }
        }

        // æ›´æ–°é’±åŒ…ä¿¡æ¯
        async function updateWalletInfo() {
            try {
                const balance = await provider.getBalance(userAccount);
                document.getElementById('walletBalance').textContent = ethers.formatEther(balance);

                const network = await provider.getNetwork();
                document.getElementById('networkName').textContent = network.name || 'Unknown';
            } catch (error) {
                console.error('æ›´æ–°é’±åŒ…ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        // æ›´æ–°åˆçº¦ä¿¡æ¯
        async function updateContractInfo() {
            try {
                const systemInfo = await contract.getSystemInfo();
                document.getElementById('totalGenerated').textContent = systemInfo.totalGenerated.toString();
                document.getElementById('remainingNumbers').textContent = systemInfo.remaining.toString();
                document.getElementById('contractBalance').textContent = ethers.formatEther(systemInfo.contractBalance);
            } catch (error) {
                console.error('æ›´æ–°åˆçº¦ä¿¡æ¯å¤±è´¥:', error);
                // æ˜¾ç¤ºé»˜è®¤å€¼
                document.getElementById('totalGenerated').textContent = '-';
                document.getElementById('remainingNumbers').textContent = '-';
                document.getElementById('contractBalance').textContent = '-';
            }
        }

        // æ›´æ–°ç”¨æˆ·æ•°å­—
        async function updateUserNumbers() {
            try {
                const numbers = await contract.getUserNumbers(userAccount);
                const count = numbers.length;
                
                document.getElementById('myNumberCount').textContent = count;
                
                const numbersGrid = document.getElementById('myNumbers');
                numbersGrid.innerHTML = '';
                
                if (count === 0) {
                    numbersGrid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #666;">æš‚æ— æ•°å­—</p>';
                } else {
                    numbers.forEach(number => {
                        const badge = document.createElement('div');
                        badge.className = 'number-badge';
                        badge.textContent = number.toString().padStart(3, '0');
                        numbersGrid.appendChild(badge);
                    });
                }
            } catch (error) {
                console.error('æ›´æ–°ç”¨æˆ·æ•°å­—å¤±è´¥:', error);
            }
        }

        // ç”Ÿæˆæ•°å­—
        async function generateNumber() {
            try {
                const button = document.getElementById('generateNumber');
                button.innerHTML = '<span class="loading"></span>ç”Ÿæˆä¸­...';
                button.disabled = true;

                const generationPrice = await contract.GENERATION_PRICE();
                const tx = await contract.generateNumber({ value: generationPrice });
                
                showMessage('äº¤æ˜“å·²æäº¤ï¼Œç­‰å¾…ç¡®è®¤...', 'info');
                showMessage('<div class="transaction-hash">äº¤æ˜“å“ˆå¸Œ: ' + tx.hash + '</div>', 'info');

                const receipt = await tx.wait();
                
                // æŸ¥æ‰¾äº‹ä»¶
                const event = receipt.logs.find(log => {
                    try {
                        const parsed = contract.interface.parseLog(log);
                        return parsed.name === 'NumberGenerated';
                    } catch (e) {
                        return false;
                    }
                });

                if (event) {
                    const parsedEvent = contract.interface.parseLog(event);
                    const generatedNumber = parsedEvent.args.number.toString();
                    showMessage(`ğŸ‰ æ­å–œï¼ä½ è·å¾—äº†æ•°å­—: ${generatedNumber.padStart(3, '0')}`, 'success');
                } else {
                    showMessage('æ•°å­—ç”ŸæˆæˆåŠŸï¼', 'success');
                }

                // æ›´æ–°ä¿¡æ¯
                await updateContractInfo();
                await updateUserNumbers();
                await updateWalletInfo();

            } catch (error) {
                console.error('ç”Ÿæˆæ•°å­—å¤±è´¥:', error);
                showMessage('ç”Ÿæˆæ•°å­—å¤±è´¥: ' + error.message, 'error');
            } finally {
                const button = document.getElementById('generateNumber');
                button.innerHTML = 'ç”Ÿæˆæ•°å­— (0.0001 ETH)';
                button.disabled = false;
            }
        }

        // æŸ¥è¯¢ç”¨æˆ·æ•°å­—
        async function queryUserNumbers() {
            try {
                const address = document.getElementById('queryAddress').value.trim();
                if (!address) {
                    showMessage('è¯·è¾“å…¥è¦æŸ¥è¯¢çš„åœ°å€', 'error');
                    return;
                }

                if (!ethers.isAddress(address)) {
                    showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„ä»¥å¤ªåŠåœ°å€', 'error');
                    return;
                }

                const numbers = await contract.getUserNumbers(address);
                const count = numbers.length;

                let result = `<p><strong>åœ°å€:</strong> ${address}</p>`;
                result += `<p><strong>æ‹¥æœ‰æ•°å­—æ•°é‡:</strong> ${count}</p>`;
                
                if (count > 0) {
                    result += `<p><strong>æ‹¥æœ‰çš„æ•°å­—:</strong></p>`;
                    result += `<div class="numbers-grid">`;
                    numbers.forEach(number => {
                        result += `<div class="number-badge">${number.toString().padStart(3, '0')}</div>`;
                    });
                    result += `</div>`;
                } else {
                    result += `<p>è¯¥åœ°å€æš‚æ— æ•°å­—</p>`;
                }

                document.getElementById('queryResult').innerHTML = result;
            } catch (error) {
                console.error('æŸ¥è¯¢ç”¨æˆ·æ•°å­—å¤±è´¥:', error);
                document.getElementById('queryResult').innerHTML = `<p style="color: red;">æŸ¥è¯¢å¤±è´¥: ${error.message}</p>`;
            }
        }

        // æŸ¥è¯¢æ•°å­—æ‰€æœ‰è€…
        async function queryNumberOwner() {
            try {
                const number = parseInt(document.getElementById('queryNumber').value);
                if (isNaN(number) || number < 0 || number > 999) {
                    showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­— (0-999)', 'error');
                    return;
                }

                const owner = await contract.getNumberOwner(number);
                const isTaken = await contract.isNumberTaken(number);

                let result = `<p><strong>æŸ¥è¯¢æ•°å­—:</strong> ${number.toString().padStart(3, '0')}</p>`;
                result += `<p><strong>æ˜¯å¦å·²è¢«å ç”¨:</strong> ${isTaken ? 'æ˜¯' : 'å¦'}</p>`;
                
                if (isTaken && owner !== '0x0000000000000000000000000000000000000000') {
                    result += `<p><strong>æ‰€æœ‰è€…:</strong> ${owner}</p>`;
                } else {
                    result += `<p><strong>æ‰€æœ‰è€…:</strong> æš‚æ— </p>`;
                }

                document.getElementById('queryResult').innerHTML = result;
            } catch (error) {
                console.error('æŸ¥è¯¢æ•°å­—æ‰€æœ‰è€…å¤±è´¥:', error);
                document.getElementById('queryResult').innerHTML = `<p style="color: red;">æŸ¥è¯¢å¤±è´¥: ${error.message}</p>`;
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type) {
            const messageArea = document.getElementById('messageArea');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${type}`;
            alertDiv.innerHTML = message;
            
            messageArea.appendChild(alertDiv);
            
            // 5ç§’åè‡ªåŠ¨ç§»é™¤æ¶ˆæ¯
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }

        // äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('connectWallet').addEventListener('click', connectWallet);
        document.getElementById('disconnectWallet').addEventListener('click', disconnectWallet);
        document.getElementById('generateNumber').addEventListener('click', generateNumber);
        document.getElementById('queryUserNumbers').addEventListener('click', queryUserNumbers);
        document.getElementById('queryNumberOwner').addEventListener('click', queryNumberOwner);

        // EIP-6963 æ ‡å‡†é’±åŒ…å‘ç°
        function announceProvider() {
            const info = {
                uuid: 'lucky-snake-dapp',
                name: 'LuckSnake DApp',
                icon: 'data:image/svg+xml;base64,...', // å¯ä»¥æ·»åŠ å›¾æ ‡
                rdns: 'com.lucksnake.dapp'
            };

            window.dispatchEvent(
                new CustomEvent('eip6963:requestProvider', {
                    detail: {
                        info,
                        reply: (providerDetail) => {
                            console.log('EIP-6963 provider announced:', providerDetail);
                        }
                    }
                })
            );
        }

        // è§¦å‘ EIP-6963 é’±åŒ…å‘ç°
        setTimeout(announceProvider, 100);
    </script>
</body>
</html>