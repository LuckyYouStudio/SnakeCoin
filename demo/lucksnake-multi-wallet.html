<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üêç LuckSnake - Âπ∏ËøêÊï∞Â≠óÁîüÊàêÂô® (Â§öÈí±ÂåÖÊîØÊåÅ)</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.1/dist/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 3rem;
            color: #333;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header p {
            font-size: 1.2rem;
            color: #666;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .wallet-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }

        .wallet-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .wallet-option {
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .wallet-option:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .wallet-option.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .wallet-option.unavailable {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f5f5f5;
        }

        .wallet-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .wallet-info {
            display: none;
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            text-align: left;
        }

        .wallet-info.show {
            display: block;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .stat-card h3 {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .stat-card p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-panel {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .control-panel h3 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn.wallet-btn {
            margin: 5px;
            padding: 10px 20px;
            width: auto;
            display: inline-block;
        }

        .numbers-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .numbers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }

        .number-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 10px;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1rem;
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        }

        .query-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .query-result {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            min-height: 50px;
            color: #333;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .alert.success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .alert.error {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        .alert.info {
            background: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }

        .transaction-hash {
            font-family: monospace;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            word-break: break-all;
            margin-top: 10px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .wallet-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 10px;
        }

        .wallet-status.available {
            background: #d4edda;
            color: #155724;
        }

        .wallet-status.unavailable {
            background: #f8d7da;
            color: #721c24;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .controls {
                grid-template-columns: 1fr;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .wallet-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üêç LuckSnake</h1>
            <p>ÊîØ‰ªò 0.0001 ETH Ëé∑Âèñ‰Ω†ÁöÑÂπ∏ËøêÊï∞Â≠ó (000-999) - ÊîØÊåÅÂ§öÁßçÈí±ÂåÖ</p>
        </div>

        <!-- Èí±ÂåÖËøûÊé•Âå∫Âüü -->
        <div class="wallet-section">
            <h3>ÈÄâÊã©Èí±ÂåÖ</h3>
            <div class="wallet-options" id="walletOptions">
                <!-- Èí±ÂåÖÈÄâÈ°πÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
            </div>
            
            <div id="walletActions" style="display: none;">
                <button id="connectWallet" class="btn wallet-btn">ËøûÊé•ÈÄâ‰∏≠ÁöÑÈí±ÂåÖ</button>
                <button id="disconnectWallet" class="btn wallet-btn" style="display: none;">Êñ≠ÂºÄËøûÊé•</button>
            </div>

            <div id="walletInfo" class="wallet-info">
                <p><strong>Â∑≤ËøûÊé•Èí±ÂåÖ:</strong> <span id="walletType"></span> <span id="walletAddress"></span></p>
                <p><strong>‰ΩôÈ¢ù:</strong> <span id="walletBalance"></span> ETH</p>
                <p><strong>ÁΩëÁªú:</strong> <span id="networkName"></span></p>
            </div>
        </div>

        <!-- Á≥ªÁªüÁä∂ÊÄÅ -->
        <div class="stats">
            <div class="stat-card">
                <h3 id="totalGenerated">-</h3>
                <p>Â∑≤ÁîüÊàêÊï∞Â≠ó</p>
            </div>
            <div class="stat-card">
                <h3 id="remainingNumbers">-</h3>
                <p>Ââ©‰ΩôÊï∞Â≠ó</p>
            </div>
            <div class="stat-card">
                <h3 id="contractBalance">-</h3>
                <p>ÂêàÁ∫¶‰ΩôÈ¢ù (ETH)</p>
            </div>
            <div class="stat-card">
                <h3>0.0001</h3>
                <p>ÁîüÊàê‰ª∑Ê†º (ETH)</p>
            </div>
        </div>

        <!-- ÂäüËÉΩÊéßÂà∂Âå∫Âüü -->
        <div class="controls">
            <!-- ÁîüÊàêÊï∞Â≠ó -->
            <div class="control-panel">
                <h3>üé≤ ÁîüÊàêÂπ∏ËøêÊï∞Â≠ó</h3>
                <button id="generateNumber" class="btn" disabled>ÁîüÊàêÊï∞Â≠ó (0.0001 ETH)</button>
            </div>

            <!-- Êü•ËØ¢ÂäüËÉΩ -->
            <div class="control-panel">
                <h3>üîç Êü•ËØ¢ÂäüËÉΩ</h3>
                <div class="form-group">
                    <label for="queryAddress">Êü•ËØ¢Âú∞ÂùÄÊã•ÊúâÁöÑÊï∞Â≠ó:</label>
                    <input type="text" id="queryAddress" placeholder="ËæìÂÖ•Èí±ÂåÖÂú∞ÂùÄ">
                    <button id="queryUserNumbers" class="btn">Êü•ËØ¢Áî®Êà∑Êï∞Â≠ó</button>
                </div>
                <div class="form-group">
                    <label for="queryNumber">Êü•ËØ¢Êï∞Â≠óÁöÑÊâÄÊúâËÄÖ:</label>
                    <input type="number" id="queryNumber" placeholder="ËæìÂÖ•Êï∞Â≠ó (0-999)" min="0" max="999">
                    <button id="queryNumberOwner" class="btn">Êü•ËØ¢Êï∞Â≠óÊâÄÊúâËÄÖ</button>
                </div>
            </div>
        </div>

        <!-- Ê∂àÊÅØÊòæÁ§∫Âå∫Âüü -->
        <div id="messageArea"></div>

        <!-- ÊàëÁöÑÊï∞Â≠ó -->
        <div class="numbers-section">
            <h3>üéØ ÊàëÁöÑÂπ∏ËøêÊï∞Â≠ó</h3>
            <p>Êï∞Èáè: <span id="myNumberCount">0</span></p>
            <div id="myNumbers" class="numbers-grid">
                <!-- Áî®Êà∑ÁöÑÊï∞Â≠óÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
            </div>
        </div>

        <!-- Êü•ËØ¢ÁªìÊûú -->
        <div class="query-section">
            <h3>üìä Êü•ËØ¢ÁªìÊûú</h3>
            <div id="queryResult" class="query-result">
                ÁÇπÂáª‰∏äÊñπÊåâÈíÆÂºÄÂßãÊü•ËØ¢...
            </div>
        </div>
    </div>

    <script>
        // ÂêàÁ∫¶ÈÖçÁΩÆ
        const CONTRACT_ADDRESS = '0x68B1D87F95878fE05B998F19b66F4baba5De1aed';
        const CONTRACT_ABI = [
            "function generateNumber() external payable",
            "function getUserNumbers(address user) external view returns (uint256[])",
            "function getNumberOwner(uint256 number) external view returns (address)",
            "function isNumberTaken(uint256 number) external view returns (bool)",
            "function getUserNumberCount(address user) external view returns (uint256)",
            "function getSystemInfo() external view returns (uint256 price, uint256 totalGenerated, uint256 remaining, uint256 contractBalance)",
            "function GENERATION_PRICE() external view returns (uint256)",
            "function owner() external view returns (address)",
            "event NumberGenerated(address indexed user, uint256 indexed number, uint256 price)"
        ];

        let provider, signer, contract, userAccount, selectedWallet, currentWalletType;

        // Èí±ÂåÖÈÖçÁΩÆ
        const walletConfigs = {
            metamask: {
                name: 'MetaMask',
                icon: 'ü¶ä',
                description: 'MetaMask ÊµèËßàÂô®Èí±ÂåÖ',
                checkFunction: () => window.ethereum && window.ethereum.isMetaMask,
                getProvider: () => window.ethereum
            },
            luckyou: {
                name: 'LuckYou Wallet',
                icon: 'üçÄ',
                description: 'LuckYou Ëá™ÂÆö‰πâÈí±ÂåÖ',
                checkFunction: () => {
                    return window.luckyouWallet || 
                           (window.ethereum && window.ethereum.isLuckYouWallet);
                },
                getProvider: () => {
                    return window.luckyouWallet || 
                           (window.ethereum && window.ethereum.isLuckYouWallet ? window.ethereum : null);
                }
            }
        };

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
        window.addEventListener('load', async () => {
            await initializeApp();
        });

        // ÂàùÂßãÂåñÂ∫îÁî®
        async function initializeApp() {
            console.log('Initializing multi-wallet app...');
            
            // Á≠âÂæÖ‰∏ÄÊÆµÊó∂Èó¥Á°Æ‰øùÊâÄÊúâÈí±ÂåÖÊâ©Â±ïÈÉΩÂ∑≤Âä†ËΩΩ
            setTimeout(async () => {
                await detectAndDisplayWallets();
                await checkExistingConnection();
            }, 500);
        }

        // Ê£ÄÊµãÂπ∂ÊòæÁ§∫ÂèØÁî®Èí±ÂåÖ
        async function detectAndDisplayWallets() {
            const walletOptionsContainer = document.getElementById('walletOptions');
            walletOptionsContainer.innerHTML = '';

            let hasAvailableWallet = false;

            for (const [key, config] of Object.entries(walletConfigs)) {
                const isAvailable = config.checkFunction();
                console.log(`${config.name} available:`, isAvailable);

                const walletOption = document.createElement('div');
                walletOption.className = `wallet-option ${isAvailable ? '' : 'unavailable'}`;
                walletOption.setAttribute('data-wallet', key);

                walletOption.innerHTML = `
                    <div class="wallet-icon">${config.icon}</div>
                    <h4>${config.name}</h4>
                    <p>${config.description}</p>
                    <span class="wallet-status ${isAvailable ? 'available' : 'unavailable'}">
                        ${isAvailable ? 'ÂèØÁî®' : 'Êú™ÂÆâË£Ö'}
                    </span>
                `;

                if (isAvailable) {
                    hasAvailableWallet = true;
                    walletOption.addEventListener('click', () => selectWallet(key));
                }

                walletOptionsContainer.appendChild(walletOption);
            }

            if (hasAvailableWallet) {
                document.getElementById('walletActions').style.display = 'block';
            } else {
                showMessage('Êú™Ê£ÄÊµãÂà∞ÊîØÊåÅÁöÑÈí±ÂåÖ„ÄÇËØ∑ÂÆâË£Ö MetaMask Êàñ LuckYou Wallet„ÄÇ', 'error');
            }
        }

        // ÈÄâÊã©Èí±ÂåÖ
        function selectWallet(walletKey) {
            // ÁßªÈô§‰πãÂâçÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
            document.querySelectorAll('.wallet-option').forEach(option => {
                option.classList.remove('selected');
            });

            // ËÆæÁΩÆÊñ∞ÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
            const selectedOption = document.querySelector(`[data-wallet="${walletKey}"]`);
            if (selectedOption && !selectedOption.classList.contains('unavailable')) {
                selectedOption.classList.add('selected');
                selectedWallet = walletKey;
                
                // ÂêØÁî®ËøûÊé•ÊåâÈíÆ
                document.getElementById('connectWallet').disabled = false;
                
                showMessage(`Â∑≤ÈÄâÊã© ${walletConfigs[walletKey].name}`, 'info');
            }
        }

        // Ê£ÄÊü•Áé∞ÊúâËøûÊé•
        async function checkExistingConnection() {
            // Ê£ÄÊü• MetaMask
            if (window.ethereum && window.ethereum.isMetaMask) {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        selectedWallet = 'metamask';
                        await connectWallet();
                        return;
                    }
                } catch (error) {
                    console.log('MetaMask check failed:', error);
                }
            }

            // Ê£ÄÊü• LuckYou Wallet
            const luckyouProvider = walletConfigs.luckyou.getProvider();
            if (luckyouProvider) {
                try {
                    const accounts = await luckyouProvider.request({ method: 'eth_accounts' });
                    if (accounts && accounts.length > 0) {
                        selectedWallet = 'luckyou';
                        await connectWallet();
                        return;
                    }
                } catch (error) {
                    console.log('LuckYou Wallet check failed:', error);
                }
            }
        }

        // ËøûÊé•Èí±ÂåÖ
        async function connectWallet() {
            try {
                if (!selectedWallet) {
                    showMessage('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™Èí±ÂåÖ', 'error');
                    return;
                }

                const walletConfig = walletConfigs[selectedWallet];
                const walletProvider = walletConfig.getProvider();

                if (!walletProvider) {
                    throw new Error(`${walletConfig.name} ‰∏çÂèØÁî®`);
                }

                console.log(`Connecting to ${walletConfig.name}...`);

                // ËØ∑Ê±ÇË¥¶Êà∑ËøûÊé•
                await walletProvider.request({ method: 'eth_requestAccounts' });

                // ÂàõÂª∫ ethers provider
                provider = new ethers.BrowserProvider(walletProvider);
                signer = await provider.getSigner();
                userAccount = await signer.getAddress();
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                currentWalletType = selectedWallet;

                // Êõ¥Êñ∞UI
                document.getElementById('walletType').textContent = walletConfig.name;
                document.getElementById('walletAddress').textContent = userAccount.substring(0, 6) + '...' + userAccount.substring(38);
                document.getElementById('walletInfo').classList.add('show');
                document.getElementById('connectWallet').style.display = 'none';
                document.getElementById('disconnectWallet').style.display = 'inline-block';

                // ÂêØÁî®ÂäüËÉΩÊåâÈíÆ
                document.getElementById('generateNumber').disabled = false;

                // ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
                setupWalletEventListeners(walletProvider);

                // Êõ¥Êñ∞‰ø°ÊÅØ
                await updateWalletInfo();
                await updateContractInfo();
                await updateUserNumbers();

                showMessage(`${walletConfig.name} ËøûÊé•ÊàêÂäüÔºÅ`, 'success');

            } catch (error) {
                console.error('ËøûÊé•Èí±ÂåÖÂ§±Ë¥•:', error);
                showMessage('ËøûÊé•Èí±ÂåÖÂ§±Ë¥•: ' + error.message, 'error');
            }
        }

        // Êñ≠ÂºÄÈí±ÂåÖËøûÊé•
        function disconnectWallet() {
            provider = null;
            signer = null;
            contract = null;
            userAccount = null;
            selectedWallet = null;
            currentWalletType = null;

            // ÈáçÁΩÆUI
            document.getElementById('walletInfo').classList.remove('show');
            document.getElementById('connectWallet').style.display = 'inline-block';
            document.getElementById('disconnectWallet').style.display = 'none';
            document.getElementById('generateNumber').disabled = true;

            // Ê∏ÖÈô§ÈÄâ‰∏≠Áä∂ÊÄÅ
            document.querySelectorAll('.wallet-option').forEach(option => {
                option.classList.remove('selected');
            });

            // ÈáçÁΩÆÊï∞ÊçÆÊòæÁ§∫
            document.getElementById('myNumberCount').textContent = '0';
            document.getElementById('myNumbers').innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #666;">ËØ∑ÂÖàËøûÊé•Èí±ÂåÖ</p>';

            showMessage('Èí±ÂåÖÂ∑≤Êñ≠ÂºÄËøûÊé•', 'info');
        }

        // ËÆæÁΩÆÈí±ÂåÖ‰∫ã‰ª∂ÁõëÂê¨Âô®
        function setupWalletEventListeners(walletProvider) {
            if (walletProvider.on) {
                // Ë¥¶Êà∑ÂèòÂåñÁõëÂê¨
                walletProvider.on('accountsChanged', async (accounts) => {
                    if (accounts.length === 0) {
                        disconnectWallet();
                    } else {
                        userAccount = accounts[0];
                        await updateWalletInfo();
                        await updateUserNumbers();
                        showMessage('Ë¥¶Êà∑Â∑≤ÂàáÊç¢', 'info');
                    }
                });

                // ÁΩëÁªúÂèòÂåñÁõëÂê¨
                walletProvider.on('chainChanged', async (chainId) => {
                    await updateWalletInfo();
                    await updateContractInfo();
                    showMessage('ÁΩëÁªúÂ∑≤ÂàáÊç¢', 'info');
                });

                // ËøûÊé•Áä∂ÊÄÅÁõëÂê¨
                walletProvider.on('connect', (connectInfo) => {
                    console.log('Wallet connected:', connectInfo);
                });

                walletProvider.on('disconnect', (error) => {
                    console.log('Wallet disconnected:', error);
                    disconnectWallet();
                });
            }
        }

        // Êõ¥Êñ∞Èí±ÂåÖ‰ø°ÊÅØ
        async function updateWalletInfo() {
            try {
                const balance = await provider.getBalance(userAccount);
                document.getElementById('walletBalance').textContent = ethers.formatEther(balance);

                const network = await provider.getNetwork();
                document.getElementById('networkName').textContent = network.name || 'Unknown';
            } catch (error) {
                console.error('Êõ¥Êñ∞Èí±ÂåÖ‰ø°ÊÅØÂ§±Ë¥•:', error);
            }
        }

        // Êõ¥Êñ∞ÂêàÁ∫¶‰ø°ÊÅØ
        async function updateContractInfo() {
            try {
                const systemInfo = await contract.getSystemInfo();
                document.getElementById('totalGenerated').textContent = systemInfo.totalGenerated.toString();
                document.getElementById('remainingNumbers').textContent = systemInfo.remaining.toString();
                document.getElementById('contractBalance').textContent = ethers.formatEther(systemInfo.contractBalance);
            } catch (error) {
                console.error('Êõ¥Êñ∞ÂêàÁ∫¶‰ø°ÊÅØÂ§±Ë¥•:', error);
                // ÊòæÁ§∫ÈªòËÆ§ÂÄº
                document.getElementById('totalGenerated').textContent = '-';
                document.getElementById('remainingNumbers').textContent = '-';
                document.getElementById('contractBalance').textContent = '-';
            }
        }

        // Êõ¥Êñ∞Áî®Êà∑Êï∞Â≠ó
        async function updateUserNumbers() {
            try {
                const numbers = await contract.getUserNumbers(userAccount);
                const count = numbers.length;
                
                document.getElementById('myNumberCount').textContent = count;
                
                const numbersGrid = document.getElementById('myNumbers');
                numbersGrid.innerHTML = '';
                
                if (count === 0) {
                    numbersGrid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #666;">ÊöÇÊó†Êï∞Â≠ó</p>';
                } else {
                    numbers.forEach(number => {
                        const badge = document.createElement('div');
                        badge.className = 'number-badge';
                        badge.textContent = number.toString().padStart(3, '0');
                        numbersGrid.appendChild(badge);
                    });
                }
            } catch (error) {
                console.error('Êõ¥Êñ∞Áî®Êà∑Êï∞Â≠óÂ§±Ë¥•:', error);
            }
        }

        // ÁîüÊàêÊï∞Â≠ó
        async function generateNumber() {
            try {
                const button = document.getElementById('generateNumber');
                button.innerHTML = '<span class="loading"></span>ÁîüÊàê‰∏≠...';
                button.disabled = true;

                const generationPrice = await contract.GENERATION_PRICE();
                const tx = await contract.generateNumber({ value: generationPrice });
                
                showMessage('‰∫§ÊòìÂ∑≤Êèê‰∫§ÔºåÁ≠âÂæÖÁ°ÆËÆ§...', 'info');
                showMessage('<div class="transaction-hash">‰∫§ÊòìÂìàÂ∏å: ' + tx.hash + '</div>', 'info');

                const receipt = await tx.wait();
                
                // Êü•Êâæ‰∫ã‰ª∂
                const event = receipt.logs.find(log => {
                    try {
                        const parsed = contract.interface.parseLog(log);
                        return parsed.name === 'NumberGenerated';
                    } catch (e) {
                        return false;
                    }
                });

                if (event) {
                    const parsedEvent = contract.interface.parseLog(event);
                    const generatedNumber = parsedEvent.args.number.toString();
                    showMessage(`üéâ ÊÅ≠ÂñúÔºÅ‰Ω†Ëé∑Âæó‰∫ÜÊï∞Â≠ó: ${generatedNumber.padStart(3, '0')}`, 'success');
                } else {
                    showMessage('Êï∞Â≠óÁîüÊàêÊàêÂäüÔºÅ', 'success');
                }

                // Êõ¥Êñ∞‰ø°ÊÅØ
                await updateContractInfo();
                await updateUserNumbers();
                await updateWalletInfo();

            } catch (error) {
                console.error('ÁîüÊàêÊï∞Â≠óÂ§±Ë¥•:', error);
                showMessage('ÁîüÊàêÊï∞Â≠óÂ§±Ë¥•: ' + error.message, 'error');
            } finally {
                const button = document.getElementById('generateNumber');
                button.innerHTML = 'ÁîüÊàêÊï∞Â≠ó (0.0001 ETH)';
                button.disabled = false;
            }
        }

        // Êü•ËØ¢Áî®Êà∑Êï∞Â≠ó
        async function queryUserNumbers() {
            try {
                const address = document.getElementById('queryAddress').value.trim();
                if (!address) {
                    showMessage('ËØ∑ËæìÂÖ•Ë¶ÅÊü•ËØ¢ÁöÑÂú∞ÂùÄ', 'error');
                    return;
                }

                if (!ethers.isAddress(address)) {
                    showMessage('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑ‰ª•Â§™ÂùäÂú∞ÂùÄ', 'error');
                    return;
                }

                const numbers = await contract.getUserNumbers(address);
                const count = numbers.length;

                let result = `<p><strong>Âú∞ÂùÄ:</strong> ${address}</p>`;
                result += `<p><strong>Êã•ÊúâÊï∞Â≠óÊï∞Èáè:</strong> ${count}</p>`;
                
                if (count > 0) {
                    result += `<p><strong>Êã•ÊúâÁöÑÊï∞Â≠ó:</strong></p>`;
                    result += `<div class="numbers-grid">`;
                    numbers.forEach(number => {
                        result += `<div class="number-badge">${number.toString().padStart(3, '0')}</div>`;
                    });
                    result += `</div>`;
                } else {
                    result += `<p>ËØ•Âú∞ÂùÄÊöÇÊó†Êï∞Â≠ó</p>`;
                }

                document.getElementById('queryResult').innerHTML = result;
            } catch (error) {
                console.error('Êü•ËØ¢Áî®Êà∑Êï∞Â≠óÂ§±Ë¥•:', error);
                document.getElementById('queryResult').innerHTML = `<p style="color: red;">Êü•ËØ¢Â§±Ë¥•: ${error.message}</p>`;
            }
        }

        // Êü•ËØ¢Êï∞Â≠óÊâÄÊúâËÄÖ
        async function queryNumberOwner() {
            try {
                const number = parseInt(document.getElementById('queryNumber').value);
                if (isNaN(number) || number < 0 || number > 999) {
                    showMessage('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÊï∞Â≠ó (0-999)', 'error');
                    return;
                }

                const owner = await contract.getNumberOwner(number);
                const isTaken = await contract.isNumberTaken(number);

                let result = `<p><strong>Êü•ËØ¢Êï∞Â≠ó:</strong> ${number.toString().padStart(3, '0')}</p>`;
                result += `<p><strong>ÊòØÂê¶Â∑≤Ë¢´Âç†Áî®:</strong> ${isTaken ? 'ÊòØ' : 'Âê¶'}</p>`;
                
                if (isTaken && owner !== '0x0000000000000000000000000000000000000000') {
                    result += `<p><strong>ÊâÄÊúâËÄÖ:</strong> ${owner}</p>`;
                } else {
                    result += `<p><strong>ÊâÄÊúâËÄÖ:</strong> ÊöÇÊó†</p>`;
                }

                document.getElementById('queryResult').innerHTML = result;
            } catch (error) {
                console.error('Êü•ËØ¢Êï∞Â≠óÊâÄÊúâËÄÖÂ§±Ë¥•:', error);
                document.getElementById('queryResult').innerHTML = `<p style="color: red;">Êü•ËØ¢Â§±Ë¥•: ${error.message}</p>`;
            }
        }

        // ÊòæÁ§∫Ê∂àÊÅØ
        function showMessage(message, type) {
            const messageArea = document.getElementById('messageArea');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${type}`;
            alertDiv.innerHTML = message;
            
            messageArea.appendChild(alertDiv);
            
            // 5ÁßíÂêéËá™Âä®ÁßªÈô§Ê∂àÊÅØ
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }

        // ‰∫ã‰ª∂ÁõëÂê¨Âô®
        document.getElementById('connectWallet').addEventListener('click', connectWallet);
        document.getElementById('disconnectWallet').addEventListener('click', disconnectWallet);
        document.getElementById('generateNumber').addEventListener('click', generateNumber);
        document.getElementById('queryUserNumbers').addEventListener('click', queryUserNumbers);
        document.getElementById('queryNumberOwner').addEventListener('click', queryNumberOwner);

        // EIP-6963 Ê†áÂáÜÈí±ÂåÖÂèëÁé∞
        function announceProvider() {
            const info = {
                uuid: 'lucky-snake-dapp',
                name: 'LuckSnake DApp',
                icon: 'data:image/svg+xml;base64,...', // ÂèØ‰ª•Ê∑ªÂä†ÂõæÊ†á
                rdns: 'com.lucksnake.dapp'
            };

            window.dispatchEvent(
                new CustomEvent('eip6963:requestProvider', {
                    detail: {
                        info,
                        reply: (providerDetail) => {
                            console.log('EIP-6963 provider announced:', providerDetail);
                        }
                    }
                })
            );
        }

        // Ëß¶Âèë EIP-6963 Èí±ÂåÖÂèëÁé∞
        setTimeout(announceProvider, 100);
    </script>
</body>
</html>