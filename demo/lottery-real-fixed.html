<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ² è›‡å¸NFTçœŸå®æŠ½å¥– - ä¿®å¤ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 3rem;
            color: #333;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2rem;
            color: #666;
        }

        .wallet-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }

        .wallet-section h2 {
            color: #333;
            margin-bottom: 15px;
        }

        .wallet-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .wallet-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 200px;
            font-weight: bold;
        }
        
        .wallet-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }
        
        .wallet-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .luckyou-btn {
            background: linear-gradient(45deg, #FF6B6B, #FF8E8E);
        }
        
        .luckyou-btn:hover:not(:disabled) {
            background: linear-gradient(45deg, #FF5252, #FF7676);
        }

        .wallet-info {
            margin-top: 15px;
            padding: 15px;
            background: #e9ecef;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.9rem;
        }

        .lottery-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .lottery-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .info-card h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .info-card p {
            font-size: 1.5rem;
            font-weight: bold;
            color: #007bff;
        }

        .lottery-btn {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            border: none;
            padding: 20px 40px;
            border-radius: 50px;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            display: block;
        }

        .lottery-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
        }

        .lottery-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .status {
            text-align: center;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            font-weight: bold;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .contract-info {
            background: #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            font-family: monospace;
            font-size: 0.9rem;
        }

        .contract-info h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .contract-info p {
            margin-bottom: 5px;
            word-break: break-all;
        }

        .connect-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 10px;
        }

        .connect-btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .connect-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ² è›‡å¸NFTçœŸå®æŠ½å¥–</h1>
            <p>è¿æ¥ LuckYou é’±åŒ…ï¼Œæ”¯ä»˜0.0001 ETHå‚ä¸çœŸå®æŠ½å¥–ï¼</p>
        </div>

        <div class="wallet-section">
            <h2>ğŸ”— é’±åŒ…è¿æ¥</h2>
            <div class="wallet-buttons">
                <button id="luckyouBtn" class="wallet-btn luckyou-btn" onclick="connectLuckYou()">
                    ğŸ€ è¿æ¥ LuckYou é’±åŒ…
                </button>
            </div>
            <div id="walletInfo" class="wallet-info" style="display: none;">
                <!-- é’±åŒ…ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>

        <div class="lottery-section">
            <h2>ğŸ¯ æŠ½å¥–ä¿¡æ¯</h2>
            
            <div class="contract-info">
                <h3>ğŸ“‹ åˆçº¦ä¿¡æ¯</h3>
                <p><strong>åˆçº¦åœ°å€:</strong> <span id="contractAddress">æœªè¿æ¥</span></p>
                <p><strong>ç½‘ç»œ:</strong> <span id="networkInfo">æœªè¿æ¥</span></p>
            </div>

            <div class="lottery-info">
                <div class="info-card">
                    <h3>æŠ½å¥–ä»·æ ¼</h3>
                    <p id="lotteryPrice">0.0001 ETH</p>
                </div>
                <div class="info-card">
                    <h3>æ± å­å¤§å°</h3>
                    <p id="poolSize">-</p>
                </div>
                <div class="info-card">
                    <h3>å·²é“¸é€ </h3>
                    <p id="totalMinted">-</p>
                </div>
                <div class="info-card">
                    <h3>å‰©ä½™æ•°é‡</h3>
                    <p id="remainingSupply">-</p>
                </div>
            </div>
            
            <div style="text-align: center; margin-bottom: 20px;">
                <button id="refreshInfoBtn" class="connect-btn" onclick="refreshContractInfo()">
                    ğŸ”„ åˆ·æ–°åˆçº¦ä¿¡æ¯
                </button>
                <button id="diagnoseBtn" class="connect-btn" onclick="diagnoseNetwork()" style="background: #17a2b8;">
                    ğŸ” ç½‘ç»œè¯Šæ–­
                </button>
            </div>

            <button id="lotteryBtn" class="lottery-btn" onclick="playLottery()" disabled>
                è¯·å…ˆè¿æ¥é’±åŒ…
            </button>

            <div id="statusDiv"></div>
        </div>
    </div>

    <script>
        // åˆçº¦é…ç½®
        const CONTRACT_ADDRESS = "0xa513E6E4b8f2a923D98304ec87F64353C4D5C853";
        
        // ç®€åŒ–çš„ABIï¼ŒåªåŒ…å«å¿…è¦çš„æ–¹æ³•ç­¾å
        const ABI_SIGNATURES = {
            lotteryPrice: '0x8c172fa2',
            getPoolSize: '0x1b8a3c32',
            totalSupply: '0x18160ddd',
            playLottery: '0xb2a1038b'
        };

        let walletProvider;
        let userAccount;
        let userBalance;
        let currentWalletName;

        // è¿æ¥ LuckYou é’±åŒ…
        async function connectLuckYou() {
            const luckyouBtn = document.getElementById('luckyouBtn');
            const walletInfo = document.getElementById('walletInfo');
            
            try {
                // ç¦ç”¨æŒ‰é’®
                luckyouBtn.disabled = true;
                luckyouBtn.innerHTML = '<span class="spinner"></span> è¿æ¥ä¸­...';
                
                let provider;
                let walletName = 'LuckYou Wallet';
                
                // æ£€æµ‹ LuckYou é’±åŒ…
                if (typeof window.luckYou !== 'undefined') {
                    provider = window.luckYou;
                    console.log('ä½¿ç”¨ä¸»è¦ LuckYou é’±åŒ…å¯¹è±¡');
                } else if (window.luckyouWallet && window.luckyouWallet.isLuckYouWallet) {
                    provider = window.luckyouWallet;
                    console.log('ä½¿ç”¨æ›¿ä»£ LuckYou é’±åŒ…å¯¹è±¡');
                } else {
                    throw new Error('æœªæ£€æµ‹åˆ° LuckYou é’±åŒ…ï¼Œè¯·å®‰è£… LuckYou é’±åŒ…æ‰©å±•ï¼');
                }
                
                // ä¿å­˜é’±åŒ…æä¾›è€…
                walletProvider = provider;
                currentWalletName = walletName;
                
                console.log('LuckYou é’±åŒ…æä¾›è€…:', provider);
                
                // è¯·æ±‚è´¦æˆ·è¿æ¥
                const accounts = await provider.request({
                    method: 'eth_requestAccounts'
                });

                userAccount = accounts[0];
                console.log('LuckYou é’±åŒ…è´¦æˆ·åœ°å€:', userAccount);
                
                // æ£€æŸ¥ç½‘ç»œ
                let chainId;
                let networkName;
                try {
                    chainId = await provider.request({ method: 'eth_chainId' });
                    networkName = getNetworkName(chainId);
                    console.log('LuckYou é’±åŒ…ç½‘ç»œ Chain ID:', chainId);
                    console.log('LuckYou é’±åŒ…ç½‘ç»œåç§°:', networkName);
                    
                    // æ£€æŸ¥ç½‘ç»œæ˜¯å¦åŒ¹é…
                    if (chainId !== '0x539' && chainId !== '0x31337' && chainId !== '0x7a69') {
                        showStatus('âš ï¸ å½“å‰ç½‘ç»œä¸åŒ¹é…ï¼Œå°è¯•åˆ‡æ¢åˆ°æœ¬åœ° Hardhat ç½‘ç»œ', 'info');
                        
                        // å°è¯•åˆ‡æ¢åˆ°æ­£ç¡®çš„ç½‘ç»œ
                        try {
                            await provider.request({
                                method: 'wallet_switchEthereumChain',
                                params: [{ chainId: '0x7a69' }]
                            });
                            console.log('å·²åˆ‡æ¢åˆ° Hardhat ç½‘ç»œ');
                            chainId = '0x7a69';
                            networkName = 'Hardhat Local Network';
                        } catch (switchError) {
                            console.warn('ç½‘ç»œåˆ‡æ¢å¤±è´¥:', switchError);
                            showStatus('âŒ è¯·æ‰‹åŠ¨åˆ‡æ¢åˆ°æœ¬åœ° Hardhat ç½‘ç»œ (Chain ID: 31337)', 'error');
                            luckyouBtn.disabled = false;
                            luckyouBtn.innerHTML = 'ğŸ€ è¿æ¥ LuckYou é’±åŒ…';
                            return;
                        }
                    }
                } catch (networkError) {
                    console.error('è·å–ç½‘ç»œä¿¡æ¯å¤±è´¥:', networkError);
                    chainId = '0x7a69';
                    networkName = 'Hardhat Local Network';
                }
                
                // è·å–ç”¨æˆ·ä½™é¢ - ä½¿ç”¨åŸå§‹æ–¹æ³•é¿å…è§£ç é—®é¢˜
                try {
                    const balanceResult = await provider.request({
                        method: 'eth_getBalance',
                        params: [userAccount, 'latest']
                    });
                    
                    console.log('ä½™é¢æŸ¥è¯¢ç»“æœ:', balanceResult);
                    
                    // å¤„ç†ä¸åŒçš„è¿”å›æ ¼å¼
                    if (balanceResult && typeof balanceResult === 'object' && balanceResult.error) {
                        console.warn('ä½™é¢æŸ¥è¯¢è¿”å›é”™è¯¯:', balanceResult.error);
                        userBalance = '0x0';
                    } else if (typeof balanceResult === 'string') {
                        userBalance = balanceResult;
                    } else {
                        userBalance = '0x0';
                    }
                    
                } catch (balanceError) {
                    console.error('è·å–ä½™é¢å¤±è´¥:', balanceError);
                    userBalance = '0x0';
                }
                
                // æ›´æ–°UI
                updateWalletInfo(userAccount, userBalance, networkName, walletName);
                await updateLotteryInfo();
                enableLottery();
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                luckyouBtn.innerHTML = 'âœ… é’±åŒ…å·²è¿æ¥';
                luckyouBtn.style.background = '#28a745';
                luckyouBtn.onclick = disconnectWallet;
                
                showStatus(`âœ… ${walletName} è¿æ¥æˆåŠŸï¼`, 'success');
                
            } catch (error) {
                console.error('LuckYou è¿æ¥å¤±è´¥:', error);
                showStatus(`âŒ LuckYou è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                luckyouBtn.disabled = false;
                luckyouBtn.innerHTML = 'ğŸ€ è¿æ¥ LuckYou é’±åŒ…';
                luckyouBtn.style.background = 'linear-gradient(45deg, #FF6B6B, #FF8E8E)';
                luckyouBtn.onclick = connectLuckYou;
            }
        }

        // æ–­å¼€é’±åŒ…è¿æ¥
        function disconnectWallet() {
            const luckyouBtn = document.getElementById('luckyouBtn');
            const walletInfo = document.getElementById('walletInfo');
            const lotteryBtn = document.getElementById('lotteryBtn');
            
            // é‡ç½®çŠ¶æ€
            userAccount = null;
            userBalance = null;
            walletProvider = null;
            currentWalletName = null;
            
            // æ›´æ–°UI
            walletInfo.style.display = 'none';
            lotteryBtn.disabled = true;
            lotteryBtn.innerHTML = 'è¯·å…ˆè¿æ¥é’±åŒ…';
            
            // é‡ç½®æŒ‰é’®çŠ¶æ€
            luckyouBtn.disabled = false;
            luckyouBtn.innerHTML = 'ğŸ€ è¿æ¥ LuckYou é’±åŒ…';
            luckyouBtn.style.background = 'linear-gradient(45deg, #FF6B6B, #FF8E8E)';
            luckyouBtn.onclick = connectLuckYou;
            
            showStatus('ğŸ”Œ é’±åŒ…å·²æ–­å¼€è¿æ¥', 'info');
        }

        // æ›´æ–°é’±åŒ…ä¿¡æ¯
        function updateWalletInfo(account, balance, network, walletName) {
            const walletInfo = document.getElementById('walletInfo');
            const contractAddress = document.getElementById('contractAddress');
            const networkInfo = document.getElementById('networkInfo');
            
            walletInfo.style.display = 'block';
            
            // å®‰å…¨åœ°è½¬æ¢ä½™é¢æ˜¾ç¤º
            let balanceDisplay = '0 ETH';
            try {
                if (balance && typeof balance === 'string' && balance !== '0x0') {
                    const balanceWei = BigInt(balance);
                    const balanceEth = Number(balanceWei) / Math.pow(10, 18);
                    balanceDisplay = `${balanceEth.toFixed(6)} ETH`;
                }
            } catch (error) {
                console.error('ä½™é¢è½¬æ¢å¤±è´¥:', error);
                balanceDisplay = '0 ETH';
            }
            
            walletInfo.innerHTML = `
                <p><strong>é’±åŒ…ç±»å‹:</strong> ${walletName}</p>
                <p><strong>è´¦æˆ·åœ°å€:</strong> ${account}</p>
                <p><strong>è´¦æˆ·ä½™é¢:</strong> ${balanceDisplay}</p>
                <p><strong>ç½‘ç»œ:</strong> ${network}</p>
            `;
            
            contractAddress.textContent = CONTRACT_ADDRESS;
            networkInfo.textContent = network;
        }

        // è·å–ç½‘ç»œåç§°
        function getNetworkName(chainId) {
            const networks = {
                '0x1': 'Ethereum Mainnet',
                '0x3': 'Ropsten Testnet',
                '0x4': 'Rinkeby Testnet',
                '0x5': 'Goerli Testnet',
                '0x2a': 'Kovan Testnet',
                '0x7a69': 'Hardhat Local Network',
                '0x539': 'Hardhat Local Network',
                '0x31337': 'Hardhat Local Network'
            };
            return networks[chainId] || `Chain ID: ${chainId}`;
        }

        // å¯ç”¨æŠ½å¥–
        function enableLottery() {
            const lotteryBtn = document.getElementById('lotteryBtn');
            lotteryBtn.disabled = false;
            lotteryBtn.innerHTML = 'ğŸ² å¼€å§‹æŠ½å¥– (0.0001 ETH)';
        }

        // åŸå§‹åˆçº¦è°ƒç”¨æ–¹æ³• - é¿å…Web3.js ABIè§£ç é—®é¢˜
        async function rawContractCall(methodSignature, decodeType = 'uint256') {
            if (!walletProvider) {
                throw new Error('é’±åŒ…æœªè¿æ¥');
            }

            try {
                const result = await walletProvider.request({
                    method: 'eth_call',
                    params: [{
                        to: CONTRACT_ADDRESS,
                        data: methodSignature
                    }, 'latest']
                });

                console.log(`åŸå§‹è°ƒç”¨ç»“æœ ${methodSignature}:`, result);

                // ç®€å•çš„ç»“æœå¤„ç†
                if (result && typeof result === 'string' && result.startsWith('0x')) {
                    if (decodeType === 'uint256') {
                        return BigInt(result).toString();
                    }
                }
                return '0';
            } catch (error) {
                console.error(`åˆçº¦è°ƒç”¨å¤±è´¥ ${methodSignature}:`, error);
                return '0';
            }
        }

        // æ›´æ–°æŠ½å¥–ä¿¡æ¯
        async function updateLotteryInfo() {
            if (!walletProvider) {
                console.log('é’±åŒ…æœªè¿æ¥ï¼Œè·³è¿‡æ›´æ–°æŠ½å¥–ä¿¡æ¯');
                return;
            }
            
            try {
                console.log('å¼€å§‹è·å–å®æ—¶æŠ½å¥–ä¿¡æ¯...');
                
                // ä½¿ç”¨åŸå§‹è°ƒç”¨æ–¹æ³•
                const price = await rawContractCall(ABI_SIGNATURES.lotteryPrice);
                const poolSize = await rawContractCall(ABI_SIGNATURES.getPoolSize);
                const totalMinted = await rawContractCall(ABI_SIGNATURES.totalSupply);
                
                console.log('è·å–åˆ°çš„æ•°æ®:', { price, poolSize, totalMinted });
                
                // è®¡ç®—å‰©ä½™æ•°é‡
                const maxSupply = 1000;
                const remaining = maxSupply - parseInt(totalMinted || 0);
                
                // æ›´æ–°UI
                try {
                    const priceInEth = (BigInt(price || 0) / BigInt(Math.pow(10, 18))).toString();
                    document.getElementById('lotteryPrice').textContent = `${priceInEth} ETH`;
                    document.getElementById('poolSize').textContent = poolSize || '0';
                    document.getElementById('totalMinted').textContent = totalMinted || '0';
                    document.getElementById('remainingSupply').textContent = remaining.toString();
                    
                    console.log('æŠ½å¥–ä¿¡æ¯æ›´æ–°æˆåŠŸ');
                    showStatus('ğŸ”„ æŠ½å¥–ä¿¡æ¯å·²æ›´æ–°', 'info');
                    
                } catch (uiError) {
                    console.error('æ›´æ–°UIå¤±è´¥:', uiError);
                }
                
            } catch (error) {
                console.error('è·å–æŠ½å¥–ä¿¡æ¯å¤±è´¥:', error);
                showStatus('âš ï¸ æ— æ³•è·å–å®æ—¶æŠ½å¥–ä¿¡æ¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'info');
            }
        }

        // åˆ·æ–°åˆçº¦ä¿¡æ¯
        async function refreshContractInfo() {
            if (walletProvider) {
                console.log('ä½¿ç”¨å·²è¿æ¥çš„é’±åŒ…åˆ·æ–°åˆçº¦ä¿¡æ¯');
                await updateLotteryInfo();
            } else {
                showStatus('âŒ è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
            }
        }

        // ç½‘ç»œè¯Šæ–­
        async function diagnoseNetwork() {
            if (!walletProvider) {
                showStatus('âŒ è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
                return;
            }
            
            try {
                showStatus('ğŸ” æ­£åœ¨è¯Šæ–­ç½‘ç»œ...', 'info');
                console.log('å¼€å§‹ç½‘ç»œè¯Šæ–­...');
                
                // è·å–ç½‘ç»œä¿¡æ¯
                const chainId = await walletProvider.request({ method: 'eth_chainId' });
                const networkName = getNetworkName(chainId);
                console.log('å½“å‰ç½‘ç»œ Chain ID:', chainId);
                console.log('å½“å‰ç½‘ç»œåç§°:', networkName);
                
                // æ£€æŸ¥ç½‘ç»œæ˜¯å¦åŒ¹é…
                if (chainId !== '0x539' && chainId !== '0x31337' && chainId !== '0x7a69') {
                    showStatus('âš ï¸ å½“å‰ç½‘ç»œä¸åŒ¹é…ï¼Œåˆçº¦åœ°å€ä»…é€‚ç”¨äºæœ¬åœ° Hardhat ç½‘ç»œ', 'error');
                    return;
                }
                
                // è·å–æœ€æ–°åŒºå—
                const latestBlock = await walletProvider.request({
                    method: 'eth_getBlockByNumber',
                    params: ['latest', false]
                });
                console.log('æœ€æ–°åŒºå—å·:', latestBlock.number);
                
                // æ£€æŸ¥åˆçº¦ä»£ç 
                const code = await walletProvider.request({
                    method: 'eth_getCode',
                    params: [CONTRACT_ADDRESS, 'latest']
                });
                
                if (!code || code === '0x' || code === '0x0') {
                    showStatus('âŒ åˆçº¦æœªéƒ¨ç½²æˆ–åœ°å€é”™è¯¯', 'error');
                    return;
                }
                
                console.log('åˆçº¦ä»£ç é•¿åº¦:', code.length);
                
                // æµ‹è¯•åˆçº¦è°ƒç”¨
                const testResult = await rawContractCall(ABI_SIGNATURES.lotteryPrice);
                console.log('æµ‹è¯•åˆçº¦è°ƒç”¨ç»“æœ:', testResult);
                
                showStatus('âœ… ç½‘ç»œè¯Šæ–­å®Œæˆï¼Œä¸€åˆ‡æ­£å¸¸ï¼', 'success');
                
            } catch (error) {
                console.error('ç½‘ç»œè¯Šæ–­å¤±è´¥:', error);
                showStatus(`âŒ ç½‘ç»œè¯Šæ–­å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æŠ½å¥–åŠŸèƒ½
        async function playLottery() {
            if (!walletProvider || !userAccount) {
                showStatus('âŒ è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
                return;
            }

            const lotteryBtn = document.getElementById('lotteryBtn');
            const originalText = lotteryBtn.innerHTML;
            
            try {
                // ç¦ç”¨æŒ‰é’®
                lotteryBtn.disabled = true;
                lotteryBtn.innerHTML = '<span class="spinner"></span> æŠ½å¥–ä¸­...';
                
                // è·å–æŠ½å¥–ä»·æ ¼
                const priceStr = await rawContractCall(ABI_SIGNATURES.lotteryPrice);
                const price = '0x' + BigInt(priceStr).toString(16);
                
                console.log('æŠ½å¥–ä»·æ ¼:', price);
                
                // æ£€æŸ¥ä½™é¢
                const balanceStr = await walletProvider.request({
                    method: 'eth_getBalance',
                    params: [userAccount, 'latest']
                });
                
                const userBalanceBig = BigInt(balanceStr);
                const priceBig = BigInt(price);
                
                if (userBalanceBig < priceBig) {
                    throw new Error('ä½™é¢ä¸è¶³ï¼Œæ— æ³•æ”¯ä»˜æŠ½å¥–è´¹ç”¨');
                }
                
                // å‘é€æŠ½å¥–äº¤æ˜“
                const txHash = await walletProvider.request({
                    method: 'eth_sendTransaction',
                    params: [{
                        from: userAccount,
                        to: CONTRACT_ADDRESS,
                        value: price,
                        data: ABI_SIGNATURES.playLottery,
                        gas: '0x493e0' // 300000
                    }]
                });
                
                console.log('äº¤æ˜“å“ˆå¸Œ:', txHash);
                showStatus(`ğŸ‰ æŠ½å¥–äº¤æ˜“å·²æäº¤ï¼äº¤æ˜“å“ˆå¸Œ: ${txHash}`, 'success');
                
                // æ›´æ–°ä¿¡æ¯
                await updateLotteryInfo();
                
            } catch (error) {
                console.error('æŠ½å¥–å¤±è´¥:', error);
                showStatus(`âŒ æŠ½å¥–å¤±è´¥: ${error.message}`, 'error');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                lotteryBtn.disabled = false;
                lotteryBtn.innerHTML = originalText;
            }
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusDiv');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 8000);
        }

        // æ£€æŸ¥é’±åŒ…çŠ¶æ€
        function checkWallet() {
            const luckyouBtn = document.getElementById('luckyouBtn');
            
            // æ£€æµ‹ LuckYou Wallet
            let luckyouAvailable = false;
            
            if (typeof window.luckYou !== 'undefined' || (window.luckyouWallet && window.luckyouWallet.isLuckYouWallet)) {
                luckyouAvailable = true;
                console.log('âœ… LuckYou é’±åŒ…å¯ç”¨');
            } else {
                console.log('âŒ LuckYou é’±åŒ…ä¸å¯ç”¨');
            }
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            if (luckyouAvailable) {
                luckyouBtn.disabled = false;
                luckyouBtn.style.background = 'linear-gradient(45deg, #FF6B6B, #FF8E8E)';
                showStatus('âœ… LuckYou é’±åŒ…å·²å°±ç»ªï¼', 'success');
            } else {
                luckyouBtn.disabled = true;
                luckyouBtn.style.background = '#6c757d';
                luckyouBtn.innerHTML = 'âŒ è¯·å®‰è£… LuckYou é’±åŒ…';
                showStatus('âŒ æœªæ£€æµ‹åˆ° LuckYou é’±åŒ…ï¼Œè¯·å®‰è£…æ‰©å±•', 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥é’±åŒ…
        window.onload = function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œæ£€æŸ¥é’±åŒ…çŠ¶æ€...');
            
            console.log('window.luckYou:', typeof window.luckYou !== 'undefined' ? 'å·²å®šä¹‰' : 'æœªå®šä¹‰');
            console.log('window.luckyouWallet:', typeof window.luckyouWallet !== 'undefined' ? 'å·²å®šä¹‰' : 'æœªå®šä¹‰');
            if (window.luckyouWallet) {
                console.log('window.luckyouWallet.isLuckYouWallet:', window.luckyouWallet.isLuckYouWallet);
            }
            
            // å»¶è¿Ÿæ£€æŸ¥é’±åŒ…ï¼Œç¡®ä¿æ‰©å±•åŠ è½½å®Œæˆ
            setTimeout(() => {
                checkWallet();
            }, 1000);
        };
    </script>
</body>
</html>