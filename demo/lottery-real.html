<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ² è›‡å¸NFTçœŸå®æŠ½å¥–</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 3rem;
            color: #333;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2rem;
            color: #666;
        }

        .wallet-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }

        .wallet-section h2 {
            color: #333;
            margin-bottom: 15px;
        }

                 .wallet-buttons {
             display: flex;
             gap: 15px;
             justify-content: center;
             flex-wrap: wrap;
             margin-bottom: 20px;
         }
         
         .wallet-btn {
             background: #007bff;
             color: white;
             border: none;
             padding: 15px 25px;
             border-radius: 10px;
             font-size: 1.1rem;
             cursor: pointer;
             transition: all 0.3s ease;
             min-width: 200px;
             font-weight: bold;
         }
         
         .wallet-btn:hover {
             transform: translateY(-3px);
             box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
         }
         
         .wallet-btn:disabled {
             opacity: 0.6;
             cursor: not-allowed;
             transform: none;
             box-shadow: none;
         }
         
         .luckyou-btn {
             background: linear-gradient(45deg, #FF6B6B, #FF8E8E);
         }
         
         .luckyou-btn:hover:not(:disabled) {
             background: linear-gradient(45deg, #FF5252, #FF7676);
         }
         
         .metamask-btn {
             background: linear-gradient(45deg, #F6851B, #FFA726);
         }
         
         .metamask-btn:hover:not(:disabled) {
             background: linear-gradient(45deg, #F57C00, #FF9800);
         }
         
         .connect-btn {
             background: #007bff;
             color: white;
             border: none;
             padding: 12px 24px;
             border-radius: 8px;
             font-size: 1.1rem;
             cursor: pointer;
             transition: all 0.3s ease;
         }
 
         .connect-btn:hover {
             background: #0056b3;
             transform: translateY(-2px);
         }
 
         .connect-btn:disabled {
             background: #6c757d;
             cursor: not-allowed;
             transform: none;
         }

        .wallet-info {
            margin-top: 15px;
            padding: 15px;
            background: #e9ecef;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.9rem;
        }

        .lottery-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .lottery-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .info-card h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .info-card p {
            font-size: 1.5rem;
            font-weight: bold;
            color: #007bff;
        }

        .lottery-btn {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            border: none;
            padding: 20px 40px;
            border-radius: 50px;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            display: block;
        }

        .lottery-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
        }

        .lottery-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .nft-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .nft-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .nft-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .nft-card h3 {
            text-align: center;
            margin-bottom: 15px;
            color: #333;
        }

        .nft-svg {
            width: 100%;
            height: 200px;
            border: 1px solid #eee;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .nft-info {
            font-size: 0.9rem;
            color: #666;
        }

        .nft-info p {
            margin-bottom: 8px;
        }

        .status {
            text-align: center;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            font-weight: bold;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .contract-info {
            background: #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            font-family: monospace;
            font-size: 0.9rem;
        }

        .contract-info h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .contract-info p {
            margin-bottom: 5px;
            word-break: break-all;
        }

        /* æ ‡ç­¾é¡µæ ·å¼ */
        .tabs-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .tabs-header {
            display: flex;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 30px;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: bold;
            color: #666;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            margin-right: 10px;
        }

        .tab-btn:hover {
            color: #007bff;
            background: #f8f9fa;
        }

        .tab-btn.active {
            color: #007bff;
            border-bottom-color: #007bff;
            background: #f8f9fa;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .my-nft-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

                 .nft-status {
             font-size: 0.9rem;
             color: #666;
             font-style: italic;
         }
         
         /* é’±åŒ…åˆ‡æ¢æ ·å¼ */
         .wallet-switch {
             margin-top: 15px;
             padding: 15px;
             background: #f8f9fa;
             border-radius: 8px;
             text-align: center;
         }
         
         .switch-btn {
             background: #6c757d;
             color: white;
             border: none;
             padding: 8px 16px;
             border-radius: 6px;
             font-size: 0.9rem;
             cursor: pointer;
             transition: all 0.3s ease;
             margin-right: 10px;
         }
         
         .switch-btn:hover {
             background: #5a6268;
             transform: translateY(-1px);
         }
         
         .switch-info {
             font-size: 0.9rem;
             color: #666;
             font-style: italic;
         }

        .network-status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }

        .network-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .network-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .network-status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ² è›‡å¸NFTçœŸå®æŠ½å¥–</h1>
            <p>è¿æ¥ LuckYou é’±åŒ…æˆ– MetaMaskï¼Œæ”¯ä»˜0.0001 ETHå‚ä¸çœŸå®æŠ½å¥–ï¼</p>
        </div>

                 <div class="wallet-section">
             <h2>ğŸ”— é’±åŒ…è¿æ¥</h2>
             <div class="wallet-buttons">
                 <button id="luckyouBtn" class="wallet-btn luckyou-btn" onclick="connectLuckYou()">
                     ğŸ€ è¿æ¥ LuckYou é’±åŒ…
                 </button>
                 <button id="metamaskBtn" class="wallet-btn metamask-btn" onclick="connectMetaMask()">
                     ğŸ¦Š è¿æ¥ MetaMask
                 </button>
             </div>
             <div id="walletSwitch" class="wallet-switch" style="display: none;">
                 <button id="switchWalletBtn" class="switch-btn" onclick="switchWallet()">
                     ğŸ”„ åˆ‡æ¢é’±åŒ…
                 </button>
                 <span class="switch-info">å½“å‰ä½¿ç”¨: <span id="currentWalletName">-</span></span>
             </div>
             <div id="walletInfo" class="wallet-info" style="display: none;">
                 <!-- é’±åŒ…ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
             </div>
         </div>

        <div class="lottery-section">
            <h2>ğŸ¯ æŠ½å¥–ä¿¡æ¯</h2>
            
            <div class="contract-info">
                <h3>ğŸ“‹ åˆçº¦ä¿¡æ¯</h3>
                <p><strong>åˆçº¦åœ°å€:</strong> <span id="contractAddress">æœªè¿æ¥</span></p>
                <p><strong>ç½‘ç»œ:</strong> <span id="networkInfo">æœªè¿æ¥</span></p>
                <div id="networkStatus" class="network-status" style="display: none;">
                    <p><strong>ç½‘ç»œçŠ¶æ€:</strong> <span id="networkStatusText">-</span></p>
                    <p id="networkSwitchTip" style="color: #ff6b6b; font-size: 14px; margin: 5px 0;"></p>
                </div>
            </div>

                         <div class="lottery-info">
                 <div class="info-card">
                     <h3>æŠ½å¥–ä»·æ ¼</h3>
                     <p id="lotteryPrice">0.0001 ETH</p>
                 </div>
                 <div class="info-card">
                     <h3>æ± å­å¤§å°</h3>
                     <p id="poolSize">-</p>
                 </div>
                 <div class="info-card">
                     <h3>å·²é“¸é€ </h3>
                     <p id="totalMinted">-</p>
                 </div>
                 <div class="info-card">
                     <h3>å‰©ä½™æ•°é‡</h3>
                     <p id="remainingSupply">-</p>
                 </div>
             </div>
             
             <div style="text-align: center; margin-bottom: 20px;">
                 <button id="refreshInfoBtn" class="connect-btn" onclick="refreshContractInfo()" style="margin: 0 10px;">
                     ğŸ”„ åˆ·æ–°åˆçº¦ä¿¡æ¯
                 </button>
                 <button id="preloadInfoBtn" class="connect-btn" onclick="preloadContractInfo()" style="margin: 0 10px;">
                     ğŸ“¡ é‡æ–°åŠ è½½
                 </button>
                 <button id="diagnoseBtn" class="connect-btn" onclick="diagnoseNetwork()" style="margin: 0 10px; background: #17a2b8;">
                     ğŸ” ç½‘ç»œè¯Šæ–­
                 </button>
             </div>

            <button id="lotteryBtn" class="lottery-btn" onclick="playLottery()" disabled>
                è¯·å…ˆè¿æ¥é’±åŒ…
            </button>

            <div id="statusDiv"></div>
        </div>

        <div class="tabs-section">
            <div class="tabs-header">
                <button class="tab-btn active" onclick="switchTab('latest')" id="latestTab">
                    ğŸ‰ æœ€æ–°æŠ½ä¸­çš„NFT
                </button>
                <button class="tab-btn" onclick="switchTab('my')" id="myTab">
                    ğŸ–¼ï¸ æˆ‘çš„NFT
                </button>
            </div>
            
            <div class="tab-content active" id="latestTabContent">
                <div class="nft-grid" id="nftGrid">
                    <!-- æŠ½ä¸­çš„NFTå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
            
            <div class="tab-content" id="myTabContent">
                <div class="my-nft-controls">
                    <button id="refreshNftBtn" class="connect-btn" onclick="loadUserNFTs()">
                        ğŸ”„ åˆ·æ–°æˆ‘çš„NFT
                    </button>
                    <div id="myNftStatus" class="nft-status"></div>
                </div>
                <div class="nft-grid" id="myNftGrid">
                    <!-- ç”¨æˆ·æ‹¥æœ‰çš„NFTå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // åˆçº¦é…ç½®
        const CONTRACT_ADDRESS = "0xa513E6E4b8f2a923D98304ec87F64353C4D5C853";
        const CONTRACT_ABI = [
            {
                "constant": true,
                "inputs": [],
                "name": "lotteryPrice",
                "outputs": [{"name": "", "type": "uint256"}],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "getPoolSize",
                "outputs": [{"name": "", "type": "uint256"}],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "totalSupply",
                "outputs": [{"name": "", "type": "uint256"}],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },

            {
                "constant": false,
                "inputs": [],
                "name": "playLottery",
                "outputs": [],
                "payable": true,
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [{"name": "tokenId", "type": "uint256"}],
                "name": "generateSnakeSVG",
                "outputs": [{"name": "", "type": "string"}],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [{"name": "tokenId", "type": "uint256"}],
                "name": "ownerOf",
                "outputs": [{"name": "", "type": "address"}],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [{"name": "tokenId", "type": "uint256"}],
                "name": "tokenURI",
                "outputs": [{"name": "", "type": "string"}],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "getLotteryInfo",
                "outputs": [
                    {"name": "price", "type": "uint256"},
                    {"name": "poolSize", "type": "uint256"},
                    {"name": "totalMinted", "type": "uint256"},
                    {"name": "remaining", "type": "uint256"}
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "anonymous": false,
                "inputs": [
                    {"indexed": true, "name": "winner", "type": "address"},
                    {"indexed": true, "name": "tokenId", "type": "uint256"},
                    {"indexed": false, "name": "price", "type": "uint256"}
                ],
                "name": "LotteryWon",
                "type": "event"
            }
        ];

                 let web3;
         let contract;
         let userAccount;
         let userBalance;
         let currentWalletProvider;
         let currentWalletName;

        // é¢œè‰²å’Œè·¯å¾„é…ç½®
        const colors = [
            "#FF6B6B", "#4ECDC4", "#45B7D1", "#96CEB4", "#FFEAA7",
            "#DDA0DD", "#FFB347", "#87CEEB", "#98FB98", "#F0E68C"
        ];

        const snakePaths = [
            "M10,10 Q20,5 30,10 T50,10",
            "M10,10 C20,5 30,15 50,10",
            "M10,10 L30,5 L50,10",
            "M10,10 Q30,5 50,10",
            "M10,10 Q25,5 40,10 Q55,15 70,10",
            "M10,10 C15,5 25,15 35,10 C45,5 55,15 65,10",
            "M10,10 L20,5 L30,10 L40,5 L50,10",
            "M10,10 Q20,5 30,10 Q40,15 50,10",
            "M10,10 C20,5 30,15 40,10 C50,5 60,15 70,10",
            "M10,10 Q15,5 20,10 Q25,15 30,10 Q35,5 40,10 Q45,15 50,10"
        ];

                 // æ–­å¼€è¿æ¥
         function disconnectWallet() {
             const luckyouBtn = document.getElementById('luckyouBtn');
             const metamaskBtn = document.getElementById('metamaskBtn');
             const walletInfo = document.getElementById('walletInfo');
             const lotteryBtn = document.getElementById('lotteryBtn');
             
             // é‡ç½®çŠ¶æ€
             userAccount = null;
             userBalance = null;
             web3 = null;
             contract = null;
             currentWalletProvider = null;
             currentWalletName = null;
             
             // æ›´æ–°UI
             walletInfo.style.display = 'none';
             lotteryBtn.disabled = true;
             lotteryBtn.innerHTML = 'è¯·å…ˆè¿æ¥é’±åŒ…';
             
             // é‡ç½®æŒ‰é’®çŠ¶æ€
             luckyouBtn.disabled = false;
             metamaskBtn.disabled = false;
             luckyouBtn.innerHTML = 'ğŸ€ è¿æ¥ LuckYou é’±åŒ…';
             metamaskBtn.innerHTML = 'ğŸ¦Š è¿æ¥ MetaMask';
             luckyouBtn.style.background = 'linear-gradient(45deg, #FF6B6B, #FF8E8E)';
             metamaskBtn.style.background = 'linear-gradient(45deg, #F6851B, #FFA726)';
             luckyouBtn.onclick = connectLuckYou;
             metamaskBtn.onclick = connectMetaMask;
             
             // éšè—é’±åŒ…åˆ‡æ¢é€‰é¡¹
             document.getElementById('walletSwitch').style.display = 'none';
             
             // éšè—ç½‘ç»œçŠ¶æ€æ˜¾ç¤º
             updateNetworkStatus(null, null, false);
             
             showStatus('ğŸ”Œ é’±åŒ…å·²æ–­å¼€è¿æ¥', 'info');
         }

                         // è¿æ¥ LuckYou é’±åŒ…
         async function connectLuckYou() {
             const luckyouBtn = document.getElementById('luckyouBtn');
             const metamaskBtn = document.getElementById('metamaskBtn');
             const walletInfo = document.getElementById('walletInfo');
             
             try {
                 // ç¦ç”¨ä¸¤ä¸ªæŒ‰é’®
                 luckyouBtn.disabled = true;
                 metamaskBtn.disabled = true;
                 luckyouBtn.innerHTML = '<span class="spinner"></span> è¿æ¥ä¸­...';
                 
                 let walletProvider;
                 let walletName = 'LuckYou Wallet';
                 
                 // æ£€æµ‹ LuckYou é’±åŒ…
                 if (typeof window.luckYou !== 'undefined') {
                     walletProvider = window.luckYou;
                     console.log('ä½¿ç”¨ä¸»è¦ LuckYou é’±åŒ…å¯¹è±¡');
                 } else if (window.luckyouWallet && window.luckyouWallet.isLuckYouWallet) {
                     walletProvider = window.luckyouWallet;
                     console.log('ä½¿ç”¨æ›¿ä»£ LuckYou é’±åŒ…å¯¹è±¡');
                 } else {
                     throw new Error('æœªæ£€æµ‹åˆ° LuckYou é’±åŒ…ï¼Œè¯·å®‰è£… LuckYou é’±åŒ…æ‰©å±•ï¼');
                 }
                 
                 // ä¿å­˜å½“å‰é’±åŒ…ä¿¡æ¯
                 currentWalletProvider = walletProvider;
                 currentWalletName = walletName;
                 
                 console.log('LuckYou é’±åŒ…æä¾›è€…:', walletProvider);
                 console.log('é’±åŒ…æä¾›è€…ç±»å‹:', typeof walletProvider);
                 console.log('é’±åŒ…æä¾›è€…æ–¹æ³•:', Object.getOwnPropertyNames(walletProvider));
                 
                 // è¯·æ±‚è´¦æˆ·è¿æ¥
                 const accounts = await walletProvider.request({
                     method: 'eth_requestAccounts'
                 });
 
                 userAccount = accounts[0];
                 console.log('LuckYou é’±åŒ…è´¦æˆ·åœ°å€:', userAccount);
                 
                 // æ£€æŸ¥ç½‘ç»œ
                 let chainId;
                 let networkName;
                 try {
                     chainId = await walletProvider.request({ method: 'eth_chainId' });
                     networkName = getNetworkName(chainId);
                     console.log('LuckYou é’±åŒ…ç½‘ç»œ Chain ID:', chainId);
                     console.log('LuckYou é’±åŒ…ç½‘ç»œåç§°:', networkName);
                     
                     // æ£€æŸ¥ç½‘ç»œæ˜¯å¦åŒ¹é…
                     if (chainId !== '0x539' && chainId !== '0x31337' && chainId !== '0x7a69') {
                         showStatus('âš ï¸ å½“å‰ç½‘ç»œä¸åŒ¹é…ï¼Œè¯·åˆ‡æ¢åˆ°æœ¬åœ° Hardhat ç½‘ç»œ', 'warning');
                         console.warn('ç½‘ç»œä¸åŒ¹é…ï¼Œåˆçº¦åœ°å€ä»…é€‚ç”¨äºæœ¬åœ° Hardhat ç½‘ç»œ');
                         
                         // å°è¯•åˆ‡æ¢åˆ°æ­£ç¡®çš„ç½‘ç»œ
                         try {
                             await walletProvider.request({
                                 method: 'wallet_switchEthereumChain',
                                 params: [{ chainId: '0x7a69' }]
                             });
                             console.log('å·²åˆ‡æ¢åˆ° Hardhat ç½‘ç»œ');
                             chainId = '0x7a69';
                             networkName = 'Hardhat Local Network';
                         } catch (switchError) {
                             console.warn('ç½‘ç»œåˆ‡æ¢å¤±è´¥:', switchError);
                             showStatus('âŒ è¯·æ‰‹åŠ¨åˆ‡æ¢åˆ°æœ¬åœ° Hardhat ç½‘ç»œ (Chain ID: 31337 æˆ– 1337)', 'error');
                             
                             // é‡ç½®æŒ‰é’®çŠ¶æ€
                             luckyouBtn.disabled = false;
                             metamaskBtn.disabled = false;
                             metamaskBtn.innerHTML = 'è¿æ¥ MetaMask';
                             return;
                         }
                     }
                 } catch (networkError) {
                     console.error('è·å–ç½‘ç»œä¿¡æ¯å¤±è´¥:', networkError);
                     chainId = '0x539';
                     networkName = 'Hardhat Local Network';
                 }
                 
                 // åˆå§‹åŒ–Web3å’Œåˆçº¦
                 try {
                     web3 = new Web3(walletProvider);
                     console.log('Web3 åˆå§‹åŒ–æˆåŠŸ');
                     
                     contract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
                     console.log('åˆçº¦å®ä¾‹åˆ›å»ºæˆåŠŸï¼Œåœ°å€:', CONTRACT_ADDRESS);
                     
                     // éªŒè¯åˆçº¦æ˜¯å¦å·²éƒ¨ç½²
                     try {
                         const code = await web3.eth.getCode(CONTRACT_ADDRESS);
                         console.log('åˆçº¦ä»£ç é•¿åº¦:', code.length);
                         if (code === '0x' || code === '0x0') {
                             throw new Error('åˆçº¦åœ°å€ä¸Šæ²¡æœ‰ä»£ç ï¼Œè¯·æ£€æŸ¥åˆçº¦æ˜¯å¦å·²éƒ¨ç½²');
                         }
                         console.log('åˆçº¦ä»£ç éªŒè¯æˆåŠŸ');
                     } catch (codeError) {
                         console.error('åˆçº¦ä»£ç éªŒè¯å¤±è´¥:', codeError);
                         throw new Error('åˆçº¦æœªéƒ¨ç½²æˆ–åœ°å€é”™è¯¯');
                     }
                     
                     // æµ‹è¯•åˆçº¦è°ƒç”¨
                     try {
                         console.log('æµ‹è¯• LuckYou é’±åŒ…åˆçº¦è°ƒç”¨...');
                         const testPrice = await contract.methods.lotteryPrice().call();
                         console.log('LuckYou é’±åŒ…æµ‹è¯•è°ƒç”¨æˆåŠŸï¼ŒæŠ½å¥–ä»·æ ¼:', testPrice);
                     } catch (testError) {
                         console.error('LuckYou é’±åŒ…æµ‹è¯•è°ƒç”¨å¤±è´¥:', testError);
                         console.warn('è¿™å¯èƒ½æ˜¯ç½‘ç»œæˆ–æƒé™é—®é¢˜');
                     }
                     
                     // è·å–ç”¨æˆ·ä½™é¢
                     try {
                         // ç›´æ¥ä½¿ç”¨é’±åŒ…æä¾›è€…è·å–ä½™é¢ï¼Œé¿å… Web3.js çš„è‡ªåŠ¨è½¬æ¢
                         const balanceResult = await walletProvider.request({
                             method: 'eth_getBalance',
                             params: [userAccount, 'latest']
                         });
                         
                         console.log('åŸå§‹ä½™é¢ç»“æœ:', balanceResult, 'ç±»å‹:', typeof balanceResult);
                         
                         // æ£€æŸ¥è¿”å›ç»“æœæ˜¯å¦ä¸ºæœ‰æ•ˆæ•°å­—
                         if (balanceResult && typeof balanceResult === 'string') {
                             if (balanceResult.match(/^0x[0-9a-fA-F]+$/)) {
                                 // åå…­è¿›åˆ¶æ ¼å¼
                                 userBalance = balanceResult;
                                 console.log('ç”¨æˆ·ä½™é¢(åå…­è¿›åˆ¶):', userBalance);
                             } else if (balanceResult.match(/^\d+$/)) {
                                 // åè¿›åˆ¶æ ¼å¼ï¼Œè½¬æ¢ä¸ºåå…­è¿›åˆ¶
                                 userBalance = '0x' + BigInt(balanceResult).toString(16);
                                 console.log('ç”¨æˆ·ä½™é¢(åè¿›åˆ¶è½¬åå…­è¿›åˆ¶):', userBalance);
                             } else {
                                 console.warn('ä½™é¢è¿”å›æ ¼å¼å¼‚å¸¸:', balanceResult);
                                 userBalance = '0';
                             }
                         } else if (balanceResult && typeof balanceResult === 'object' && balanceResult.error) {
                             // å¤„ç†é”™è¯¯å¯¹è±¡
                             console.warn('ä½™é¢è¿”å›é”™è¯¯å¯¹è±¡:', balanceResult.error);
                             console.warn('RPC è°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ä½™é¢ 0');
                             userBalance = '0';
                         } else {
                             console.warn('ä½™é¢è¿”å›ç±»å‹å¼‚å¸¸:', typeof balanceResult, balanceResult);
                             userBalance = '0';
                         }
                     } catch (balanceError) {
                         console.error('è·å–ä½™é¢å¤±è´¥:', balanceError);
                         console.warn('ä½¿ç”¨é»˜è®¤ä½™é¢ 0');
                         userBalance = '0';
                     }
                 } catch (web3Error) {
                     console.error('Web3åˆå§‹åŒ–å¤±è´¥:', web3Error);
                     throw new Error('Web3åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                 }
                 
                 // æ›´æ–°UI
                 updateWalletInfo(userAccount, userBalance, networkName, walletName);
                 updateLotteryInfo();
                 enableLottery();
                 
                 // æ›´æ–°æŒ‰é’®çŠ¶æ€
                 luckyouBtn.innerHTML = 'æ–­å¼€è¿æ¥';
                 luckyouBtn.style.background = '#28a745';
                 luckyouBtn.onclick = disconnectWallet;
                 
                 // æ˜¾ç¤ºé’±åŒ…åˆ‡æ¢é€‰é¡¹
                 document.getElementById('walletSwitch').style.display = 'block';
                 document.getElementById('currentWalletName').textContent = walletName;
                 
                 showStatus(`âœ… ${walletName} é’±åŒ…è¿æ¥æˆåŠŸï¼`, 'success');
                 
             } catch (error) {
                 console.error('LuckYou è¿æ¥å¤±è´¥:', error);
                 showStatus(`âŒ LuckYou è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                 
                 // æ¢å¤æŒ‰é’®çŠ¶æ€
                 luckyouBtn.disabled = false;
                 metamaskBtn.disabled = false;
                 luckyouBtn.innerHTML = 'ğŸ€ è¿æ¥ LuckYou é’±åŒ…';
                 luckyouBtn.style.background = 'linear-gradient(45deg, #FF6B6B, #FF8E8E)';
                 luckyouBtn.onclick = connectLuckYou;
             }
         }
         
         // è¿æ¥ MetaMask é’±åŒ…
         async function connectMetaMask() {
             const luckyouBtn = document.getElementById('luckyouBtn');
             const metamaskBtn = document.getElementById('metamaskBtn');
             const walletInfo = document.getElementById('walletInfo');
             
             try {
                 // ç¦ç”¨ä¸¤ä¸ªæŒ‰é’®
                 luckyouBtn.disabled = true;
                 metamaskBtn.disabled = true;
                 metamaskBtn.innerHTML = '<span class="spinner"></span> è¿æ¥ä¸­...';
                 
                 let walletProvider;
                 let walletName = 'MetaMask';
                 
                 // æ£€æµ‹ MetaMask
                 if (typeof window.ethereum !== 'undefined' && window.ethereum.isMetaMask) {
                     walletProvider = window.ethereum;
                     console.log('ä½¿ç”¨ MetaMask é’±åŒ…');
                 } else {
                     throw new Error('æœªæ£€æµ‹åˆ° MetaMaskï¼Œè¯·å®‰è£… MetaMask æ‰©å±•ï¼');
                 }
                 
                 // ä¿å­˜å½“å‰é’±åŒ…ä¿¡æ¯
                 currentWalletProvider = walletProvider;
                 currentWalletName = walletName;
                 
                 console.log('MetaMask é’±åŒ…æä¾›è€…:', walletProvider);
                 console.log('é’±åŒ…æä¾›è€…ç±»å‹:', typeof walletProvider);
                 console.log('é’±åŒ…æä¾›è€…æ–¹æ³•:', Object.getOwnPropertyNames(walletProvider));
                 
                 // è¯·æ±‚è´¦æˆ·è¿æ¥
                 const accounts = await walletProvider.request({
                     method: 'eth_requestAccounts'
                 });
 
                 userAccount = accounts[0];
                 console.log('MetaMask é’±åŒ…è´¦æˆ·åœ°å€:', userAccount);
                 
                 // æ£€æŸ¥ç½‘ç»œ
                 let chainId;
                 let networkName;
                 try {
                     chainId = await walletProvider.request({ method: 'eth_chainId' });
                     networkName = getNetworkName(chainId);
                     console.log('MetaMask é’±åŒ…ç½‘ç»œ Chain ID:', chainId);
                     console.log('MetaMask é’±åŒ…ç½‘ç»œåç§°:', networkName);
                     
                     // æ£€æŸ¥ç½‘ç»œæ˜¯å¦åŒ¹é…
                     if (chainId !== '0x539' && chainId !== '0x31337' && chainId !== '0x7a69') {
                         showStatus('âš ï¸ å½“å‰ç½‘ç»œä¸åŒ¹é…ï¼Œè¯·åˆ‡æ¢åˆ°æœ¬åœ° Hardhat ç½‘ç»œ', 'warning');
                         console.warn('ç½‘ç»œä¸åŒ¹é…ï¼Œåˆçº¦åœ°å€ä»…é€‚ç”¨äºæœ¬åœ° Hardhat ç½‘ç»œ');
                         
                         // å°è¯•åˆ‡æ¢åˆ°æ­£ç¡®çš„ç½‘ç»œ
                         try {
                             await walletProvider.request({
                                 method: 'wallet_switchEthereumChain',
                                 params: [{ chainId: '0x7a69' }]
                             });
                             console.log('å·²åˆ‡æ¢åˆ° Hardhat ç½‘ç»œ');
                             chainId = '0x7a69';
                             networkName = 'Hardhat Local Network';
                         } catch (switchError) {
                             console.warn('ç½‘ç»œåˆ‡æ¢å¤±è´¥:', switchError);
                             showStatus('âŒ è¯·æ‰‹åŠ¨åˆ‡æ¢åˆ°æœ¬åœ° Hardhat ç½‘ç»œ (Chain ID: 31337 æˆ– 1337)', 'error');
                             
                             // é‡ç½®æŒ‰é’®çŠ¶æ€
                             luckyouBtn.disabled = false;
                             metamaskBtn.disabled = false;
                             metamaskBtn.innerHTML = 'è¿æ¥ MetaMask';
                             return;
                         }
                     }
                 } catch (networkError) {
                     console.error('è·å–ç½‘ç»œä¿¡æ¯å¤±è´¥:', networkError);
                     chainId = '0x539';
                     networkName = 'Hardhat Local Network';
                 }
                 
                 // åˆå§‹åŒ–Web3å’Œåˆçº¦
                 try {
                     web3 = new Web3(walletProvider);
                     console.log('Web3 åˆå§‹åŒ–æˆåŠŸ');
                     
                     contract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
                     console.log('åˆçº¦å®ä¾‹åˆ›å»ºæˆåŠŸï¼Œåœ°å€:', CONTRACT_ADDRESS);
                     
                     // éªŒè¯åˆçº¦æ˜¯å¦å·²éƒ¨ç½²
                     try {
                         const code = await web3.eth.getCode(CONTRACT_ADDRESS);
                         console.log('åˆçº¦ä»£ç é•¿åº¦:', code.length);
                         if (code === '0x' || code === '0x0') {
                             throw new Error('åˆçº¦åœ°å€ä¸Šæ²¡æœ‰ä»£ç ï¼Œè¯·æ£€æŸ¥åˆçº¦æ˜¯å¦å·²éƒ¨ç½²');
                         }
                         console.log('åˆçº¦ä»£ç éªŒè¯æˆåŠŸ');
                     } catch (codeError) {
                         console.error('åˆçº¦ä»£ç éªŒè¯å¤±è´¥:', codeError);
                         throw new Error('åˆçº¦æœªéƒ¨ç½²æˆ–åœ°å€é”™è¯¯');
                     }
                     
                     // æµ‹è¯•åˆçº¦è°ƒç”¨
                     try {
                         console.log('æµ‹è¯• MetaMask é’±åŒ…åˆçº¦è°ƒç”¨...');
                         const testPrice = await contract.methods.lotteryPrice().call();
                         console.log('MetaMask é’±åŒ…æµ‹è¯•è°ƒç”¨æˆåŠŸï¼ŒæŠ½å¥–ä»·æ ¼:', testPrice);
                     } catch (testError) {
                         console.error('MetaMask é’±åŒ…æµ‹è¯•è°ƒç”¨å¤±è´¥:', testError);
                         console.warn('è¿™å¯èƒ½æ˜¯ç½‘ç»œæˆ–æƒé™é—®é¢˜');
                     }
                     
                     // è·å–ç”¨æˆ·ä½™é¢
                     try {
                         // ç›´æ¥ä½¿ç”¨é’±åŒ…æä¾›è€…è·å–ä½™é¢ï¼Œé¿å… Web3.js çš„è‡ªåŠ¨è½¬æ¢
                         const balanceResult = await walletProvider.request({
                             method: 'eth_getBalance',
                             params: [userAccount, 'latest']
                         });
                         
                         console.log('åŸå§‹ä½™é¢ç»“æœ:', balanceResult, 'ç±»å‹:', typeof balanceResult);
                         
                         // æ£€æŸ¥è¿”å›ç»“æœæ˜¯å¦ä¸ºæœ‰æ•ˆæ•°å­—
                         if (balanceResult && typeof balanceResult === 'string') {
                             if (balanceResult.match(/^0x[0-9a-fA-F]+$/)) {
                                 // åå…­è¿›åˆ¶æ ¼å¼
                                 userBalance = balanceResult;
                                 console.log('ç”¨æˆ·ä½™é¢(åå…­è¿›åˆ¶):', userBalance);
                             } else if (balanceResult.match(/^\d+$/)) {
                                 // åè¿›åˆ¶æ ¼å¼ï¼Œè½¬æ¢ä¸ºåå…­è¿›åˆ¶
                                 userBalance = '0x' + BigInt(balanceResult).toString(16);
                                 console.log('ç”¨æˆ·ä½™é¢(åè¿›åˆ¶è½¬åå…­è¿›åˆ¶):', userBalance);
                             } else {
                                 console.warn('ä½™é¢è¿”å›æ ¼å¼å¼‚å¸¸:', balanceResult);
                                 userBalance = '0';
                             }
                         } else if (balanceResult && typeof balanceResult === 'object' && balanceResult.error) {
                             // å¤„ç†é”™è¯¯å¯¹è±¡
                             console.warn('ä½™é¢è¿”å›é”™è¯¯å¯¹è±¡:', balanceResult.error);
                             console.warn('RPC è°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ä½™é¢ 0');
                             userBalance = '0';
                         } else {
                             console.warn('ä½™é¢è¿”å›ç±»å‹å¼‚å¸¸:', typeof balanceResult, balanceResult);
                             userBalance = '0';
                         }
                     } catch (balanceError) {
                         console.error('è·å–ä½™é¢å¤±è´¥:', balanceError);
                         console.warn('ä½¿ç”¨é»˜è®¤ä½™é¢ 0');
                         userBalance = '0';
                     }
                 } catch (web3Error) {
                     console.error('Web3åˆå§‹åŒ–å¤±è´¥:', web3Error);
                     throw new Error('Web3åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                 }
                 
                 // æ›´æ–°UI
                 updateWalletInfo(userAccount, userBalance, networkName, walletName);
                 updateLotteryInfo();
                 enableLottery();
                 
                 // æ›´æ–°æŒ‰é’®çŠ¶æ€
                 metamaskBtn.innerHTML = 'æ–­å¼€è¿æ¥';
                 metamaskBtn.style.background = '#28a745';
                 metamaskBtn.onclick = disconnectWallet;
                 
                 // æ˜¾ç¤ºé’±åŒ…åˆ‡æ¢é€‰é¡¹
                 document.getElementById('walletSwitch').style.display = 'block';
                 document.getElementById('currentWalletName').textContent = walletName;
                 
                 showStatus(`âœ… ${walletName} é’±åŒ…è¿æ¥æˆåŠŸï¼`, 'success');
                 
             } catch (error) {
                 console.error('MetaMask è¿æ¥å¤±è´¥:', error);
                 showStatus(`âŒ MetaMask è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                 
                 // æ¢å¤æŒ‰é’®çŠ¶æ€
                 luckyouBtn.disabled = false;
                 metamaskBtn.disabled = false;
                 metamaskBtn.innerHTML = 'ğŸ¦Š è¿æ¥ MetaMask';
                 metamaskBtn.style.background = 'linear-gradient(45deg, #F6851B, #FFA726)';
                 metamaskBtn.onclick = connectMetaMask;
             }
         }

        // æ›´æ–°é’±åŒ…ä¿¡æ¯
        function updateWalletInfo(account, balance, network, walletName) {
            const walletInfo = document.getElementById('walletInfo');
            const contractAddress = document.getElementById('contractAddress');
            const networkInfo = document.getElementById('networkInfo');
            
            walletInfo.style.display = 'block';
            
            // å®‰å…¨åœ°è½¬æ¢ä½™é¢æ˜¾ç¤º
            let balanceDisplay = '0 ETH';
            try {
                if (balance && typeof balance === 'string') {
                    if (balance.match(/^0x[0-9a-fA-F]+$/)) {
                        // åå…­è¿›åˆ¶æ ¼å¼
                        balanceDisplay = `${web3.utils.fromWei(balance, 'ether')} ETH`;
                    } else if (balance.match(/^\d+$/)) {
                        // åè¿›åˆ¶æ ¼å¼
                        balanceDisplay = `${web3.utils.fromWei(balance, 'wei')} ETH`;
                    } else {
                        console.warn('ä½™é¢æ ¼å¼æ— æ³•è¯†åˆ«:', balance);
                        balanceDisplay = '0 ETH';
                    }
                } else {
                    console.warn('ä½™é¢ç±»å‹å¼‚å¸¸:', typeof balance, balance);
                    balanceDisplay = '0 ETH';
                }
            } catch (error) {
                console.error('ä½™é¢è½¬æ¢å¤±è´¥:', error);
                balanceDisplay = '0 ETH';
            }
            
            walletInfo.innerHTML = `
                <p><strong>é’±åŒ…ç±»å‹:</strong> ${walletName}</p>
                <p><strong>è´¦æˆ·åœ°å€:</strong> ${account}</p>
                <p><strong>è´¦æˆ·ä½™é¢:</strong> ${balanceDisplay}</p>
                <p><strong>ç½‘ç»œ:</strong> ${network}</p>
            `;
            
            contractAddress.textContent = CONTRACT_ADDRESS;
            networkInfo.textContent = network;
            
            // æ›´æ–°ç½‘ç»œçŠ¶æ€æ˜¾ç¤º
            const chainId = getChainIdFromNetwork(network);
            updateNetworkStatus(chainId, network, true);
        }
        
        // ä»ç½‘ç»œåç§°è·å– Chain ID
        function getChainIdFromNetwork(network) {
            if (network === 'Hardhat Local Network') {
                return '0x7a69'; // ä½¿ç”¨å½“å‰ MetaMask è¿æ¥çš„ Chain ID
            }
            // è¿™é‡Œå¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ æ›´å¤šç½‘ç»œæ˜ å°„
            return '0x1'; // é»˜è®¤è¿”å›ä¸»ç½‘
        }

        // è·å–ç½‘ç»œåç§°
        function getNetworkName(chainId) {
            const networks = {
                '0x1': 'Ethereum Mainnet',
                '0x3': 'Ropsten Testnet',
                '0x4': 'Rinkeby Testnet',
                '0x5': 'Goerli Testnet',
                '0x2a': 'Kovan Testnet',
                '0x7a69': 'Hardhat Local Network',
                '0x539': 'Hardhat Local Network'
            };
            return networks[chainId] || `Chain ID: ${chainId}`;
        }

        // å¯ç”¨æŠ½å¥–
        function enableLottery() {
            const lotteryBtn = document.getElementById('lotteryBtn');
            lotteryBtn.disabled = false;
            lotteryBtn.innerHTML = 'ğŸ² å¼€å§‹æŠ½å¥– (0.0001 ETH)';
        }
        
        // æ£€æŸ¥åˆçº¦çŠ¶æ€
        async function checkContractStatus() {
            if (!contract) {
                console.log('åˆçº¦æœªåˆå§‹åŒ–');
                return false;
            }
            
            try {
                // å°è¯•è°ƒç”¨ä¸€ä¸ªç®€å•çš„viewå‡½æ•°æ¥æ£€æŸ¥åˆçº¦çŠ¶æ€
                const price = await contract.methods.lotteryPrice().call();
                console.log('åˆçº¦çŠ¶æ€æ­£å¸¸ï¼ŒæŠ½å¥–ä»·æ ¼:', price);
                return true;
            } catch (error) {
                console.error('åˆçº¦çŠ¶æ€æ£€æŸ¥å¤±è´¥:', error);
                showStatus('âš ï¸ åˆçº¦çŠ¶æ€å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
                return false;
            }
        }

                 // æ›´æ–°æŠ½å¥–ä¿¡æ¯
         async function updateLotteryInfo() {
             if (!contract) {
                 console.log('åˆçº¦æœªåˆå§‹åŒ–ï¼Œè·³è¿‡æ›´æ–°æŠ½å¥–ä¿¡æ¯');
                 return;
             }
             
             try {
                 console.log('å¼€å§‹è·å–å®æ—¶æŠ½å¥–ä¿¡æ¯...');
                 
                 // åˆ†åˆ«è·å–å„ä¸ªä¿¡æ¯ï¼Œé¿å…ä¸€æ¬¡æ€§è°ƒç”¨å¯èƒ½å‡ºé”™
                 let price, poolSize, totalMinted, remaining;
                 
                 try {
                     price = await contract.methods.lotteryPrice().call();
                     console.log('å®æ—¶æŠ½å¥–ä»·æ ¼:', price);
                     // éªŒè¯è¿”å›çš„æ•°æ®æ ¼å¼
                     if (price && typeof price === 'object' && price.error) {
                         console.warn('æŠ½å¥–ä»·æ ¼è¿”å›é”™è¯¯å¯¹è±¡:', price.error);
                         price = '0';
                     }
                 } catch (priceError) {
                     console.error('è·å–æŠ½å¥–ä»·æ ¼å¤±è´¥:', priceError);
                     price = '0';
                 }
                 
                 try {
                     poolSize = await contract.methods.getPoolSize().call();
                     console.log('å®æ—¶æ± å­å¤§å°:', poolSize);
                     // éªŒè¯è¿”å›çš„æ•°æ®æ ¼å¼
                     if (poolSize && typeof poolSize === 'object' && poolSize.error) {
                         console.warn('æ± å­å¤§å°è¿”å›é”™è¯¯å¯¹è±¡:', poolSize.error);
                         poolSize = '0';
                     }
                 } catch (poolError) {
                     console.error('è·å–æ± å­å¤§å°å¤±è´¥:', poolError);
                     poolSize = '0';
                 }
                 
                 try {
                     totalMinted = await contract.methods.totalSupply().call();
                     console.log('å®æ—¶å·²é“¸é€ æ•°é‡:', totalMinted);
                     // éªŒè¯è¿”å›çš„æ•°æ®æ ¼å¼
                     if (totalMinted && typeof totalMinted === 'object' && totalMinted.error) {
                         console.warn('å·²é“¸é€ æ•°é‡è¿”å›é”™è¯¯å¯¹è±¡:', totalMinted.error);
                         totalMinted = '0';
                     }
                 } catch (mintedError) {
                     console.error('è·å–å·²é“¸é€ æ•°é‡å¤±è´¥:', mintedError);
                     totalMinted = '0';
                 }
                
                 // è®¡ç®—å‰©ä½™æ•°é‡
                 try {
                     const maxSupply = 1000; // åˆçº¦ä¸­çš„MAX_SUPPLY
                     remaining = maxSupply - parseInt(totalMinted || 0);
                     console.log('å®æ—¶å‰©ä½™æ•°é‡:', remaining);
                 } catch (remainingError) {
                     console.error('è®¡ç®—å‰©ä½™æ•°é‡å¤±è´¥:', remainingError);
                     remaining = '0';
                 }
                 
                 // æ›´æ–°UI
                 try {
                     console.log('å‡†å¤‡æ›´æ–°UIï¼Œæ•°æ®:', { price, poolSize, totalMinted, remaining });
                     
                     // ç¡®ä¿æ•°æ®æ˜¯æœ‰æ•ˆçš„å­—ç¬¦ä¸²æˆ–æ•°å­—
                     const safePrice = (price && typeof price === 'string' && price.match(/^\d+$/)) ? price : '0';
                     const safePoolSize = (poolSize && typeof poolSize === 'string' && poolSize.match(/^\d+$/)) ? poolSize : '0';
                     const safeTotalMinted = (totalMinted && typeof totalMinted === 'string' && totalMinted.match(/^\d+$/)) ? totalMinted : '0';
                     const safeRemaining = (remaining && typeof remaining === 'number') ? remaining : 0;
                     
                     console.log('å®‰å…¨å¤„ç†åçš„æ•°æ®:', { safePrice, safePoolSize, safeTotalMinted, safeRemaining });
                     
                     const priceInEth = web3.utils.fromWei(safePrice, 'ether');
                     document.getElementById('lotteryPrice').textContent = `${priceInEth} ETH`;
                     document.getElementById('poolSize').textContent = safePoolSize;
                     document.getElementById('totalMinted').textContent = safeTotalMinted;
                     document.getElementById('remainingSupply').textContent = safeRemaining.toString();
                     
                     console.log('å®æ—¶æŠ½å¥–ä¿¡æ¯æ›´æ–°æˆåŠŸ');
                     showStatus('ğŸ”„ æŠ½å¥–ä¿¡æ¯å·²æ›´æ–°', 'info');
                     
                 } catch (uiError) {
                     console.error('æ›´æ–°UIå¤±è´¥:', uiError);
                     console.error('é”™è¯¯è¯¦æƒ…:', uiError.message, uiError.stack);
                 }
                
             } catch (error) {
                 console.error('è·å–æŠ½å¥–ä¿¡æ¯å¤±è´¥:', error);
                 showStatus('âš ï¸ æ— æ³•è·å–å®æ—¶æŠ½å¥–ä¿¡æ¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'info');
             }
         }

        // çœŸå®æŠ½å¥–
        async function playLottery() {
            if (!contract || !userAccount) {
                showStatus('âŒ è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
                return;
            }
            
            // æ£€æŸ¥åˆçº¦çŠ¶æ€
            const contractStatus = await checkContractStatus();
            if (!contractStatus) {
                showStatus('âŒ åˆçº¦çŠ¶æ€å¼‚å¸¸ï¼Œæ— æ³•æŠ½å¥–', 'error');
                return;
            }

            const lotteryBtn = document.getElementById('lotteryBtn');
            const originalText = lotteryBtn.innerHTML;
            
            try {
                // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                lotteryBtn.disabled = true;
                lotteryBtn.innerHTML = '<span class="spinner"></span> æŠ½å¥–ä¸­...';
                
                // è·å–æŠ½å¥–ä»·æ ¼
                const price = await contract.methods.lotteryPrice().call();
                
                                 // æ£€æŸ¥ç”¨æˆ·ä½™é¢ - æ·»åŠ é”™è¯¯å¤„ç†
                 try {
                     const userBalanceBN = web3.utils.toBN(userBalance || '0');
                     const priceBN = web3.utils.toBN(price || '0');
                     
                     if (userBalanceBN.lt(priceBN)) {
                         throw new Error('ä½™é¢ä¸è¶³ï¼Œæ— æ³•æ”¯ä»˜æŠ½å¥–è´¹ç”¨');
                     }
                 } catch (balanceError) {
                     console.error('ä½™é¢æ£€æŸ¥å¤±è´¥:', balanceError);
                     throw new Error('ä½™é¢æ£€æŸ¥å¤±è´¥ï¼Œè¯·é‡è¯•');
                 }
                
                                 // æ‰§è¡ŒæŠ½å¥–äº¤æ˜“ - æ·»åŠ é‡è¯•æœºåˆ¶
                 let result;
                 let retryCount = 0;
                 const maxRetries = 3;
                 
                 while (retryCount < maxRetries) {
                     try {
                         result = await contract.methods.playLottery().send({
                             from: userAccount,
                             value: price,
                             gas: 300000
                         });
                         break; // æˆåŠŸåˆ™è·³å‡ºå¾ªç¯
                     } catch (txError) {
                         retryCount++;
                         console.log(`æŠ½å¥–äº¤æ˜“å¤±è´¥ï¼Œç¬¬ ${retryCount} æ¬¡é‡è¯•:`, txError);
                         
                         if (retryCount >= maxRetries) {
                             throw new Error(`æŠ½å¥–äº¤æ˜“å¤±è´¥ï¼Œå·²é‡è¯• ${maxRetries} æ¬¡: ${txError.message}`);
                         }
                         
                         // ç­‰å¾…ä¸€æ®µæ—¶é—´åé‡è¯•
                         await new Promise(resolve => setTimeout(resolve, 1000 * retryCount));
                     }
                 }
                
                // æŸ¥æ‰¾æŠ½å¥–äº‹ä»¶
                const lotteryEvent = result.events.LotteryWon;
                if (lotteryEvent) {
                    const tokenId = lotteryEvent.returnValues.tokenId;
                    const winner = lotteryEvent.returnValues.winner;
                    const paidAmount = lotteryEvent.returnValues.price;
                    
                    showStatus(`ğŸ‰ æŠ½å¥–æˆåŠŸï¼è·å¾— SnakeCoin #${tokenId}`, 'success');
                    
                                         // ç”ŸæˆNFTå¡ç‰‡
                     await generateNFTCard(tokenId);
                     
                     // æ›´æ–°ä¿¡æ¯
                     updateLotteryInfo();
                     
                     // åˆ·æ–°ç”¨æˆ·çš„NFTåˆ—è¡¨
                     await loadUserNFTs();
                    
                                         // æ›´æ–°ç”¨æˆ·ä½™é¢ - æ·»åŠ é”™è¯¯å¤„ç†
                     try {
                         // ç›´æ¥ä½¿ç”¨é’±åŒ…æä¾›è€…è·å–ä½™é¢ï¼Œé¿å… Web3.js çš„è‡ªåŠ¨è½¬æ¢
                         const balanceResult = await currentWalletProvider.request({
                             method: 'eth_getBalance',
                             params: [userAccount, 'latest']
                         });
                         
                         // æ£€æŸ¥è¿”å›ç»“æœæ˜¯å¦ä¸ºæœ‰æ•ˆæ•°å­—
                         if (balanceResult && typeof balanceResult === 'string') {
                             if (balanceResult.match(/^0x[0-9a-fA-F]+$/)) {
                                 // åå…­è¿›åˆ¶æ ¼å¼
                                 userBalance = balanceResult;
                                 console.log('æ›´æ–°åçš„ç”¨æˆ·ä½™é¢(åå…­è¿›åˆ¶):', userBalance);
                             } else if (balanceResult.match(/^\d+$/)) {
                                 // åè¿›åˆ¶æ ¼å¼ï¼Œè½¬æ¢ä¸ºåå…­è¿›åˆ¶
                                 userBalance = '0x' + BigInt(balanceResult).toString(16);
                                 console.log('æ›´æ–°åçš„ç”¨æˆ·ä½™é¢(åè¿›åˆ¶è½¬åå…­è¿›åˆ¶):', userBalance);
                             } else {
                                 console.warn('ä½™é¢æ›´æ–°è¿”å›æ ¼å¼å¼‚å¸¸:', balanceResult);
                                 // ä¿æŒåŸæœ‰ä½™é¢ä¸å˜
                             }
                         } else if (balanceResult && typeof balanceResult === 'object' && balanceResult.error) {
                             // å¤„ç†é”™è¯¯å¯¹è±¡
                             console.warn('ä½™é¢æ›´æ–°è¿”å›é”™è¯¯å¯¹è±¡:', balanceResult.error);
                             console.warn('RPC è°ƒç”¨å¤±è´¥ï¼Œä¿æŒåŸæœ‰ä½™é¢ä¸å˜');
                             // ä¿æŒåŸæœ‰ä½™é¢ä¸å˜
                         } else {
                             console.warn('ä½™é¢æ›´æ–°è¿”å›ç±»å‹å¼‚å¸¸:', typeof balanceResult, balanceResult);
                             // ä¿æŒåŸæœ‰ä½™é¢ä¸å˜
                         }
                         
                         // å®‰å…¨åœ°è·å–ç½‘ç»œä¿¡æ¯
                         let currentNetworkName;
                         try {
                             if (currentWalletProvider) {
                                 const currentChainId = await currentWalletProvider.request({ method: 'eth_chainId' });
                                 currentNetworkName = getNetworkName(currentChainId);
                             } else {
                                 currentNetworkName = 'Hardhat Local Network';
                             }
                         } catch (networkError) {
                             currentNetworkName = 'Hardhat Local Network';
                         }
                         
                         updateWalletInfo(userAccount, userBalance, currentNetworkName, currentWalletName);
                     } catch (balanceUpdateError) {
                         console.error('æ›´æ–°ä½™é¢å¤±è´¥:', balanceUpdateError);
                         // ä¸é˜»æ­¢æŠ½å¥–æˆåŠŸï¼Œåªè®°å½•é”™è¯¯
                     }
                    
                } else {
                    throw new Error('æŠ½å¥–äº‹ä»¶æœªæ‰¾åˆ°');
                }
                
            } catch (error) {
                console.error('æŠ½å¥–å¤±è´¥:', error);
                showStatus(`âŒ æŠ½å¥–å¤±è´¥: ${error.message}`, 'error');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                lotteryBtn.disabled = false;
                lotteryBtn.innerHTML = originalText;
            }
        }

                 // åŠ è½½ç”¨æˆ·æ‹¥æœ‰çš„NFT
         async function loadUserNFTs() {
             if (!contract || !userAccount) return;
             
             try {
                 const myNftGrid = document.getElementById('myNftGrid');
                 
                 // æ¸…ç©ºç°æœ‰å†…å®¹
                 myNftGrid.innerHTML = '';
                 
                 console.log('=== å¼€å§‹åŠ è½½ç”¨æˆ·NFT ===');
                 console.log('å½“å‰é’±åŒ…ç±»å‹:', currentWalletName);
                 console.log('ç”¨æˆ·åœ°å€:', userAccount);
                 console.log('åˆçº¦åœ°å€:', CONTRACT_ADDRESS);
                 
                 // è·å–æ€»ä¾›åº”é‡
                 try {
                     const totalSupply = await contract.methods.totalSupply().call();
                     console.log('æ€»ä¾›åº”é‡:', totalSupply.toString());
                     
                     if (totalSupply == 0) {
                         updateMyNftStatus('ğŸ“­ æ‚¨è¿˜æ²¡æœ‰ä»»ä½•NFT');
                         return;
                     }
                 } catch (supplyError) {
                     console.error('è·å–æ€»ä¾›åº”é‡å¤±è´¥:', supplyError);
                     showStatus('âŒ æ— æ³•è·å–æ€»ä¾›åº”é‡ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
                     return;
                 }
                 
                 updateMyNftStatus('ğŸ” æ­£åœ¨æŸ¥æ‰¾æ‚¨çš„NFT...');
                 console.log('å¼€å§‹æŸ¥æ‰¾ç”¨æˆ·NFTï¼Œç”¨æˆ·åœ°å€:', userAccount);
                 
                 // éå†æ‰€æœ‰å¯èƒ½çš„tokenIdï¼Œæ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰
                 let userNFTCount = 0;
                 const maxSupply = 1000; // åˆçº¦ä¸­çš„MAX_SUPPLY
                 const userNFTs = []; // å­˜å‚¨æ‰¾åˆ°çš„NFTä¿¡æ¯
                 
                 // åˆ†æ‰¹å¤„ç†ï¼Œé¿å…ä¸€æ¬¡æ€§å¤„ç†å¤ªå¤šè¯·æ±‚
                 const batchSize = 50;
                 let processedCount = 0;
                 
                 for (let tokenId = 0; tokenId < maxSupply; tokenId++) {
                     try {
                         // æ£€æŸ¥tokenæ˜¯å¦å­˜åœ¨
                         const owner = await contract.methods.ownerOf(tokenId).call();
                         
                         if (processedCount < 10) { // åªè®°å½•å‰10ä¸ªçš„è¯¦ç»†ä¿¡æ¯
                             console.log(`Token ${tokenId} çš„æ‰€æœ‰è€…:`, owner);
                         }
                         
                         if (owner.toLowerCase() === userAccount.toLowerCase()) {
                             // ç”¨æˆ·æ‹¥æœ‰è¿™ä¸ªNFTï¼Œå…ˆæ”¶é›†ä¿¡æ¯ï¼Œä¸ç«‹å³ç”Ÿæˆå¡ç‰‡
                             console.log(`âœ… æ‰¾åˆ°ç”¨æˆ·æ‹¥æœ‰çš„NFT: Token ${tokenId}`);
                             userNFTs.push(tokenId);
                             userNFTCount++;
                         }
                         
                         processedCount++;
                         
                         // æ¯å¤„ç†ä¸€æ‰¹ï¼Œæ›´æ–°çŠ¶æ€
                         if (processedCount % batchSize === 0) {
                             updateMyNftStatus(`ğŸ” å·²æ£€æŸ¥ ${processedCount}/${maxSupply} ä¸ªToken...`);
                             console.log(`å·²å¤„ç† ${processedCount}/${maxSupply} ä¸ªTokenï¼Œæ‰¾åˆ° ${userNFTCount} ä¸ªNFT`);
                         }
                         
                     } catch (error) {
                         // tokenä¸å­˜åœ¨ï¼Œç»§ç»­ä¸‹ä¸€ä¸ª
                         if (processedCount < 10) { // åªè®°å½•å‰10ä¸ªé”™è¯¯
                             console.log(`Token ${tokenId} ä¸å­˜åœ¨æˆ–å‡ºé”™:`, error.message);
                         }
                         processedCount++;
                         continue;
                     }
                 }
                 
                 console.log('=== æŸ¥æ‰¾å®Œæˆ ===');
                 console.log('ç”¨æˆ·æ‹¥æœ‰NFTæ•°é‡:', userNFTCount);
                 console.log('æ‰¾åˆ°çš„NFT Token IDs:', userNFTs);
                 console.log('å½“å‰é’±åŒ…ç±»å‹:', currentWalletName);
                 
                 if (userNFTCount > 0) {
                     updateMyNftStatus(`âœ… æ‰¾åˆ° ${userNFTCount} ä¸ªNFT`);
                     
                     // æŒ‰å€’åºæ’åˆ—ï¼Œæœ€æ–°çš„æ’åœ¨å‰é¢
                     userNFTs.sort((a, b) => b - a);
                     console.log('å€’åºæ’åˆ—åçš„NFT Token IDs:', userNFTs);
                     
                     // æŒ‰å€’åºç”ŸæˆNFTå¡ç‰‡
                     for (const tokenId of userNFTs) {
                         await generateUserNFTCard(tokenId);
                     }
                     
                 } else {
                     updateMyNftStatus('ğŸ“­ æ‚¨è¿˜æ²¡æœ‰ä»»ä½•NFT');
                     console.log('ç”¨æˆ·æ²¡æœ‰æ‰¾åˆ°ä»»ä½•NFTï¼Œå¯èƒ½çš„åŸå› :');
                     console.log('1. ç”¨æˆ·ç¡®å®æ²¡æœ‰NFT');
                     console.log('2. ç½‘ç»œä¸åŒæ­¥');
                     console.log('3. åˆçº¦è°ƒç”¨æƒé™é—®é¢˜');
                     console.log('4. é’±åŒ…RPCèŠ‚ç‚¹é—®é¢˜');
                 }
                 
             } catch (error) {
                 console.error('åŠ è½½ç”¨æˆ·NFTå¤±è´¥:', error);
                 console.error('é”™è¯¯è¯¦æƒ…:', error.message, error.stack);
                 showStatus('âš ï¸ åŠ è½½ç”¨æˆ·NFTå¤±è´¥: ' + error.message, 'error');
             }
         }

        // ç”Ÿæˆç”¨æˆ·NFTå¡ç‰‡
        async function generateUserNFTCard(tokenId) {
            try {
                // è·å–SVG
                const svg = await contract.methods.generateSnakeSVG(tokenId).call();
                
                // è·å–TokenURI
                const tokenURI = await contract.methods.tokenURI(tokenId).call();
                
                // è§£ç Base64è·å–å…ƒæ•°æ®
                const base64Data = tokenURI.replace("data:application/json;base64,", "");
                const jsonData = JSON.parse(atob(base64Data));
                
                // åˆ›å»ºNFTå¡ç‰‡
                const myNftGrid = document.getElementById('myNftGrid');
                const nftCard = document.createElement('div');
                nftCard.className = 'nft-card';
                nftCard.innerHTML = `
                    <h3>${jsonData.name}</h3>
                    <div class="nft-svg">
                        ${svg}
                    </div>
                    <div class="nft-info">
                        <p><strong>Token ID:</strong> ${tokenId}</p>
                        <p><strong>æè¿°:</strong> ${jsonData.description}</p>
                        <p><strong>è›‡ç :</strong> ${jsonData.attributes[0].value}</p>
                        <p><strong>é¢œè‰²ä¸»é¢˜:</strong> <span style="color: ${jsonData.attributes[1].value}">${jsonData.attributes[1].value}</span></p>
                        <p><strong>å›¾æ¡ˆç±»å‹:</strong> ${jsonData.attributes[2].value}</p>
                        <p><strong>çŠ¶æ€:</strong> <span style="color: #28a745;">âœ… å·²æ‹¥æœ‰</span></p>
                    </div>
                `;
                
                // æ·»åŠ åˆ°ç”¨æˆ·NFTç½‘æ ¼
                myNftGrid.appendChild(nftCard);
                
            } catch (error) {
                console.error('ç”Ÿæˆç”¨æˆ·NFTå¡ç‰‡å¤±è´¥:', error);
            }
        }

        // ç”ŸæˆNFTå¡ç‰‡
        async function generateNFTCard(tokenId) {
            try {
                // è·å–SVG
                const svg = await contract.methods.generateSnakeSVG(tokenId).call();
                
                // è·å–TokenURI
                const tokenURI = await contract.methods.tokenURI(tokenId).call();
                
                // è§£ç Base64è·å–å…ƒæ•°æ®
                const base64Data = tokenURI.replace("data:application/json;base64,", "");
                const jsonData = JSON.parse(atob(base64Data));
                
                // åˆ›å»ºNFTå¡ç‰‡
                const nftGrid = document.getElementById('nftGrid');
                const nftCard = document.createElement('div');
                nftCard.className = 'nft-card';
                nftCard.innerHTML = `
                    <h3>${jsonData.name}</h3>
                    <div class="nft-svg">
                        ${svg}
                    </div>
                    <div class="nft-info">
                        <p><strong>Token ID:</strong> ${tokenId}</p>
                        <p><strong>æè¿°:</strong> ${jsonData.description}</p>
                        <p><strong>è›‡ç :</strong> ${jsonData.attributes[0].value}</p>
                        <p><strong>é¢œè‰²ä¸»é¢˜:</strong> <span style="color: ${jsonData.attributes[1].value}">${jsonData.attributes[1].value}</span></p>
                        <p><strong>å›¾æ¡ˆç±»å‹:</strong> ${jsonData.attributes[2].value}</p>
                    </div>
                `;
                
                // æ’å…¥åˆ°ç½‘æ ¼å¼€å¤´
                nftGrid.insertBefore(nftCard, nftGrid.firstChild);
                
            } catch (error) {
                console.error('ç”ŸæˆNFTå¡ç‰‡å¤±è´¥:', error);
                showStatus('âš ï¸ NFTç”ŸæˆæˆåŠŸï¼Œä½†æ˜¾ç¤ºå¤±è´¥', 'info');
            }
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusDiv');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 5000);
        }

        // æ›´æ–°æˆ‘çš„NFTçŠ¶æ€
        function updateMyNftStatus(message) {
            const statusElement = document.getElementById('myNftStatus');
            if (statusElement) {
                statusElement.textContent = message;
            }
        }

        // æ ‡ç­¾é¡µåˆ‡æ¢
        function switchTab(tabName) {
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾é¡µçš„activeç±»
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabBtns.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            // æ¿€æ´»é€‰ä¸­çš„æ ‡ç­¾é¡µ
            if (tabName === 'latest') {
                document.getElementById('latestTab').classList.add('active');
                document.getElementById('latestTabContent').classList.add('active');
            } else if (tabName === 'my') {
                document.getElementById('myTab').classList.add('active');
                document.getElementById('myTabContent').classList.add('active');
                
                // å¦‚æœåˆ‡æ¢åˆ°"æˆ‘çš„NFT"æ ‡ç­¾ï¼Œè‡ªåŠ¨åŠ è½½ç”¨æˆ·NFT
                if (contract && userAccount) {
                    loadUserNFTs();
                }
            }
        }

                 // æ£€æŸ¥é’±åŒ…çŠ¶æ€
         function checkWallet() {
             const luckyouBtn = document.getElementById('luckyouBtn');
             const metamaskBtn = document.getElementById('metamaskBtn');
             
             // æ£€æµ‹å¯ç”¨çš„é’±åŒ…
             let luckyouAvailable = false;
             let metamaskAvailable = false;
             
             // æ£€æµ‹ LuckYou Wallet
             if (typeof window.luckYou !== 'undefined' || (window.luckyouWallet && window.luckyouWallet.isLuckYouWallet)) {
                 luckyouAvailable = true;
                 console.log('âœ… LuckYou é’±åŒ…å¯ç”¨');
             } else {
                 console.log('âŒ LuckYou é’±åŒ…ä¸å¯ç”¨');
             }
             
             // æ£€æµ‹ MetaMask
             if (typeof window.ethereum !== 'undefined' && window.ethereum.isMetaMask) {
                 metamaskAvailable = true;
                 console.log('âœ… MetaMask é’±åŒ…å¯ç”¨');
             } else {
                 console.log('âŒ MetaMask é’±åŒ…ä¸å¯ç”¨');
             }
             
             // æ›´æ–°æŒ‰é’®çŠ¶æ€
             if (luckyouAvailable) {
                 luckyouBtn.disabled = false;
                 luckyouBtn.style.background = 'linear-gradient(45deg, #FF6B6B, #FF8E8E)';
                 showStatus('âœ… LuckYou é’±åŒ…å·²å°±ç»ªï¼', 'success');
             } else {
                 luckyouBtn.disabled = true;
                 luckyouBtn.style.background = '#6c757d';
                 luckyouBtn.innerHTML = 'âŒ è¯·å®‰è£… LuckYou é’±åŒ…';
             }
             
             if (metamaskAvailable) {
                 metamaskBtn.disabled = false;
                 metamaskBtn.style.background = 'linear-gradient(45deg, #F6851B, #FFA726)';
                 showStatus('âœ… MetaMask é’±åŒ…å·²å°±ç»ªï¼', 'success');
             } else {
                 metamaskBtn.disabled = true;
                 metamaskBtn.style.background = '#6c757d';
                 metamaskBtn.innerHTML = 'âŒ è¯·å®‰è£… MetaMask';
             }
             
             // å¦‚æœä¸¤ä¸ªé’±åŒ…éƒ½ä¸å¯ç”¨
             if (!luckyouAvailable && !metamaskAvailable) {
                 showStatus('âŒ æœªæ£€æµ‹åˆ°ä»»ä½•é’±åŒ…ï¼Œè¯·å®‰è£… LuckYou é’±åŒ…æˆ– MetaMask æ‰©å±•', 'error');
             } else if (luckyouAvailable && metamaskAvailable) {
                 showStatus('âœ… æ£€æµ‹åˆ°ä¸¤ä¸ªé’±åŒ…ï¼Œæ‚¨å¯ä»¥é€‰æ‹©ä»»æ„ä¸€ä¸ªè¿æ¥ï¼', 'success');
             }
         }

                 // é¢„åŠ è½½åˆçº¦ä¿¡æ¯ï¼ˆä½¿ç”¨é»˜è®¤ Hardhat ç½‘ç»œï¼‰
         async function preloadContractInfo() {
             try {
                 console.log('å¼€å§‹é¢„åŠ è½½åˆçº¦ä¿¡æ¯...');
                 
                 // åˆ›å»ºä¸´æ—¶çš„ Web3 å®ä¾‹è¿æ¥åˆ° Hardhat ç½‘ç»œ
                 const tempWeb3 = new Web3('http://127.0.0.1:8545');
                 const tempContract = new tempWeb3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
                 
                 // å°è¯•è·å–åˆçº¦ä¿¡æ¯
                 let price, poolSize, totalMinted, remaining;
                 
                 try {
                     price = await tempContract.methods.lotteryPrice().call();
                     console.log('é¢„åŠ è½½æŠ½å¥–ä»·æ ¼:', price);
                 } catch (error) {
                     console.warn('é¢„åŠ è½½æŠ½å¥–ä»·æ ¼å¤±è´¥:', error.message);
                     price = '100000000000000'; // é»˜è®¤ 0.0001 ETH (wei)
                 }
                 
                 try {
                     poolSize = await tempContract.methods.getPoolSize().call();
                     console.log('é¢„åŠ è½½æ± å­å¤§å°:', poolSize);
                 } catch (error) {
                     console.warn('é¢„åŠ è½½æ± å­å¤§å°å¤±è´¥:', error.message);
                     poolSize = '100'; // é»˜è®¤å€¼
                 }
                 
                 try {
                     totalMinted = await tempContract.methods.totalSupply().call();
                     console.log('é¢„åŠ è½½å·²é“¸é€ æ•°é‡:', totalMinted);
                 } catch (error) {
                     console.warn('é¢„åŠ è½½å·²é“¸é€ æ•°é‡å¤±è´¥:', error.message);
                     totalMinted = '0'; // é»˜è®¤å€¼
                 }
                 
                 // è®¡ç®—å‰©ä½™æ•°é‡
                 try {
                     const maxSupply = 1000; // åˆçº¦ä¸­çš„MAX_SUPPLY
                     remaining = maxSupply - parseInt(totalMinted || 0);
                     console.log('é¢„åŠ è½½å‰©ä½™æ•°é‡:', remaining);
                 } catch (error) {
                     console.warn('é¢„åŠ è½½å‰©ä½™æ•°é‡è®¡ç®—å¤±è´¥:', error.message);
                     remaining = 1000; // é»˜è®¤å€¼
                 }
                 
                 // æ›´æ–°UIæ˜¾ç¤ºé¢„åŠ è½½çš„ä¿¡æ¯
                 try {
                     const priceInEth = tempWeb3.utils.fromWei(price || '100000000000000', 'ether');
                     document.getElementById('lotteryPrice').textContent = `${priceInEth} ETH`;
                     document.getElementById('poolSize').textContent = poolSize || '100';
                     document.getElementById('totalMinted').textContent = totalMinted || '0';
                     document.getElementById('remainingSupply').textContent = (remaining || 1000).toString();
                     
                     console.log('åˆçº¦ä¿¡æ¯é¢„åŠ è½½æˆåŠŸ');
                     showStatus('âœ… åˆçº¦ä¿¡æ¯å·²åŠ è½½ï¼Œè¯·è¿æ¥é’±åŒ…å¼€å§‹æŠ½å¥–ï¼', 'success');
                     
                 } catch (uiError) {
                     console.error('é¢„åŠ è½½UIæ›´æ–°å¤±è´¥:', uiError);
                 }
                 
             } catch (error) {
                 console.error('é¢„åŠ è½½åˆçº¦ä¿¡æ¯å¤±è´¥:', error);
                 showStatus('âš ï¸ æ— æ³•é¢„åŠ è½½åˆçº¦ä¿¡æ¯ï¼Œè¯·ç¡®ä¿ Hardhat èŠ‚ç‚¹æ­£åœ¨è¿è¡Œ', 'info');
             }
         }
         
         // åˆ·æ–°åˆçº¦ä¿¡æ¯ï¼ˆæ ¹æ®å½“å‰çŠ¶æ€é€‰æ‹©åˆé€‚çš„æ–¹æ³•ï¼‰
         async function refreshContractInfo() {
             if (contract && web3) {
                 // å¦‚æœå·²è¿æ¥é’±åŒ…ï¼Œä½¿ç”¨å®æ—¶æ›´æ–°
                 console.log('ä½¿ç”¨å·²è¿æ¥çš„é’±åŒ…åˆ·æ–°åˆçº¦ä¿¡æ¯');
                 await updateLotteryInfo();
             } else {
                 // å¦‚æœæœªè¿æ¥é’±åŒ…ï¼Œä½¿ç”¨é¢„åŠ è½½
                 console.log('ä½¿ç”¨é¢„åŠ è½½æ–¹å¼åˆ·æ–°åˆçº¦ä¿¡æ¯');
                 await preloadContractInfo();
             }
         }
         
         // ç½‘ç»œè¯Šæ–­å‡½æ•°
         async function diagnoseNetwork() {
             if (!currentWalletProvider) {
                 showStatus('âŒ è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
                 return;
             }
             
             try {
                 showStatus('ğŸ” æ­£åœ¨è¯Šæ–­ç½‘ç»œ...', 'info');
                 console.log('å¼€å§‹ç½‘ç»œè¯Šæ–­...');
                 
                 // è·å–ç½‘ç»œä¿¡æ¯
                 const chainId = await currentWalletProvider.request({ method: 'eth_chainId' });
                 const networkName = getNetworkName(chainId);
                 console.log('å½“å‰ç½‘ç»œ Chain ID:', chainId);
                 console.log('å½“å‰ç½‘ç»œåç§°:', networkName);
                 
                 // æ£€æŸ¥ç½‘ç»œæ˜¯å¦åŒ¹é…
                 if (chainId !== '0x539' && chainId !== '0x31337' && chainId !== '0x7a69') {
                     showStatus('âš ï¸ å½“å‰ç½‘ç»œä¸åŒ¹é…ï¼Œåˆçº¦åœ°å€ä»…é€‚ç”¨äºæœ¬åœ° Hardhat ç½‘ç»œ', 'warning');
                     console.warn('ç½‘ç»œä¸åŒ¹é…ï¼Œè·³è¿‡åˆçº¦æµ‹è¯•');
                     return;
                 }
                 
                 // è·å–æœ€æ–°åŒºå—
                 const latestBlock = await currentWalletProvider.request({
                     method: 'eth_getBlockByNumber',
                     params: ['latest', false]
                 });
                 console.log('æœ€æ–°åŒºå—å·:', latestBlock.number);
                 console.log('æœ€æ–°åŒºå—æ—¶é—´æˆ³:', latestBlock.timestamp);
                 
                 // æµ‹è¯•åˆçº¦è°ƒç”¨
                 if (contract) {
                     try {
                         console.log('æµ‹è¯•åˆçº¦è°ƒç”¨...');
                         
                         // å…ˆæ£€æŸ¥åˆçº¦æ˜¯å¦å­˜åœ¨
                         const code = await web3.eth.getCode(CONTRACT_ADDRESS);
                         if (code === '0x' || code === '0x0') {
                             throw new Error('åˆçº¦åœ°å€ä¸Šæ²¡æœ‰ä»£ç ï¼Œè¯·æ£€æŸ¥åˆçº¦æ˜¯å¦å·²éƒ¨ç½²');
                         }
                         
                         const price = await contract.methods.lotteryPrice().call();
                         console.log('åˆçº¦è°ƒç”¨æˆåŠŸï¼ŒæŠ½å¥–ä»·æ ¼:', price);
                         
                         const totalSupply = await contract.methods.totalSupply().call();
                         console.log('åˆçº¦è°ƒç”¨æˆåŠŸï¼Œæ€»ä¾›åº”é‡:', totalSupply);
                         
                         showStatus('âœ… ç½‘ç»œè¯Šæ–­å®Œæˆï¼Œåˆçº¦è°ƒç”¨æ­£å¸¸', 'success');
                     } catch (contractError) {
                         console.error('åˆçº¦è°ƒç”¨å¤±è´¥:', contractError);
                         
                         // æ£€æŸ¥æ˜¯å¦æ˜¯ç½‘ç»œä¸åŒ¹é…çš„é—®é¢˜
                         if (chainId !== '0x539' && chainId !== '0x31337' && chainId !== '0x7a69') {
                             showStatus('âŒ ç½‘ç»œè¯Šæ–­å®Œæˆï¼Œå½“å‰ç½‘ç»œä¸æ”¯æŒæ­¤åˆçº¦', 'error');
                         } else {
                             showStatus('âŒ ç½‘ç»œè¯Šæ–­å®Œæˆï¼Œåˆçº¦è°ƒç”¨å¤±è´¥', 'error');
                         }
                     }
                 } else {
                     console.log('åˆçº¦æœªåˆå§‹åŒ–ï¼Œè·³è¿‡åˆçº¦æµ‹è¯•');
                     showStatus('âš ï¸ ç½‘ç»œè¯Šæ–­å®Œæˆï¼Œä½†åˆçº¦æœªåˆå§‹åŒ–', 'info');
                 }
                 
             } catch (error) {
                 console.error('ç½‘ç»œè¯Šæ–­å¤±è´¥:', error);
                 showStatus(`âŒ ç½‘ç»œè¯Šæ–­å¤±è´¥: ${error.message}`, 'error');
             }
         }
         
         // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥é’±åŒ…å’Œé¢„åŠ è½½åˆçº¦ä¿¡æ¯
         window.onload = function() {
             console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œæ£€æŸ¥é’±åŒ…çŠ¶æ€å’Œé¢„åŠ è½½åˆçº¦ä¿¡æ¯...');
             
             // æ£€æŸ¥ Web3 ç‰ˆæœ¬
             if (typeof Web3 !== 'undefined') {
                 console.log('Web3 ç‰ˆæœ¬:', Web3.version);
                 console.log('Web3 åº“å·²åŠ è½½');
             } else {
                 console.error('Web3 åº“æœªåŠ è½½ï¼');
                 showStatus('âŒ Web3 åº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
                 return;
             }
             
             console.log('window.luckYou:', typeof window.luckYou !== 'undefined' ? 'å·²å®šä¹‰' : 'æœªå®šä¹‰');
             console.log('window.luckyouWallet:', typeof window.luckyouWallet !== 'undefined' ? 'å·²å®šä¹‰' : 'æœªå®šä¹‰');
             if (window.luckyouWallet) {
                 console.log('window.luckyouWallet.isLuckYouWallet:', window.luckyouWallet.isLuckYouWallet);
             }
             console.log('window.ethereum:', typeof window.ethereum !== 'undefined' ? 'å·²å®šä¹‰' : 'æœªå®šä¹‰');
             if (typeof window.ethereum !== 'undefined') {
                 console.log('window.ethereum.isMetaMask:', window.ethereum.isMetaMask);
             }
             
             // é¢„åŠ è½½åˆçº¦ä¿¡æ¯ï¼ˆä½¿ç”¨é»˜è®¤ Hardhat ç½‘ç»œï¼‰
             preloadContractInfo();
             
             // å»¶è¿Ÿæ£€æŸ¥é’±åŒ…ï¼Œç¡®ä¿æ‰©å±•åŠ è½½å®Œæˆ
             setTimeout(() => {
                 checkWallet();
             }, 1000);
         };

        // ç›‘å¬è´¦æˆ·å˜åŒ–
        function setupWalletListeners() {
            // æ£€æµ‹å¯ç”¨çš„é’±åŒ…
            const availableWallets = [];
            
            // æ£€æµ‹ LuckYou Wallet (ä¸»è¦å¯¹è±¡)
            if (typeof window.luckYou !== 'undefined') {
                availableWallets.push({
                    id: 'luckyou',
                    name: 'LuckYou Wallet',
                    provider: window.luckYou
                });
            }
            
            // æ£€æµ‹ LuckYou Wallet (æ›¿ä»£å¯¹è±¡)
            if (window.luckyouWallet && window.luckyouWallet.isLuckYouWallet) {
                availableWallets.push({
                    id: 'luckyou-alt',
                    name: 'LuckYou Wallet',
                    provider: window.luckyouWallet
                });
            }
            
            // æ£€æµ‹ MetaMask
            if (typeof window.ethereum !== 'undefined' && window.ethereum.isMetaMask) {
                availableWallets.push({
                    id: 'metamask',
                    name: 'MetaMask',
                    provider: window.ethereum
                });
            }
            
            // æ£€æµ‹å…¶ä»–å…¼å®¹é’±åŒ…
            if (typeof window.ethereum !== 'undefined' && !window.ethereum.isMetaMask) {
                availableWallets.push({
                    id: 'compatible',
                    name: 'å…¼å®¹é’±åŒ…',
                    provider: window.ethereum
                });
            }
            
            // ä¼˜å…ˆä½¿ç”¨ LuckYou é’±åŒ…
            const preferredWallet = availableWallets.find(w => w.id.includes('luckyou')) || availableWallets[0];
            
            if (preferredWallet) {
                const walletProvider = preferredWallet.provider;
                console.log(`è®¾ç½® ${preferredWallet.name} ç›‘å¬å™¨`);
                
                try {
                    walletProvider.on('accountsChanged', function (accounts) {
                        console.log('è´¦æˆ·å˜åŒ–:', accounts);
                        if (accounts.length === 0) {
                            // ç”¨æˆ·æ–­å¼€è¿æ¥
                            location.reload();
                        } else {
                            // è´¦æˆ·åˆ‡æ¢
                            userAccount = accounts[0];
                            location.reload();
                        }
                    });

                    walletProvider.on('chainChanged', function (chainId) {
                        console.log('ç½‘ç»œå˜åŒ–:', chainId);
                        // ç½‘ç»œåˆ‡æ¢
                        location.reload();
                    });
                } catch (error) {
                    console.log('è®¾ç½®é’±åŒ…ç›‘å¬å™¨å¤±è´¥:', error);
                }
            }
        }

                 // åˆ‡æ¢é’±åŒ…
         async function switchWallet() {
             try {
                 showStatus('ğŸ”„ æ­£åœ¨åˆ‡æ¢é’±åŒ…...', 'info');
                 
                 // æ–­å¼€å½“å‰é’±åŒ…
                 disconnectWallet();
                 
                 // ç­‰å¾…ä¸€ä¸‹å†é‡æ–°æ£€æµ‹
                 await new Promise(resolve => setTimeout(resolve, 500));
                 
                 // é‡æ–°æ£€æµ‹é’±åŒ…
                 checkWallet();
                 
                 showStatus('âœ… é’±åŒ…åˆ‡æ¢å®Œæˆï¼Œè¯·é‡æ–°è¿æ¥', 'success');
                 
             } catch (error) {
                 console.error('åˆ‡æ¢é’±åŒ…å¤±è´¥:', error);
                 showStatus(`âŒ åˆ‡æ¢é’±åŒ…å¤±è´¥: ${error.message}`, 'error');
             }
         }
         
         // è®¾ç½®é’±åŒ…ç›‘å¬å™¨
         setupWalletListeners();

        // æ›´æ–°ç½‘ç»œçŠ¶æ€æ˜¾ç¤º
        function updateNetworkStatus(chainId, networkName, isConnected = false) {
            const networkStatus = document.getElementById('networkStatus');
            const networkStatusText = document.getElementById('networkStatusText');
            const networkSwitchTip = document.getElementById('networkSwitchTip');
            
            if (!isConnected) {
                networkStatus.style.display = 'none';
                return;
            }
            
            networkStatus.style.display = 'block';
            
            // æ£€æŸ¥ç½‘ç»œæ˜¯å¦åŒ¹é…
            if (chainId === '0x539' || chainId === '0x31337' || chainId === '0x7a69') {
                networkStatus.className = 'network-status success';
                networkStatusText.textContent = 'âœ… ç½‘ç»œåŒ¹é… - å¯ä»¥æ­£å¸¸ä½¿ç”¨';
                networkSwitchTip.textContent = '';
            } else {
                networkStatus.className = 'network-status error';
                networkStatusText.textContent = 'âŒ ç½‘ç»œä¸åŒ¹é… - æ— æ³•ä½¿ç”¨åˆçº¦';
                networkSwitchTip.textContent = 'è¯·åˆ‡æ¢åˆ°æœ¬åœ° Hardhat ç½‘ç»œ (Chain ID: 31337 æˆ– 1337)';
            }
        }
    </script>

    <!-- Web3.js åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
</body>
</html>

