<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé≤ ËõáÂ∏ÅNFTÂ¢ûÂº∫ÊäΩÂ•ñ - LuckYouÈí±ÂåÖÈõÜÊàê</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 3rem;
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2rem;
            color: #666;
        }

        .wallet-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px solid #dee2e6;
        }

        .wallet-section h2 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.8rem;
        }

        .wallet-detection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .wallet-option {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .wallet-option:hover {
            border-color: #007bff;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .wallet-option.detected {
            border-color: #28a745;
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        }

        .wallet-option.not-detected {
            border-color: #dc3545;
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        }

        .wallet-option.connected {
            border-color: #17a2b8;
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
        }

        .wallet-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .wallet-icon {
            font-size: 2rem;
            margin-right: 15px;
        }

        .wallet-name {
            font-size: 1.3rem;
            font-weight: bold;
            color: #333;
        }

        .wallet-status {
            margin-bottom: 15px;
            font-size: 0.95rem;
        }

        .status-detected {
            color: #155724;
            font-weight: bold;
        }

        .status-not-detected {
            color: #721c24;
            font-weight: bold;
        }

        .status-connected {
            color: #0c5460;
            font-weight: bold;
        }

        .wallet-btn {
            width: 100%;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .wallet-btn.connect {
            background: linear-gradient(45deg, #FF6B6B, #FF8E8E);
            color: white;
        }

        .wallet-btn.connect:hover:not(:disabled) {
            background: linear-gradient(45deg, #FF5252, #FF7676);
            transform: translateY(-1px);
        }

        .wallet-btn.disconnect {
            background: linear-gradient(45deg, #17a2b8, #20c997);
            color: white;
        }

        .wallet-btn.disconnect:hover:not(:disabled) {
            background: linear-gradient(45deg, #138496, #1e7e34);
            transform: translateY(-1px);
        }

        .wallet-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .wallet-info {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #dee2e6;
            font-family: monospace;
            font-size: 0.9rem;
            display: none;
        }

        .lottery-section {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 2px solid #e9ecef;
        }

        .lottery-section h2 {
            text-align: center;
            color: #333;
            margin-bottom: 25px;
            font-size: 2rem;
        }

        .contract-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }

        .contract-info h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .contract-info p {
            margin-bottom: 8px;
            font-family: monospace;
            font-size: 0.9rem;
            word-break: break-all;
        }

        .lottery-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border: 1px solid #dee2e6;
        }

        .info-card h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .info-card p {
            font-size: 1.5rem;
            font-weight: bold;
            color: #007bff;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .action-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .action-btn:hover:not(:disabled) {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .action-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .action-btn.refresh {
            background: #17a2b8;
        }

        .action-btn.refresh:hover:not(:disabled) {
            background: #138496;
        }

        .action-btn.diagnose {
            background: #ffc107;
            color: #212529;
        }

        .action-btn.diagnose:hover:not(:disabled) {
            background: #e0a800;
        }

        .lottery-btn {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            border: none;
            padding: 20px 40px;
            border-radius: 50px;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            display: block;
        }

        .lottery-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
        }

        .lottery-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .status {
            text-align: center;
            padding: 15px;
            margin: 20px 0;
            border-radius: 10px;
            font-weight: bold;
            border: 1px solid;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border-color: #bee5eb;
        }

        .status.warning {
            background: #fff3cd;
            color: #856404;
            border-color: #ffeaa7;
        }

        .tips {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #2196f3;
        }

        .tips h3 {
            color: #1565c0;
            margin-bottom: 10px;
        }

        .tips ul {
            color: #1565c0;
            margin-left: 20px;
        }

        .tips li {
            margin-bottom: 5px;
        }

        /* NFTÂ±ïÁ§∫Âå∫ÂüüÊ†∑Âºè */
        .nft-section {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 2px solid #e9ecef;
        }

        .nft-section h2 {
            text-align: center;
            color: #333;
            margin-bottom: 25px;
            font-size: 2rem;
        }

        .tab-container {
            margin-bottom: 20px;
        }

        .tab-buttons {
            display: flex;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 20px;
        }

        .tab-button {
            background: none;
            border: none;
            padding: 12px 24px;
            font-size: 1.1rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            color: #6c757d;
            font-weight: 500;
        }

        .tab-button.active {
            color: #007bff;
            border-bottom-color: #007bff;
            background: rgba(0, 123, 255, 0.1);
        }

        .tab-button:hover:not(.active) {
            color: #495057;
            background: rgba(0, 0, 0, 0.05);
        }

        .tab-content {
            display: none;
            min-height: 200px;
        }

        .tab-content.active {
            display: block;
        }

        .nft-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .nft-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid #e9ecef;
        }

        .nft-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
        }

        .nft-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #6c757d;
        }

        .nft-svg {
            width: 100%;
            height: 100%;
        }

        .nft-info {
            padding: 15px;
        }

        .nft-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .nft-id {
            font-size: 0.9rem;
            color: #6c757d;
            font-family: monospace;
            margin-bottom: 8px;
        }

        .nft-traits {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .nft-trait {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            color: #1565c0;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        .empty-state h3 {
            color: #495057;
            margin-bottom: 10px;
        }

        .empty-state p {
            margin-bottom: 20px;
        }

        .refresh-nft-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .refresh-nft-btn:hover:not(:disabled) {
            background: #138496;
            transform: translateY(-1px);
        }

        .refresh-nft-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .wallet-detection {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .action-btn {
                width: 100%;
                max-width: 300px;
            }
            
            .nft-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 15px;
            }
            
            .tab-buttons {
                flex-direction: column;
            }
            
            .tab-button {
                width: 100%;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé≤ ËõáÂ∏ÅNFTÂ¢ûÂº∫ÊäΩÂ•ñ</h1>
            <p>ËøûÊé• LuckYou Èí±ÂåÖÔºåÊîØ‰ªò0.0001 ETHÂèÇ‰∏éÁúüÂÆûÊäΩÂ•ñÔºÅ</p>
        </div>

        <div class="wallet-section">
            <h2>üîó Êô∫ËÉΩÈí±ÂåÖÊ£ÄÊµã‰∏éËøûÊé•</h2>
            
            <div class="wallet-detection">
                <div id="luckyouOption" class="wallet-option not-detected">
                    <div class="wallet-header">
                        <span class="wallet-icon">üçÄ</span>
                        <span class="wallet-name">LuckYou Wallet</span>
                    </div>
                    <div id="luckyouStatus" class="wallet-status status-not-detected">
                        üîç Ê£ÄÊµã‰∏≠...
                    </div>
                    <button id="luckyouBtn" class="wallet-btn connect" onclick="connectLuckYou()" disabled>
                        ËøûÊé• LuckYou Èí±ÂåÖ
                    </button>
                </div>

                <div id="metamaskOption" class="wallet-option not-detected">
                    <div class="wallet-header">
                        <span class="wallet-icon">ü¶ä</span>
                        <span class="wallet-name">MetaMask</span>
                    </div>
                    <div id="metamaskStatus" class="wallet-status status-not-detected">
                        üîç Ê£ÄÊµã‰∏≠...
                    </div>
                    <button id="metamaskBtn" class="wallet-btn connect" onclick="connectMetaMask()" disabled>
                        ËøûÊé• MetaMask
                    </button>
                </div>
            </div>

            <div id="walletInfo" class="wallet-info">
                <!-- Èí±ÂåÖ‰ø°ÊÅØÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
            </div>
        </div>

        <div class="lottery-section">
            <h2>üéØ ÊäΩÂ•ñ‰ø°ÊÅØ</h2>
            
            <div class="contract-info">
                <h3>üìã ÂêàÁ∫¶‰ø°ÊÅØ</h3>
                <p><strong>ÂêàÁ∫¶Âú∞ÂùÄ:</strong> <span id="contractAddress">Êú™ËøûÊé•</span></p>
                <p><strong>ÁΩëÁªú:</strong> <span id="networkInfo">Êú™ËøûÊé•</span></p>
                <p><strong>Áä∂ÊÄÅ:</strong> <span id="contractStatus">Á≠âÂæÖËøûÊé•</span></p>
            </div>

            <div class="lottery-info">
                <div class="info-card">
                    <h3>üí∞ ÊäΩÂ•ñ‰ª∑Ê†º</h3>
                    <p id="lotteryPrice">0.0001 ETH</p>
                </div>
                <div class="info-card">
                    <h3>üé± Ê±†Â≠êÂ§ßÂ∞è</h3>
                    <p id="poolSize">-</p>
                </div>
                <div class="info-card">
                    <h3>üî¢ Â∑≤Èì∏ÈÄ†</h3>
                    <p id="totalMinted">-</p>
                </div>
                <div class="info-card">
                    <h3>üì¶ Ââ©‰ΩôÊï∞Èáè</h3>
                    <p id="remainingSupply">-</p>
                </div>
            </div>
            
            <div class="action-buttons">
                <button id="refreshInfoBtn" class="action-btn refresh" onclick="refreshContractInfo()">
                    üîÑ Âà∑Êñ∞‰ø°ÊÅØ
                </button>
                <button id="diagnoseBtn" class="action-btn diagnose" onclick="diagnoseNetwork()">
                    üîç ÁΩëÁªúËØäÊñ≠
                </button>
                <button id="resetBtn" class="action-btn" onclick="resetConnection()">
                    üîÑ ÈáçÁΩÆËøûÊé•
                </button>
            </div>

            <button id="lotteryBtn" class="lottery-btn" onclick="playLottery()" disabled>
                ËØ∑ÂÖàËøûÊé•Èí±ÂåÖ
            </button>

            <div id="statusDiv"></div>
        </div>

        <div class="nft-section">
            <h2>üñºÔ∏è ÊàëÁöÑNFTÊî∂Ëóè</h2>
            
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="switchTab('lottery-results')">
                        üé≤ ÊàëÁöÑÊäΩÂ•ñÁªìÊûú
                    </button>
                    <button class="tab-button" onclick="switchTab('owned-nfts')">
                        üíé ÊàëÊã•ÊúâÁöÑNFT
                    </button>
                </div>
                
                <div id="lottery-results" class="tab-content active">
                    <div class="empty-state">
                        <h3>üéØ ÊäΩÂ•ñÁªìÊûú</h3>
                        <p>ËøôÈáå‰ºöÊòæÁ§∫ÊÇ®ÊúÄËøëÊäΩÂ•ñËé∑ÂæóÁöÑNFT</p>
                        <button class="refresh-nft-btn" onclick="loadLotteryResults()" disabled>
                            üîÑ Âà∑Êñ∞ÊäΩÂ•ñÁªìÊûú
                        </button>
                        <button class="refresh-nft-btn" onclick="debugNFTLoading()" disabled style="margin-left: 10px; background: #ffc107; color: #212529;">
                            üêõ Ë∞ÉËØïNFTÂä†ËΩΩ
                        </button>
                    </div>
                    <div id="lottery-nfts" class="nft-grid"></div>
                </div>
                
                <div id="owned-nfts" class="tab-content">
                    <div class="empty-state">
                        <h3>üíº ÊàëÁöÑNFTÊî∂Ëóè</h3>
                        <p>ËøôÈáå‰ºöÊòæÁ§∫ÊÇ®Êã•ÊúâÁöÑÊâÄÊúâËõáÂ∏ÅNFT</p>
                        <button class="refresh-nft-btn" onclick="loadOwnedNFTs()" disabled>
                            üîÑ Âà∑Êñ∞NFTÊî∂Ëóè
                        </button>
                        <button class="refresh-nft-btn" onclick="debugNFTLoading()" disabled style="margin-left: 10px; background: #ffc107; color: #212529;">
                            üêõ Ë∞ÉËØïNFTÂä†ËΩΩ
                        </button>
                    </div>
                    <div id="owned-nfts-grid" class="nft-grid"></div>
                </div>
            </div>
        </div>

        <div class="tips">
            <h3>üí° ‰ΩøÁî®ÊèêÁ§∫</h3>
            <ul>
                <li>È¶ñÊ¨°‰ΩøÁî®ËØ∑Á°Æ‰øùÂ∑≤ÂÆâË£Ö LuckYou Èí±ÂåÖÊµèËßàÂô®Êâ©Â±ï</li>
                <li>Á°Æ‰øùÈí±ÂåÖËøûÊé•Âà∞Ê≠£Á°ÆÁöÑÁΩëÁªú (Hardhat Local Network)</li>
                <li>ÊØèÊ¨°ÊäΩÂ•ñÈúÄË¶ÅÊîØ‰ªò 0.0001 ETH ÁöÑË¥πÁî®</li>
                <li>ÊäΩÂ•ñÁªìÊûú‰∏∫ÈöèÊú∫ÁîüÊàêÁöÑËõáÂ∏ÅNFTÔºåÂõæÊ°àÁã¨‰∏ÄÊó†‰∫å</li>
                <li>Â¶ÇÈÅáËøûÊé•ÈóÆÈ¢òÔºåÂèØÁÇπÂáª"ÁΩëÁªúËØäÊñ≠"Êàñ"ÈáçÁΩÆËøûÊé•"</li>
            </ul>
        </div>
    </div>

    <script>
        // ÂêàÁ∫¶ÈÖçÁΩÆ
        const CONTRACT_ADDRESS = "0xCf7Ed3AccA5a467e9e704C703E8D87F634fB0Fc9";
        
        // Ê≠£Á°ÆÁöÑABIÊñπÊ≥ïÁ≠æÂêç
        const ABI_SIGNATURES = {
            lotteryPrice: '0xdbea52d8',
            getPoolSize: '0x23845e4b', 
            totalSupply: '0x18160ddd',
            playLottery: '0xd4cd77a3',
            balanceOf: '0x70a08231',
            ownerOf: '0x6352211e',
            tokenURI: '0xc87b56dd',
            generateSnakeSVG: '0x774f15a2'
        };

        // ÂÖ®Â±ÄÁä∂ÊÄÅ
        let walletProvider;
        let userAccount;
        let userBalance; 
        let currentWalletName;
        let connectionRetryCount = 0;
        const MAX_RETRY_COUNT = 3;

        // Èí±ÂåÖÊ£ÄÊµãÁªìÊûú
        let walletDetection = {
            luckyou: false,
            metamask: false
        };

        // NFTÁõ∏ÂÖ≥Áä∂ÊÄÅ
        let userNFTs = [];
        let lotteryResults = [];
        let currentActiveTab = 'lottery-results';

        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ
        window.addEventListener('load', function() {
            console.log('üöÄ Â¢ûÂº∫ÁâàÊäΩÂ•ñÈ°µÈù¢Âä†ËΩΩÂÆåÊàê');
            setTimeout(() => {
                detectWallets();
            }, 500);
        });

        // Ê£ÄÊµãÂèØÁî®Èí±ÂåÖ
        function detectWallets() {
            console.log('üîç ÂºÄÂßãÊ£ÄÊµãÈí±ÂåÖ...');
            
            // Ê£ÄÊµã LuckYou Èí±ÂåÖ
            detectLuckYouWallet();
            
            // Ê£ÄÊµã MetaMask
            detectMetaMask();
            
            // Âª∂ËøüÊ£ÄÊµãÔºåÁ°Æ‰øùÊâ©Â±ïÂÆåÂÖ®Âä†ËΩΩ
            setTimeout(() => {
                detectLuckYouWallet();
                detectMetaMask();
            }, 1000);
        }

        // Ê£ÄÊµã LuckYou Èí±ÂåÖ
        function detectLuckYouWallet() {
            const option = document.getElementById('luckyouOption');
            const status = document.getElementById('luckyouStatus');
            const btn = document.getElementById('luckyouBtn');
            
            let detected = false;
            
            if (typeof window.luckYou !== 'undefined') {
                detected = true;
                console.log('‚úÖ Ê£ÄÊµãÂà∞‰∏ªË¶Å LuckYou Èí±ÂåÖÂØπË±°');
            } else if (window.luckyouWallet && window.luckyouWallet.isLuckYouWallet) {
                detected = true;
                console.log('‚úÖ Ê£ÄÊµãÂà∞Êõø‰ª£ LuckYou Èí±ÂåÖÂØπË±°');
            } else {
                console.log('‚ùå Êú™Ê£ÄÊµãÂà∞ LuckYou Èí±ÂåÖ');
            }
            
            walletDetection.luckyou = detected;
            
            if (detected) {
                option.className = 'wallet-option detected';
                status.className = 'wallet-status status-detected';
                status.textContent = '‚úÖ Â∑≤Ê£ÄÊµãÂà∞ÔºåÂèØ‰ª•ËøûÊé•';
                btn.disabled = false;
            } else {
                option.className = 'wallet-option not-detected';
                status.className = 'wallet-status status-not-detected';
                status.textContent = '‚ùå Êú™ÂÆâË£ÖÊàñÊú™ÂêØÁî®';
                btn.disabled = true;
                btn.textContent = 'ËØ∑ÂÆâË£Ö LuckYou Èí±ÂåÖ';
            }
        }

        // Ê£ÄÊµã MetaMask
        function detectMetaMask() {
            const option = document.getElementById('metamaskOption');
            const status = document.getElementById('metamaskStatus');
            const btn = document.getElementById('metamaskBtn');
            
            let detected = false;
            
            if (window.ethereum && window.ethereum.isMetaMask) {
                detected = true;
                console.log('‚úÖ Ê£ÄÊµãÂà∞ MetaMask');
            } else {
                console.log('‚ùå Êú™Ê£ÄÊµãÂà∞ MetaMask');
            }
            
            walletDetection.metamask = detected;
            
            if (detected) {
                option.className = 'wallet-option detected';
                status.className = 'wallet-status status-detected';
                status.textContent = '‚úÖ Â∑≤Ê£ÄÊµãÂà∞ÔºåÂèØ‰ª•ËøûÊé•';
                btn.disabled = false;
            } else {
                option.className = 'wallet-option not-detected';
                status.className = 'wallet-status status-not-detected';
                status.textContent = '‚ùå Êú™ÂÆâË£ÖÊàñÊú™ÂêØÁî®';
                btn.disabled = true;
                btn.textContent = 'ËØ∑ÂÆâË£Ö MetaMask';
            }
        }

        // ËøûÊé• LuckYou Èí±ÂåÖ
        async function connectLuckYou() {
            const btn = document.getElementById('luckyouBtn');
            const option = document.getElementById('luckyouOption');
            const status = document.getElementById('luckyouStatus');
            
            try {
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner"></span> ËøûÊé•‰∏≠...';
                showStatus('üîÑ Ê≠£Âú®ËøûÊé• LuckYou Èí±ÂåÖ...', 'info');
                
                let provider;
                
                if (typeof window.luckYou !== 'undefined') {
                    provider = window.luckYou;
                } else if (window.luckyouWallet && window.luckyouWallet.isLuckYouWallet) {
                    provider = window.luckyouWallet;
                } else {
                    throw new Error('Êú™Ê£ÄÊµãÂà∞ LuckYou Èí±ÂåÖÔºåËØ∑ÂÆâË£ÖÊâ©Â±ïÔºÅ');
                }
                
                // ËØ∑Ê±ÇË¥¶Êà∑ËøûÊé•
                const accounts = await provider.request({
                    method: 'eth_requestAccounts'
                });
                
                if (!accounts || accounts.length === 0) {
                    throw new Error('Áî®Êà∑ÊãíÁªùËøûÊé•ÊàñÊ≤°ÊúâÂèØÁî®Ë¥¶Êà∑');
                }
                
                await setupWalletConnection(provider, 'LuckYou Wallet', accounts[0]);
                
                // Êõ¥Êñ∞UIÁä∂ÊÄÅ
                option.className = 'wallet-option connected';
                status.className = 'wallet-status status-connected';
                status.textContent = 'üîó Â∑≤ËøûÊé•';
                btn.className = 'wallet-btn disconnect';
                btn.textContent = 'Êñ≠ÂºÄËøûÊé•';
                btn.onclick = disconnectWallet;
                
                showStatus('‚úÖ LuckYou Èí±ÂåÖËøûÊé•ÊàêÂäüÔºÅ', 'success');
                connectionRetryCount = 0;
                
            } catch (error) {
                console.error('LuckYou ËøûÊé•Â§±Ë¥•:', error);
                showStatus(`‚ùå LuckYou ËøûÊé•Â§±Ë¥•: ${error.message}`, 'error');
                
                // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                btn.disabled = false;
                btn.innerHTML = 'ËøûÊé• LuckYou Èí±ÂåÖ';
                
                // ËøûÊé•ÈáçËØïÈÄªËæë
                if (connectionRetryCount < MAX_RETRY_COUNT) {
                    connectionRetryCount++;
                    showStatus(`üîÑ Â∞ÜÂú®3ÁßíÂêéÈáçËØïËøûÊé• (${connectionRetryCount}/${MAX_RETRY_COUNT})`, 'warning');
                    setTimeout(() => {
                        connectLuckYou();
                    }, 3000);
                }
            }
        }

        // ËøûÊé• MetaMask
        async function connectMetaMask() {
            const btn = document.getElementById('metamaskBtn');
            const option = document.getElementById('metamaskOption');
            const status = document.getElementById('metamaskStatus');
            
            try {
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner"></span> ËøûÊé•‰∏≠...';
                showStatus('üîÑ Ê≠£Âú®ËøûÊé• MetaMask...', 'info');
                
                if (!window.ethereum || !window.ethereum.isMetaMask) {
                    throw new Error('Êú™Ê£ÄÊµãÂà∞ MetaMaskÔºåËØ∑ÂÆâË£ÖÊâ©Â±ïÔºÅ');
                }
                
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });
                
                if (!accounts || accounts.length === 0) {
                    throw new Error('Áî®Êà∑ÊãíÁªùËøûÊé•ÊàñÊ≤°ÊúâÂèØÁî®Ë¥¶Êà∑');
                }
                
                await setupWalletConnection(window.ethereum, 'MetaMask', accounts[0]);
                
                // Êõ¥Êñ∞UIÁä∂ÊÄÅ
                option.className = 'wallet-option connected';
                status.className = 'wallet-status status-connected';
                status.textContent = 'üîó Â∑≤ËøûÊé•';
                btn.className = 'wallet-btn disconnect';
                btn.textContent = 'Êñ≠ÂºÄËøûÊé•';
                btn.onclick = disconnectWallet;
                
                showStatus('‚úÖ MetaMask ËøûÊé•ÊàêÂäüÔºÅ', 'success');
                connectionRetryCount = 0;
                
            } catch (error) {
                console.error('MetaMask ËøûÊé•Â§±Ë¥•:', error);
                showStatus(`‚ùå MetaMask ËøûÊé•Â§±Ë¥•: ${error.message}`, 'error');
                
                // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                btn.disabled = false;
                btn.innerHTML = 'ËøûÊé• MetaMask';
            }
        }

        // ËÆæÁΩÆÈí±ÂåÖËøûÊé•
        async function setupWalletConnection(provider, walletName, account) {
            walletProvider = provider;
            currentWalletName = walletName;
            userAccount = account;
            
            console.log(`${walletName} Ë¥¶Êà∑Âú∞ÂùÄ:`, userAccount);
            
            // Ê£ÄÊü•ÁΩëÁªú
            const chainId = await provider.request({ method: 'eth_chainId' });
            const networkName = getNetworkName(chainId);
            
            console.log(`${walletName} ÁΩëÁªú Chain ID:`, chainId);
            console.log(`${walletName} ÁΩëÁªúÂêçÁß∞:`, networkName);
            
            // ÁΩëÁªúÊ£ÄÊü•ÂíåÂàáÊç¢ - ‰øÆÂ§çÂêéÁöÑÈí±ÂåÖÂ∫îËØ•ÈªòËÆ§‰ΩøÁî®Ê≠£Á°ÆÁΩëÁªú
            if (chainId !== '0x539' && chainId !== '0x31337' && chainId !== '0x7a69') {
                showStatus('‚ö†Ô∏è ÂΩìÂâçÁΩëÁªú‰∏çÂåπÈÖçÔºåÂ∞ùËØïÂàáÊç¢Âà∞Êú¨Âú∞ Hardhat ÁΩëÁªú...', 'warning');
                
                try {
                    await provider.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: '0x7a69' }]
                    });
                    console.log('Â∑≤ÂàáÊç¢Âà∞ Hardhat ÁΩëÁªú');
                    // ÂàáÊç¢ÊàêÂäüÂêéÔºåÈáçÊñ∞Ëé∑ÂèñÈìæID‰ª•Á°ÆËÆ§
                    const newChainId = await provider.request({ method: 'eth_chainId' });
                    console.log('ÂàáÊç¢ÂêéÁöÑÁΩëÁªú Chain ID:', newChainId);
                } catch (switchError) {
                    console.warn('ÁΩëÁªúÂàáÊç¢Â§±Ë¥•:', switchError);
                    showStatus('‚ùå ÁΩëÁªúÂàáÊç¢Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Èí±ÂåÖÈÖçÁΩÆÊàñÊâãÂä®ÂàáÊç¢', 'error');
                    throw switchError;
                }
            } else {
                console.log('‚úÖ ÁΩëÁªúÂåπÈÖçÔºå‰ΩøÁî®ÂΩìÂâçÁΩëÁªú');
            }
            
            // Ëé∑ÂèñË¥¶Êà∑‰ΩôÈ¢ù - Â¢ûÂº∫ÁöÑÈîôËØØÂ§ÑÁêÜÂíåÈáçËØïÊú∫Âà∂
            try {
                console.log(`Ê≠£Âú®Ëé∑Âèñ ${walletName} Ë¥¶Êà∑‰ΩôÈ¢ù...`);
                const balanceResult = await provider.request({
                    method: 'eth_getBalance',
                    params: [userAccount, 'latest']
                });
                
                console.log(`${walletName} ÂéüÂßã‰ΩôÈ¢ùÁªìÊûú:`, balanceResult, typeof balanceResult);
                userBalance = typeof balanceResult === 'string' ? balanceResult : '0x0';
                console.log(`${walletName} Â§ÑÁêÜÂêé‰ΩôÈ¢ù:`, userBalance);
                
                // È™åËØÅ‰ΩôÈ¢ùÊ†ºÂºè
                if (!userBalance.startsWith('0x')) {
                    console.warn('‰ΩôÈ¢ùÊ†ºÂºèÂºÇÂ∏∏ÔºåÂ∞ùËØï‰øÆÊ≠£:', userBalance);
                    userBalance = '0x0';
                }
                
            } catch (balanceError) {
                console.error('Ëé∑Âèñ‰ΩôÈ¢ùÂ§±Ë¥•:', balanceError);
                userBalance = '0x0';
                showStatus('‚ö†Ô∏è ‰ΩôÈ¢ùËé∑ÂèñÂ§±Ë¥•Ôºå‰ΩÜËøûÊé•ÊàêÂäü', 'warning');
            }
            
            // Êõ¥Êñ∞UIÂíåÂêØÁî®ÂäüËÉΩ
            updateWalletInfo(userAccount, userBalance, networkName, walletName);
            await updateLotteryInfo();
            enableLottery();
            enableNFTFeatures();
            
            // ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
            setupWalletEventListeners(provider);
        }

        // ËÆæÁΩÆÈí±ÂåÖ‰∫ã‰ª∂ÁõëÂê¨Âô®
        function setupWalletEventListeners(provider) {
            if (!provider.on) return;
            
            // Ë¥¶Êà∑ÂèòÊõ¥ÁõëÂê¨
            provider.on('accountsChanged', (accounts) => {
                console.log('Ë¥¶Êà∑ÂèòÊõ¥:', accounts);
                if (accounts.length === 0) {
                    disconnectWallet();
                } else {
                    userAccount = accounts[0];
                    location.reload(); // ÁÆÄÂçïÈáçÊñ∞Âä†ËΩΩÈ°µÈù¢
                }
            });
            
            // ÁΩëÁªúÂèòÊõ¥ÁõëÂê¨
            provider.on('chainChanged', (chainId) => {
                console.log('ÁΩëÁªúÂèòÊõ¥:', chainId);
                location.reload(); // ÁÆÄÂçïÈáçÊñ∞Âä†ËΩΩÈ°µÈù¢
            });
        }

        // Êñ≠ÂºÄÈí±ÂåÖËøûÊé•
        function disconnectWallet() {
            // ÈáçÁΩÆÂÖ®Â±ÄÁä∂ÊÄÅ
            walletProvider = null;
            userAccount = null;
            userBalance = null;
            currentWalletName = null;
            connectionRetryCount = 0;
            
            // ÈáçÁΩÆUI
            document.getElementById('walletInfo').style.display = 'none';
            document.getElementById('lotteryBtn').disabled = true;
            document.getElementById('lotteryBtn').innerHTML = 'ËØ∑ÂÖàËøûÊé•Èí±ÂåÖ';
            
            // ÈáçÁΩÆÂêàÁ∫¶‰ø°ÊÅØ
            document.getElementById('contractAddress').textContent = 'Êú™ËøûÊé•';
            document.getElementById('networkInfo').textContent = 'Êú™ËøûÊé•';
            document.getElementById('contractStatus').textContent = 'Á≠âÂæÖËøûÊé•';
            
            // ÈáçÁΩÆÈí±ÂåÖÈÄâÈ°πÁä∂ÊÄÅ
            resetWalletOptions();
            
            showStatus('üîå Èí±ÂåÖÂ∑≤Êñ≠ÂºÄËøûÊé•', 'info');
            
            // ÈáçÊñ∞Ê£ÄÊµãÈí±ÂåÖ
            setTimeout(() => {
                detectWallets();
            }, 1000);
        }

        // ÈáçÁΩÆÈí±ÂåÖÈÄâÈ°πÁä∂ÊÄÅ
        function resetWalletOptions() {
            const walletOptions = ['luckyou', 'metamask'];
            
            walletOptions.forEach(wallet => {
                const option = document.getElementById(`${wallet}Option`);
                const status = document.getElementById(`${wallet}Status`);
                const btn = document.getElementById(`${wallet}Btn`);
                
                if (walletDetection[wallet]) {
                    option.className = 'wallet-option detected';
                    status.className = 'wallet-status status-detected';
                    status.textContent = '‚úÖ Â∑≤Ê£ÄÊµãÂà∞ÔºåÂèØ‰ª•ËøûÊé•';
                    btn.className = 'wallet-btn connect';
                    btn.disabled = false;
                    
                    if (wallet === 'luckyou') {
                        btn.textContent = 'ËøûÊé• LuckYou Èí±ÂåÖ';
                        btn.onclick = connectLuckYou;
                    } else if (wallet === 'metamask') {
                        btn.textContent = 'ËøûÊé• MetaMask';
                        btn.onclick = connectMetaMask;
                    }
                }
            });
        }

        // ÈáçÁΩÆËøûÊé•
        function resetConnection() {
            showStatus('üîÑ Ê≠£Âú®ÈáçÁΩÆËøûÊé•...', 'info');
            disconnectWallet();
            
            setTimeout(() => {
                detectWallets();
                showStatus('‚úÖ ËøûÊé•Â∑≤ÈáçÁΩÆÔºåËØ∑ÈáçÊñ∞ÈÄâÊã©Èí±ÂåÖ', 'success');
            }, 1500);
        }

        // Êõ¥Êñ∞Èí±ÂåÖ‰ø°ÊÅØÊòæÁ§∫
        function updateWalletInfo(account, balance, network, walletName) {
            const walletInfo = document.getElementById('walletInfo');
            const contractAddress = document.getElementById('contractAddress');
            const networkInfo = document.getElementById('networkInfo');
            const contractStatus = document.getElementById('contractStatus');
            
            walletInfo.style.display = 'block';
            
            // ÂÆâÂÖ®ËΩ¨Êç¢‰ΩôÈ¢ù
            let balanceDisplay = '0 ETH';
            try {
                if (balance && typeof balance === 'string' && balance !== '0x0') {
                    const balanceWei = BigInt(balance);
                    const balanceEth = Number(balanceWei) / Math.pow(10, 18);
                    balanceDisplay = `${balanceEth.toFixed(6)} ETH`;
                }
            } catch (error) {
                console.error('‰ΩôÈ¢ùËΩ¨Êç¢Â§±Ë¥•:', error);
                balanceDisplay = '0 ETH';
            }
            
            walletInfo.innerHTML = `
                <h3>üíº Èí±ÂåÖ‰ø°ÊÅØ</h3>
                <p><strong>Èí±ÂåÖÁ±ªÂûã:</strong> ${walletName}</p>
                <p><strong>Ë¥¶Êà∑Âú∞ÂùÄ:</strong> ${account}</p>
                <p><strong>Ë¥¶Êà∑‰ΩôÈ¢ù:</strong> ${balanceDisplay}</p>
                <p><strong>ÁΩëÁªú:</strong> ${network}</p>
                <p><strong>ËøûÊé•Áä∂ÊÄÅ:</strong> ‚úÖ Â∑≤ËøûÊé•</p>
            `;
            
            contractAddress.textContent = CONTRACT_ADDRESS;
            networkInfo.textContent = network;
            contractStatus.textContent = '‚úÖ Â∑≤ËøûÊé•';
        }

        // Ëé∑ÂèñÁΩëÁªúÂêçÁß∞
        function getNetworkName(chainId) {
            const networks = {
                '0x1': 'Ethereum Mainnet',
                '0x3': 'Ropsten Testnet',
                '0x4': 'Rinkeby Testnet', 
                '0x5': 'Goerli Testnet',
                '0x2a': 'Kovan Testnet',
                '0x7a69': 'Hardhat Local Network',
                '0x539': 'Hardhat Local Network',
                '0x31337': 'Hardhat Local Network'
            };
            return networks[chainId] || `Chain ID: ${chainId}`;
        }

        // ÂêØÁî®ÊäΩÂ•ñÂäüËÉΩ
        function enableLottery() {
            const lotteryBtn = document.getElementById('lotteryBtn');
            lotteryBtn.disabled = false;
            lotteryBtn.innerHTML = 'üé≤ ÂºÄÂßãÊäΩÂ•ñ (0.0001 ETH)';
        }

        // ÂéüÂßãÂêàÁ∫¶Ë∞ÉÁî® - Â¢ûÂº∫ÁâàÔºåÈÖçÂêà‰øÆÂ§çÂêéÁöÑRPC
        async function rawContractCall(methodSignature, decodeType = 'uint256') {
            if (!walletProvider) {
                throw new Error('Èí±ÂåÖÊú™ËøûÊé•');
            }

            try {
                console.log(`ÂèëËµ∑ÂêàÁ∫¶Ë∞ÉÁî®: ${methodSignature} -> ${CONTRACT_ADDRESS}`);
                
                // Ê∑ªÂä†Ë∂ÖÊó∂Â§ÑÁêÜ
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('ÂêàÁ∫¶Ë∞ÉÁî®Ë∂ÖÊó∂')), 10000);
                });
                
                const callPromise = walletProvider.request({
                    method: 'eth_call',
                    params: [{
                        to: CONTRACT_ADDRESS,
                        data: methodSignature
                    }, 'latest']
                });
                
                const result = await Promise.race([callPromise, timeoutPromise]);

                console.log(`ÂêàÁ∫¶Ë∞ÉÁî®ÊàêÂäü ${methodSignature}:`, result, typeof result);

                // Â¢ûÂº∫ÁöÑÁªìÊûúÈ™åËØÅÂíåÂ§ÑÁêÜ
                if (result && typeof result === 'string' && result.startsWith('0x')) {
                    if (decodeType === 'uint256') {
                        try {
                            const bigIntValue = BigInt(result);
                            const stringValue = bigIntValue.toString();
                            console.log(`Ëß£Á†Å uint256: ${result} -> ${stringValue}`);
                            return stringValue;
                        } catch (parseError) {
                            console.error(`Ëß£Á†ÅÂ§±Ë¥• ${methodSignature}:`, parseError);
                            return '0';
                        }
                    } else if (decodeType === 'address') {
                        // Â§ÑÁêÜÂú∞ÂùÄÁ±ªÂûãËøîÂõûÂÄº
                        // Ê†ºÂºèÔºö0x00000000000000000000000070997970c51812dc3a010c7d01b50e0d17dc79c8
                        // ÈúÄË¶ÅÊèêÂèñÊúÄÂêé20Â≠óËäÇÔºà40‰∏™ÂçÅÂÖ≠ËøõÂà∂Â≠óÁ¨¶Ôºâ
                        if (result.length === 66) {
                            const address = '0x' + result.slice(26).toLowerCase(); // 2 + 24 = 26
                            console.log(`Ëß£Á†Å address: ${result} -> ${address}`);
                            return address;
                        } else if (result.length === 42) {
                            console.log(`Âú∞ÂùÄÂ∑≤ÊòØÊ†áÂáÜÊ†ºÂºè: ${result}`);
                            return result.toLowerCase();
                        } else {
                            console.warn(`ÊÑèÂ§ñÁöÑÂú∞ÂùÄÊ†ºÂºè: ${result}`);
                            return result;
                        }
                    } else if (decodeType === 'string') {
                        // Â§ÑÁêÜÂ≠óÁ¨¶‰∏≤Á±ªÂûãËøîÂõûÂÄº
                        console.log(`Ëß£Á†Å string: ${result.substring(0, 100)}...`);
                        return result; // ËøîÂõûÂéüÂßãÂçÅÂÖ≠ËøõÂà∂ÔºåËÆ©Ë∞ÉÁî®ËÄÖÂ§ÑÁêÜ
                    }
                    return result;
                }
                
                console.warn(`ÂºÇÂ∏∏ÁöÑÂêàÁ∫¶Ë∞ÉÁî®ÁªìÊûú ${methodSignature}:`, result);
                return '0';
                
            } catch (error) {
                console.error(`ÂêàÁ∫¶Ë∞ÉÁî®Â§±Ë¥• ${methodSignature}:`, error);
                
                // Â¶ÇÊûúÊòØË∂ÖÊó∂ÈîôËØØÔºåÊèê‰æõÊõ¥ÂèãÂ•ΩÁöÑÊèêÁ§∫
                if (error.message.includes('timeout')) {
                    console.warn('ÂêàÁ∫¶Ë∞ÉÁî®Ë∂ÖÊó∂ÔºåÂèØËÉΩÊòØÁΩëÁªúÊàñËäÇÁÇπÈóÆÈ¢ò');
                }
                
                return '0';
            }
        }

        // Êõ¥Êñ∞ÊäΩÂ•ñ‰ø°ÊÅØ
        async function updateLotteryInfo() {
            if (!walletProvider) {
                console.log('Èí±ÂåÖÊú™ËøûÊé•ÔºåË∑≥ËøáÊõ¥Êñ∞ÊäΩÂ•ñ‰ø°ÊÅØ');
                return;
            }
            
            try {
                console.log('üîÑ Ëé∑ÂèñÂÆûÊó∂ÊäΩÂ•ñ‰ø°ÊÅØ...');
                showStatus('üîÑ Êõ¥Êñ∞ÊäΩÂ•ñ‰ø°ÊÅØ‰∏≠...', 'info');
                
                const [price, poolSize, totalMinted] = await Promise.all([
                    rawContractCall(ABI_SIGNATURES.lotteryPrice),
                    rawContractCall(ABI_SIGNATURES.getPoolSize),
                    rawContractCall(ABI_SIGNATURES.totalSupply)
                ]);
                
                console.log('Ëé∑ÂèñÂà∞ÁöÑÊï∞ÊçÆ:', { price, poolSize, totalMinted });
                
                // ËÆ°ÁÆóÂâ©‰ΩôÊï∞Èáè
                const maxSupply = 1000;
                const remaining = maxSupply - parseInt(totalMinted || 0);
                
                // Êõ¥Êñ∞UI
                try {
                    const priceInEth = price === '0' ? '0.0001' : (BigInt(price) / BigInt(Math.pow(10, 18))).toString();
                    document.getElementById('lotteryPrice').textContent = `${priceInEth} ETH`;
                    document.getElementById('poolSize').textContent = poolSize || '0';
                    document.getElementById('totalMinted').textContent = totalMinted || '0';
                    document.getElementById('remainingSupply').textContent = remaining.toString();
                    
                    console.log('‚úÖ ÊäΩÂ•ñ‰ø°ÊÅØÊõ¥Êñ∞ÊàêÂäü');
                    showStatus('‚úÖ ÊäΩÂ•ñ‰ø°ÊÅØÂ∑≤Êõ¥Êñ∞', 'success');
                    
                } catch (uiError) {
                    console.error('Êõ¥Êñ∞UIÂ§±Ë¥•:', uiError);
                    showStatus('‚ö†Ô∏è ‰ø°ÊÅØÊõ¥Êñ∞ÈÉ®ÂàÜÂ§±Ë¥•', 'warning');
                }
                
            } catch (error) {
                console.error('Ëé∑ÂèñÊäΩÂ•ñ‰ø°ÊÅØÂ§±Ë¥•:', error);
                showStatus('‚ö†Ô∏è Êó†Ê≥ïËé∑ÂèñÂÆûÊó∂ÊäΩÂ•ñ‰ø°ÊÅØÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•', 'warning');
            }
        }

        // Âà∑Êñ∞ÂêàÁ∫¶‰ø°ÊÅØ
        async function refreshContractInfo() {
            if (!walletProvider) {
                showStatus('‚ùå ËØ∑ÂÖàËøûÊé•Èí±ÂåÖ', 'error');
                return;
            }
            
            const btn = document.getElementById('refreshInfoBtn');
            const originalText = btn.textContent;
            
            try {
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner"></span> Âà∑Êñ∞‰∏≠...';
                
                await updateLotteryInfo();
                
            } catch (error) {
                console.error('Âà∑Êñ∞Â§±Ë¥•:', error);
                showStatus(`‚ùå Âà∑Êñ∞Â§±Ë¥•: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // ÁΩëÁªúËØäÊñ≠ - Â¢ûÂº∫Áâà
        async function diagnoseNetwork() {
            if (!walletProvider) {
                showStatus('‚ùå ËØ∑ÂÖàËøûÊé•Èí±ÂåÖ', 'error');
                return;
            }
            
            const btn = document.getElementById('diagnoseBtn');
            const originalText = btn.textContent;
            
            try {
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner"></span> ËØäÊñ≠‰∏≠...';
                showStatus('üîç Ê≠£Âú®ËøõË°åÂÖ®Èù¢ÁΩëÁªúËØäÊñ≠...', 'info');
                
                console.log('üîç ÂºÄÂßãÂ¢ûÂº∫ÁΩëÁªúËØäÊñ≠...');
                
                // 1. Ê£ÄÊü•ÁΩëÁªú‰ø°ÊÅØ
                const chainId = await walletProvider.request({ method: 'eth_chainId' });
                const networkName = getNetworkName(chainId);
                console.log('‚úÖ ÂΩìÂâçÁΩëÁªú:', chainId, networkName);
                
                if (chainId !== '0x539' && chainId !== '0x31337' && chainId !== '0x7a69') {
                    showStatus('‚ùå ÁΩëÁªú‰∏çÂåπÈÖçÔºöÂêàÁ∫¶‰ªÖÈÄÇÁî®‰∫éÊú¨Âú∞ Hardhat ÁΩëÁªú', 'error');
                    return;
                }
                
                // 2. Ê£ÄÊü• RPC ËøûÊé•
                try {
                    const latestBlock = await walletProvider.request({
                        method: 'eth_blockNumber',
                        params: []
                    });
                    console.log('‚úÖ RPCËøûÊé•Ê≠£Â∏∏ÔºåÊúÄÊñ∞Âå∫ÂùóÂè∑:', latestBlock);
                } catch (rpcError) {
                    console.error('‚ùå RPCËøûÊé•Â§±Ë¥•:', rpcError);
                    showStatus('‚ùå RPCËøûÊé•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•HardhatËäÇÁÇπ', 'error');
                    return;
                }
                
                // 3. Ê£ÄÊü•ÂêàÁ∫¶‰ª£Á†Å
                const code = await walletProvider.request({
                    method: 'eth_getCode',
                    params: [CONTRACT_ADDRESS, 'latest']
                });
                
                if (!code || code === '0x' || code === '0x0') {
                    showStatus('‚ùå ÂêàÁ∫¶Êú™ÈÉ®ÁΩ≤ÔºÅËØ∑ËøêË°å: npm run deploy:local', 'error');
                    console.error('ÂêàÁ∫¶Âú∞ÂùÄÊó†‰ª£Á†Å:', CONTRACT_ADDRESS);
                    return;
                }
                
                console.log('‚úÖ ÂêàÁ∫¶Â∑≤ÈÉ®ÁΩ≤Ôºå‰ª£Á†ÅÈïøÂ∫¶:', code.length);
                
                // 4. ÊµãËØïÊâÄÊúâÂêàÁ∫¶ÊñπÊ≥ï
                console.log('üß™ ÊµãËØïÂêàÁ∫¶ÊñπÊ≥ïË∞ÉÁî®...');
                const [price, poolSize, totalMinted] = await Promise.all([
                    rawContractCall(ABI_SIGNATURES.lotteryPrice).catch(() => 'fail'),
                    rawContractCall(ABI_SIGNATURES.getPoolSize).catch(() => 'fail'),
                    rawContractCall(ABI_SIGNATURES.totalSupply).catch(() => 'fail')
                ]);
                
                if (price === 'fail' || poolSize === 'fail' || totalMinted === 'fail') {
                    showStatus('‚ö†Ô∏è ÈÉ®ÂàÜÂêàÁ∫¶ÊñπÊ≥ïË∞ÉÁî®Â§±Ë¥•ÔºåÂêàÁ∫¶ÂèØËÉΩÊú™ÂàùÂßãÂåñ', 'warning');
                    console.warn('ÂêàÁ∫¶ÊñπÊ≥ïÊµãËØïÁªìÊûú:', { price, poolSize, totalMinted });
                } else {
                    console.log('‚úÖ ÊâÄÊúâÂêàÁ∫¶ÊñπÊ≥ïË∞ÉÁî®ÊàêÂäü:', { price, poolSize, totalMinted });
                }
                
                // 5. Ê£ÄÊü•Ë¥¶Êà∑‰ΩôÈ¢ù
                const balance = await walletProvider.request({
                    method: 'eth_getBalance',
                    params: [userAccount, 'latest']
                });
                
                const balanceEth = Number(BigInt(balance)) / Math.pow(10, 18);
                console.log('‚úÖ Ë¥¶Êà∑‰ΩôÈ¢ù:', balanceEth.toFixed(4), 'ETH');
                
                // 6. Ê£ÄÊü•ÊäΩÂ•ñÊ±†Áä∂ÊÄÅ
                if (poolSize === '0') {
                    showStatus('‚ö†Ô∏è ËØäÊñ≠ÂÆåÊàêÔºå‰ΩÜÊäΩÂ•ñÊ±†Êú™ÂàùÂßãÂåñ„ÄÇËØ∑ËøêË°åÂàùÂßãÂåñËÑöÊú¨„ÄÇ', 'warning');
                } else {
                    showStatus('‚úÖ ÁΩëÁªúËØäÊñ≠ÂÆåÊàêÔºöÊâÄÊúâÁ≥ªÁªüÊ≠£Â∏∏ËøêË°åÔºÅ', 'success');
                }
                
            } catch (error) {
                console.error('ÁΩëÁªúËØäÊñ≠Â§±Ë¥•:', error);
                if (error.message.includes('timeout')) {
                    showStatus('‚ùå ÁΩëÁªúËØäÊñ≠Ë∂ÖÊó∂ÔºöËØ∑Ê£ÄÊü•HardhatËäÇÁÇπÊòØÂê¶ËøêË°å', 'error');
                } else {
                    showStatus(`‚ùå ÁΩëÁªúËØäÊñ≠Â§±Ë¥•: ${error.message}`, 'error');
                }
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // ÊäΩÂ•ñÂäüËÉΩ
        async function playLottery() {
            if (!walletProvider || !userAccount) {
                showStatus('‚ùå ËØ∑ÂÖàËøûÊé•Èí±ÂåÖ', 'error');
                return;
            }

            const lotteryBtn = document.getElementById('lotteryBtn');
            const originalText = lotteryBtn.innerHTML;
            
            try {
                lotteryBtn.disabled = true;
                lotteryBtn.innerHTML = '<span class="spinner"></span> ÊäΩÂ•ñ‰∏≠...';
                showStatus('üé≤ Ê≠£Âú®Êèê‰∫§ÊäΩÂ•ñ‰∫§Êòì...', 'info');
                
                // Ëé∑ÂèñÊäΩÂ•ñ‰ª∑Ê†º
                const priceStr = await rawContractCall(ABI_SIGNATURES.lotteryPrice);
                const price = priceStr === '0' ? '0x5AF3107A4000' : '0x' + BigInt(priceStr).toString(16); // ÈªòËÆ§ 0.0001 ETH
                
                console.log('ÊäΩÂ•ñ‰ª∑Ê†º:', price);
                
                // Ê£ÄÊü•‰ΩôÈ¢ù
                const balanceStr = await walletProvider.request({
                    method: 'eth_getBalance',
                    params: [userAccount, 'latest']
                });
                
                const userBalanceBig = BigInt(balanceStr);
                const priceBig = BigInt(price);
                
                if (userBalanceBig < priceBig) {
                    throw new Error('‰ΩôÈ¢ù‰∏çË∂≥ÔºåÊó†Ê≥ïÊîØ‰ªòÊäΩÂ•ñË¥πÁî®');
                }
                
                // ÂèëÈÄÅÊäΩÂ•ñ‰∫§Êòì
                const txHash = await walletProvider.request({
                    method: 'eth_sendTransaction',
                    params: [{
                        from: userAccount,
                        to: CONTRACT_ADDRESS,
                        value: price,
                        data: ABI_SIGNATURES.playLottery,
                        gas: '0x493e0' // 300000
                    }]
                });
                
                console.log('ÊäΩÂ•ñ‰∫§ÊòìÂìàÂ∏å:', txHash);
                showStatus(`üéâ ÊäΩÂ•ñ‰∫§ÊòìÂ∑≤Êèê‰∫§ÔºÅ‰∫§ÊòìÂìàÂ∏å: ${txHash}`, 'success');
                
                // Á≠âÂæÖ‰∏Ä‰ºöÂÑøÂÜçÊõ¥Êñ∞‰ø°ÊÅØ
                setTimeout(async () => {
                    await updateLotteryInfo();
                    
                    // Â¶ÇÊûúÂΩìÂâçÂú®NFTÊ†áÁ≠æÈ°µÔºåËá™Âä®Âà∑Êñ∞NFTÊï∞ÊçÆ
                    if (currentActiveTab === 'lottery-results') {
                        await loadLotteryResults();
                        showStatus('üéâ ÊäΩÂ•ñÊàêÂäüÔºÅNFTÂ∑≤Ê∑ªÂä†Âà∞ÊÇ®ÁöÑÊî∂Ëóè‰∏≠', 'success');
                    } else if (currentActiveTab === 'owned-nfts') {
                        await loadOwnedNFTs();
                        showStatus('üéâ ÊäΩÂ•ñÊàêÂäüÔºÅÊÇ®ÁöÑNFTÊî∂ËóèÂ∑≤Êõ¥Êñ∞', 'success');
                    } else {
                        showStatus('üîÑ ÊäΩÂ•ñ‰ø°ÊÅØÂ∑≤Êõ¥Êñ∞', 'info');
                    }
                }, 3000);
                
            } catch (error) {
                console.error('ÊäΩÂ•ñÂ§±Ë¥•:', error);
                
                let errorMessage = error.message;
                if (error.code === 4001) {
                    errorMessage = 'Áî®Êà∑ÊãíÁªù‰∫Ü‰∫§Êòì';
                } else if (error.code === -32603) {
                    errorMessage = '‰∫§ÊòìÊâßË°åÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÂíåÂêàÁ∫¶Áä∂ÊÄÅ';
                }
                
                showStatus(`‚ùå ÊäΩÂ•ñÂ§±Ë¥•: ${errorMessage}`, 'error');
            } finally {
                lotteryBtn.disabled = false;
                lotteryBtn.innerHTML = originalText;
            }
        }

        // ÊòæÁ§∫Áä∂ÊÄÅÊ∂àÊÅØ
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusDiv');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            
            // Ëá™Âä®Ê∏ÖÈô§ÊàêÂäüÂíå‰ø°ÊÅØÊ∂àÊÅØ
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, 6000);
            }
        }

        // ÈîôËØØÂ§ÑÁêÜÂíåÈáçËØïÈÄªËæë
        window.addEventListener('error', function(event) {
            console.error('È°µÈù¢ÈîôËØØ:', event.error);
            showStatus('‚ö†Ô∏è È°µÈù¢ÂèëÁîüÈîôËØØÔºåËØ∑Âà∑Êñ∞ÈáçËØï', 'warning');
        });

        // Êú™Â§ÑÁêÜÁöÑPromiseÈîôËØØ
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Êú™Â§ÑÁêÜÁöÑPromiseÈîôËØØ:', event.reason);
            event.preventDefault();
        });

        // ==================== NFTÂäüËÉΩ ====================
        
        // ÂàáÊç¢Ê†áÁ≠æÈ°µ
        function switchTab(tabId) {
            console.log('ÂàáÊç¢Âà∞Ê†áÁ≠æÈ°µ:', tabId);
            currentActiveTab = tabId;
            
            // ÁßªÈô§ÊâÄÊúâÊ¥ªÂä®Áä∂ÊÄÅ
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ÊøÄÊ¥ªÂΩìÂâçÊ†áÁ≠æ
            event.target.classList.add('active');
            document.getElementById(tabId).classList.add('active');
            
            // Â¶ÇÊûúÂ∑≤ËøûÊé•Èí±ÂåÖÔºåËá™Âä®Âä†ËΩΩÂØπÂ∫îÊï∞ÊçÆ
            if (walletProvider && userAccount) {
                if (tabId === 'lottery-results') {
                    loadLotteryResults();
                } else if (tabId === 'owned-nfts') {
                    loadOwnedNFTs();
                }
            }
        }

        // ÂêØÁî®NFTÂäüËÉΩ
        function enableNFTFeatures() {
            document.querySelectorAll('.refresh-nft-btn').forEach(btn => {
                btn.disabled = false;
            });
            
            // Ëá™Âä®Âä†ËΩΩÂΩìÂâçÊ¥ªÂä®Ê†áÁ≠æÁöÑÊï∞ÊçÆ
            if (currentActiveTab === 'lottery-results') {
                loadLotteryResults();
            } else if (currentActiveTab === 'owned-nfts') {
                loadOwnedNFTs();
            }
        }

        // Âä†ËΩΩÊäΩÂ•ñÁªìÊûúNFT
        async function loadLotteryResults() {
            if (!walletProvider || !userAccount) {
                showStatus('‚ùå ËØ∑ÂÖàËøûÊé•Èí±ÂåÖ', 'error');
                return;
            }

            const container = document.getElementById('lottery-nfts');
            const emptyState = document.querySelector('#lottery-results .empty-state');
            const refreshBtn = document.querySelector('#lottery-results .refresh-nft-btn');
            
            try {
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = '<span class="spinner"></span> Âä†ËΩΩ‰∏≠...';
                emptyState.style.display = 'none';
                
                // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
                container.innerHTML = '<div class="loading-spinner"><span class="spinner"></span></div>';
                
                console.log('üîç Ê≠£Âú®Âä†ËΩΩÊäΩÂ•ñÁªìÊûúNFT...');
                
                // ‰ΩøÁî®ÂÆåÊï¥ÁöÑNFTÂä†ËΩΩÂáΩÊï∞
                const nfts = await loadUserNFTsComplete();
                
                if (nfts.length > 0) {
                    // Âè™ÊòæÁ§∫ÊúÄÊñ∞ÁöÑ5‰∏™NFT‰Ωú‰∏∫ÊäΩÂ•ñÁªìÊûú
                    const recentNFTs = nfts.slice(0, 5);
                    lotteryResults = recentNFTs;
                    // container‰ºöÂú®loadUserNFTsComplete‰∏≠Ë¢´Êõ¥Êñ∞ÔºåËøôÈáå‰∏çÈúÄË¶ÅÂÜçÊ¨°Ë∞ÉÁî®displayNFTs
                    console.log(`‚úÖ ÊàêÂäüÂä†ËΩΩ ${recentNFTs.length} ‰∏™ÊúÄËøëÊäΩÂ•ñNFT`);
                } else {
                    container.innerHTML = '';
                    emptyState.style.display = 'block';
                    emptyState.querySelector('p').textContent = 'ÊÇ®ËøòÊ≤°ÊúâÈÄöËøáÊäΩÂ•ñËé∑ÂæóNFTÔºåÂø´ÂéªËØïËØïËøêÊ∞îÂêßÔºÅ';
                    lotteryResults = [];
                }
                
            } catch (error) {
                console.error('Âä†ËΩΩÊäΩÂ•ñÁªìÊûúÂ§±Ë¥•:', error);
                container.innerHTML = '';
                emptyState.style.display = 'block';
                emptyState.querySelector('p').textContent = 'Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•';
                showStatus('‚ùå Âä†ËΩΩÊäΩÂ•ñÁªìÊûúÂ§±Ë¥•', 'error');
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.textContent = 'üîÑ Âà∑Êñ∞ÊäΩÂ•ñÁªìÊûú';
            }
        }

        // Âä†ËΩΩÊã•ÊúâÁöÑÊâÄÊúâNFT
        async function loadOwnedNFTs() {
            if (!walletProvider || !userAccount) {
                showStatus('‚ùå ËØ∑ÂÖàËøûÊé•Èí±ÂåÖ', 'error');
                return;
            }

            const container = document.getElementById('owned-nfts-grid');
            const emptyState = document.querySelector('#owned-nfts .empty-state');
            const refreshBtn = document.querySelector('#owned-nfts .refresh-nft-btn');
            
            try {
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = '<span class="spinner"></span> Âä†ËΩΩ‰∏≠...';
                emptyState.style.display = 'none';
                
                // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
                container.innerHTML = '<div class="loading-spinner"><span class="spinner"></span></div>';
                
                console.log('üîç Ê≠£Âú®Âä†ËΩΩÊâÄÊúâÊã•ÊúâÁöÑNFT...');
                
                // ‰ΩøÁî®ÂÆåÊï¥ÁöÑNFTÂä†ËΩΩÂáΩÊï∞
                const nfts = await loadUserNFTsComplete();
                
                if (nfts.length > 0) {
                    userNFTs = nfts;
                    // Ê∏ÖÁ©∫containerÔºåÂõ†‰∏∫loadUserNFTsCompleteÂ∑≤ÁªèÊòæÁ§∫‰∫ÜNFT
                    // container‰ºöÂú®loadUserNFTsComplete‰∏≠Ë¢´Êõ¥Êñ∞
                    console.log(`‚úÖ ÊàêÂäüÂä†ËΩΩ ${nfts.length} ‰∏™NFTÂà∞Êî∂ËóèÈ°µÈù¢`);
                } else {
                    container.innerHTML = '';
                    emptyState.style.display = 'block';
                    emptyState.querySelector('p').textContent = 'ÊÇ®ËøòÊ≤°ÊúâÊã•Êúâ‰ªª‰ΩïËõáÂ∏ÅNFTÔºåÂø´ÂéªÊäΩÂ•ñËé∑ÂèñÂêßÔºÅ';
                }
                
            } catch (error) {
                console.error('Âä†ËΩΩNFTÊî∂ËóèÂ§±Ë¥•:', error);
                container.innerHTML = '';
                emptyState.style.display = 'block';
                emptyState.querySelector('p').textContent = 'Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•';
                showStatus('‚ùå Âä†ËΩΩNFTÊî∂ËóèÂ§±Ë¥•', 'error');
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.textContent = 'üîÑ Âà∑Êñ∞NFTÊî∂Ëóè';
            }
        }

        // Âä†ËΩΩÂçï‰∏™NFTÊï∞ÊçÆ
        async function loadNFTData(tokenId) {
            try {
                console.log(`üîç Âä†ËΩΩNFTÊï∞ÊçÆ: Token ID ${tokenId}`);
                
                // ÂÖàÂ∞ùËØï‰ΩøÁî®tokenURIËé∑ÂèñÂÆåÊï¥ÂÖÉÊï∞ÊçÆ
                let svgData = '';
                let traits = [];
                
                try {
                    const tokenURIResult = await rawContractCall(
                        ABI_SIGNATURES.tokenURI + 
                        tokenId.toString(16).padStart(64, '0'),
                        'string'
                    );
                    
                    console.log(`üìÑ Token ${tokenId} tokenURIÁªìÊûú:`, tokenURIResult);
                    
                    if (tokenURIResult && tokenURIResult !== '0x') {
                        console.log(`üìù Token ${tokenId} ÂéüÂßãtokenURI:`, tokenURIResult.substring(0, 200) + '...');
                        const decodedURI = hexToString(tokenURIResult);
                        console.log(`üìù Token ${tokenId} Ëß£Á†ÅÂêéÁöÑURI:`, decodedURI.substring(0, 200) + '...');
                        
                        if (decodedURI.startsWith('data:application/json;base64,')) {
                            // Ëß£ÊûêBase64ÁºñÁ†ÅÁöÑJSON
                            const base64Data = decodedURI.replace('data:application/json;base64,', '');
                            const jsonData = JSON.parse(atob(base64Data));
                            console.log(`‚úÖ Token ${tokenId} ÂÖÉÊï∞ÊçÆ:`, jsonData);
                            
                            // ÊèêÂèñSVGÂõæÂÉè
                            if (jsonData.image && jsonData.image.startsWith('data:image/svg+xml;base64,')) {
                                const svgBase64 = jsonData.image.replace('data:image/svg+xml;base64,', '');
                                svgData = atob(svgBase64);
                                console.log(`üé® Token ${tokenId} SVGÈïøÂ∫¶:`, svgData.length);
                            }
                            
                            // ÊèêÂèñÁâπÂæÅ
                            if (jsonData.attributes && Array.isArray(jsonData.attributes)) {
                                traits = jsonData.attributes.map(attr => ({
                                    name: attr.trait_type,
                                    value: attr.value
                                }));
                            }
                        }
                    }
                } catch (uriError) {
                    console.warn(`‚ö†Ô∏è tokenURIËß£ÊûêÂ§±Ë¥• Token ${tokenId}:`, uriError);
                }
                
                // Â¶ÇÊûútokenURIÂ§±Ë¥•ÔºåÂ∞ùËØïÁõ¥Êé•Ëé∑ÂèñSVG
                if (!svgData) {
                    console.log(`üîÑ Token ${tokenId} Â∞ùËØïÁõ¥Êé•Ëé∑ÂèñSVG...`);
                    
                    try {
                        const svgResult = await rawContractCall(
                            ABI_SIGNATURES.generateSnakeSVG + 
                            tokenId.toString(16).padStart(64, '0'),
                            'string'
                        );
                        
                        if (svgResult && svgResult !== '0x') {
                            console.log(`üîç Token ${tokenId} ÂéüÂßãSVGÁªìÊûú:`, svgResult.substring(0, 200) + '...');
                            svgData = hexToString(svgResult);
                            console.log(`üé® Token ${tokenId} Ëß£ÊûêÂêéSVGÈïøÂ∫¶:`, svgData.length);
                            
                            // È™åËØÅSVGÊòØÂê¶ÊúâÊïà
                            if (svgData.length > 10 && svgData.includes('<svg')) {
                                console.log(`‚úÖ Token ${tokenId} SVGÊúâÊïà`);
                            } else {
                                console.warn(`‚ö†Ô∏è Token ${tokenId} SVGÊó†ÊïàÔºå‰ΩøÁî®ÂõûÈÄÄSVG`);
                                svgData = '';
                            }
                        }
                    } catch (svgError) {
                        console.warn(`‚ö†Ô∏è generateSnakeSVGÂ§±Ë¥• Token ${tokenId}:`, svgError);
                    }
                }
                
                // Â¶ÇÊûúËøòÊòØÊ≤°ÊúâSVGÔºå‰ΩøÁî®ÂõûÈÄÄSVG
                if (!svgData) {
                    console.warn(`üîß Token ${tokenId} ‰ΩøÁî®ÂõûÈÄÄSVG`);
                    svgData = generateFallbackSVG(tokenId);
                }
                
                // Â¶ÇÊûúÊ≤°ÊúâtraitsÔºå‰ªétokenIdÁîüÊàê
                if (traits.length === 0) {
                    traits = extractTraitsFromTokenId(tokenId);
                }
                
                const nftData = {
                    tokenId: tokenId,
                    name: `SnakeCoin #${tokenId}`,
                    image: svgData,
                    traits: traits
                };
                
                console.log(`‚úÖ Token ${tokenId} Êï∞ÊçÆÂä†ËΩΩÂÆåÊàê`, nftData);
                return nftData;
                
            } catch (error) {
                console.error(`‚ùå Âä†ËΩΩNFTÊï∞ÊçÆÂ§±Ë¥• Token ${tokenId}:`, error);
                return {
                    tokenId: tokenId,
                    name: `SnakeCoin #${tokenId}`,
                    image: generateFallbackSVG(tokenId),
                    traits: [{ name: 'Status', value: 'Error Loading' }]
                };
            }
        }

        // ÂçÅÂÖ≠ËøõÂà∂Â≠óÁ¨¶‰∏≤ËΩ¨ÊôÆÈÄöÂ≠óÁ¨¶‰∏≤ - ÊîπËøõÁâà
        function hexToString(hex) {
            if (!hex || hex === '0x') return '';
            
            try {
                // ÁßªÈô§0xÂâçÁºÄ
                hex = hex.replace('0x', '');
                console.log(`üîç hexToStringËæìÂÖ•: ${hex.substring(0, 100)}... (ÈïøÂ∫¶: ${hex.length})`);
                
                if (hex.length < 64) {
                    console.warn('hexÊï∞ÊçÆÂ§™Áü≠ÔºåÊó†Ê≥ïËß£Êûê');
                    return '';
                }
                
                // Ââç32Â≠óËäÇ(64‰∏™ÂçÅÂÖ≠ËøõÂà∂Â≠óÁ¨¶)ÊòØÂÅèÁßªÈáèÔºåÊåáÂêëÊï∞ÊçÆÂºÄÂßã‰ΩçÁΩÆ
                const offsetHex = hex.substring(0, 64);
                const offset = parseInt(offsetHex, 16) * 2; // ËΩ¨Êç¢‰∏∫ÂçÅÂÖ≠ËøõÂà∂Â≠óÁ¨¶‰ΩçÁΩÆ
                console.log(`üìç Êï∞ÊçÆÂÅèÁßªÈáè: ${offset}`);
                
                if (offset >= hex.length) {
                    console.warn('ÂÅèÁßªÈáèË∂ÖÂá∫Êï∞ÊçÆËåÉÂõ¥');
                    return '';
                }
                
                // ‰ªéÂÅèÁßª‰ΩçÁΩÆËØªÂèñÈïøÂ∫¶ÔºàÊé•‰∏ãÊù•32Â≠óËäÇÔºâ
                const lengthHex = hex.substring(offset, offset + 64);
                const length = parseInt(lengthHex, 16);
                console.log(`üìè Â≠óÁ¨¶‰∏≤ÈïøÂ∫¶: ${length}`);
                
                if (length === 0) {
                    console.warn('Â≠óÁ¨¶‰∏≤ÈïøÂ∫¶‰∏∫0');
                    return '';
                }
                
                // ËØªÂèñÂÆûÈôÖÂ≠óÁ¨¶‰∏≤Êï∞ÊçÆ
                const dataStart = offset + 64;
                const dataEnd = dataStart + (length * 2);
                const dataHex = hex.substring(dataStart, dataEnd);
                console.log(`üìù Â≠óÁ¨¶‰∏≤Êï∞ÊçÆhex: ${dataHex.substring(0, 100)}... (ÈïøÂ∫¶: ${dataHex.length})`);
                
                if (dataHex.length === 0) {
                    console.warn('Êó†Â≠óÁ¨¶‰∏≤Êï∞ÊçÆ');
                    return '';
                }
                
                // ËΩ¨Êç¢‰∏∫Â≠óÁ¨¶‰∏≤
                let result = '';
                for (let i = 0; i < dataHex.length; i += 2) {
                    const charCode = parseInt(dataHex.substr(i, 2), 16);
                    if (charCode > 0) {
                        result += String.fromCharCode(charCode);
                    }
                }
                
                console.log(`‚úÖ Ëß£ÊûêÁªìÊûú: ${result.substring(0, 100)}... (ÈïøÂ∫¶: ${result.length})`);
                return result;
                
            } catch (error) {
                console.error('hexToStringËß£ÊûêÂ§±Ë¥•:', error);
                return '';
            }
        }

        // ÁîüÊàêÂõûÈÄÄSVG - ÊîπËøõÁâà
        function generateFallbackSVG(tokenId) {
            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#FFB347', '#87CEEB', '#98FB98', '#F0E68C'];
            const primaryColor = colors[tokenId % colors.length];
            const secondaryColor = colors[(tokenId + 1) % colors.length];
            
            console.log(`üé® ÁîüÊàêToken ${tokenId} ÁöÑÂõûÈÄÄSVGÔºåÈ¢úËâ≤: ${primaryColor}, ${secondaryColor}`);
            
            return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" width="400" height="400">
                <defs>
                    <linearGradient id="grad${tokenId}" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:${primaryColor};stop-opacity:1" />
                        <stop offset="100%" style="stop-color:${secondaryColor};stop-opacity:1" />
                    </linearGradient>
                </defs>
                <rect width="100" height="100" fill="url(#grad${tokenId})" opacity="0.2"/>
                <path d="M10,50 Q30,30 50,50 T90,50" stroke="${primaryColor}" stroke-width="4" fill="none"/>
                <path d="M10,60 Q30,40 50,60 T90,60" stroke="${secondaryColor}" stroke-width="3" fill="none"/>
                <circle cx="15" cy="50" r="3" fill="${primaryColor}"/>
                <circle cx="85" cy="50" r="3" fill="${secondaryColor}"/>
                <text x="50" y="85" text-anchor="middle" font-family="Arial" font-size="10" fill="${primaryColor}" font-weight="bold">SnakeCoin #${tokenId}</text>
            </svg>`;
        }

        // ‰ªéToken IDÊèêÂèñÁâπÂæÅ
        function extractTraitsFromTokenId(tokenId) {
            const tokenStr = tokenId.toString().padStart(7, '0');
            const colors = ['Red', 'Cyan', 'Blue', 'Green', 'Yellow', 'Purple', 'Orange', 'Sky Blue', 'Light Green', 'Khaki'];
            const patterns = ['Wave', 'Curve', 'Zigzag', 'Parabola', 'Double Wave', 'Double Curve', 'Sawtooth', 'Symmetric Wave', 'Complex Curve', 'Dense Wave'];
            
            return [
                { name: 'Token ID', value: `#${tokenId}` },
                { name: 'Primary Color', value: colors[parseInt(tokenStr[0]) % 10] },
                { name: 'Secondary Color', value: colors[parseInt(tokenStr[1]) % 10] },
                { name: 'Pattern', value: patterns[parseInt(tokenStr[2]) % 10] }
            ];
        }

        // ÊòæÁ§∫NFTÂàóË°®
        function displayNFTs(nfts, container) {
            container.innerHTML = '';
            
            if (nfts.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>ÊöÇÊó†NFTÊï∞ÊçÆ</p></div>';
                return;
            }
            
            nfts.forEach(nft => {
                const nftCard = createNFTCard(nft);
                container.appendChild(nftCard);
            });
        }

        // ÂàõÂª∫NFTÂç°Áâá
        function createNFTCard(nft) {
            const card = document.createElement('div');
            card.className = 'nft-card';
            
            const imageHtml = nft.image.includes('<svg') 
                ? `<div class="nft-image">${nft.image}</div>`
                : `<div class="nft-image">Âä†ËΩΩ‰∏≠...</div>`;
            
            const traitsHtml = nft.traits.map(trait => 
                `<span class="nft-trait">${trait.name}: ${trait.value}</span>`
            ).join('');
            
            card.innerHTML = `
                ${imageHtml}
                <div class="nft-info">
                    <div class="nft-title">${nft.name}</div>
                    <div class="nft-id">Token ID: ${nft.tokenId}</div>
                    <div class="nft-traits">${traitsHtml}</div>
                </div>
            `;
            
            return card;
        }

        // Êâ´ÊèèÁî®Êà∑Êã•ÊúâÁöÑNFTÔºàÊõø‰ª£tokenOfOwnerByIndexÊñπÊ≥ïÔºâ
        async function scanUserNFTs(expectedCount) {
            const userNFTs = [];
            
            try {
                console.log('=== ÂºÄÂßãÊâ´ÊèèÁî®Êà∑NFT ===');
                console.log(`üîç ÊúüÊúõÊâæÂà∞ ${expectedCount} ‰∏™NFT`);
                console.log(`üë§ Áî®Êà∑Âú∞ÂùÄ: ${userAccount}`);
                
                // Ëé∑ÂèñÊÄª‰æõÂ∫îÈáè
                const totalSupplyResult = await rawContractCall(ABI_SIGNATURES.totalSupply);
                const totalSupply = parseInt(totalSupplyResult || '0');
                
                console.log(`üìä ÊÄª‰æõÂ∫îÈáè: ${totalSupply}`);
                
                if (totalSupply === 0) {
                    console.log('‚ö†Ô∏è ÊÄª‰æõÂ∫îÈáè‰∏∫0ÔºåÊ≤°ÊúâNFTÂèØÊâ´Êèè');
                    return userNFTs;
                }
                
                // Êõ¥Êñ∞Êâ´ÊèèÁä∂ÊÄÅÔºàÂ¶ÇÊûúÈúÄË¶ÅÔºâ
                updateScanningStatus(`üîç Ê≠£Âú®Êü•ÊâæÊÇ®ÁöÑNFT...`);
                
                // ÈÅçÂéÜÊâÄÊúâÂèØËÉΩÁöÑtokenIdÔºåÊ£ÄÊü•Áî®Êà∑ÊòØÂê¶Êã•Êúâ
                let userNFTCount = 0;
                const maxSupply = Math.min(totalSupply, 1000); // ÈôêÂà∂Êâ´ÊèèËåÉÂõ¥ÔºåÈÅøÂÖçË∂ÖÊó∂
                const userTokenIds = []; // Â≠òÂÇ®ÊâæÂà∞ÁöÑToken ID
                
                // ÂàÜÊâπÂ§ÑÁêÜÔºåÈÅøÂÖç‰∏ÄÊ¨°ÊÄßÂ§ÑÁêÜÂ§™Â§öËØ∑Ê±Ç
                const batchSize = 20; // ÂáèÂ∞èÊâπÊ¨°Â§ßÂ∞èÔºåÈÅøÂÖçRPCË∂ÖÊó∂
                let processedCount = 0;
                
                // ‰ªéÊúÄÊñ∞ÁöÑNFTÂºÄÂßãÊâ´ÊèèÔºàÂÄíÂ∫èÔºâÔºåËøôÊ†∑ÊäΩÂ•ñÁªìÊûú‰ºö‰ºòÂÖàÊòæÁ§∫
                for (let tokenId = totalSupply - 1; tokenId >= 0 && userNFTCount < expectedCount; tokenId--) {
                    try {
                        // Ê£ÄÊü•ËØ•tokenIdÁöÑÊã•ÊúâËÄÖ
                        const ownerResult = await rawContractCall(
                            ABI_SIGNATURES.ownerOf + 
                            tokenId.toString(16).padStart(64, '0'),
                            'address'
                        );
                        
                        if (processedCount < 10) { // Âè™ËÆ∞ÂΩïÂâç10‰∏™ÁöÑËØ¶ÁªÜ‰ø°ÊÅØ
                            console.log(`Token ${tokenId} ÁöÑÊâÄÊúâËÄÖ:`, ownerResult);
                        }
                        
                        if (ownerResult && ownerResult !== '0x' && ownerResult !== '0x0000000000000000000000000000000000000000') {
                            if (ownerResult === userAccount.toLowerCase()) {
                                console.log(`‚úÖ ÊâæÂà∞Áî®Êà∑Êã•ÊúâÁöÑNFT: Token ${tokenId}`);
                                userTokenIds.push(tokenId);
                                userNFTCount++;
                            } else if (processedCount < 10) {
                                console.log(`‚ùå Token ${tokenId} ‰∏çÂ±û‰∫éÂΩìÂâçÁî®Êà∑`);
                            }
                        } else if (processedCount < 10) {
                            console.log(`‚ö†Ô∏è Token ${tokenId} Êó†ÊúâÊïàÊã•ÊúâËÄÖ`);
                        }
                        
                        processedCount++;
                        
                        // ÊØèÂ§ÑÁêÜ‰∏ÄÊâπÔºåÊõ¥Êñ∞Áä∂ÊÄÅ
                        if (processedCount % batchSize === 0) {
                            updateScanningStatus(`üîç Â∑≤Ê£ÄÊü• ${processedCount}/${totalSupply} ‰∏™Token...`);
                            console.log(`Â∑≤Â§ÑÁêÜ ${processedCount}/${totalSupply} ‰∏™TokenÔºåÊâæÂà∞ ${userNFTCount} ‰∏™NFT`);
                            
                            // Ê∑ªÂä†Áü≠ÊöÇÂª∂ËøüÔºåÈÅøÂÖçËØ∑Ê±ÇËøá‰∫éÈ¢ëÁπÅ
                            await new Promise(resolve => setTimeout(resolve, 100));
                        }
                        
                    } catch (error) {
                        // token‰∏çÂ≠òÂú®ÊàñÂá∫ÈîôÔºåÁªßÁª≠‰∏ã‰∏Ä‰∏™
                        if (processedCount < 10) { // Âè™ËÆ∞ÂΩïÂâç10‰∏™ÈîôËØØ
                            console.log(`Token ${tokenId} ‰∏çÂ≠òÂú®ÊàñÂá∫Èîô:`, error.message);
                        }
                        processedCount++;
                        continue;
                    }
                }
                
                console.log('=== Êâ´ÊèèÂÆåÊàê ===');
                console.log('Áî®Êà∑Êã•ÊúâNFTÊï∞Èáè:', userNFTCount);
                console.log('ÊâæÂà∞ÁöÑNFT Token IDs:', userTokenIds);
                
                if (userNFTCount > 0) {
                    updateScanningStatus(`‚úÖ ÊâæÂà∞ ${userNFTCount} ‰∏™NFTÔºåÊ≠£Âú®Âä†ËΩΩËØ¶ÁªÜ‰ø°ÊÅØ...`);
                    
                    // ÊåâÂÄíÂ∫èÊéíÂàóÔºåÊúÄÊñ∞ÁöÑÊéíÂú®ÂâçÈù¢
                    userTokenIds.sort((a, b) => b - a);
                    console.log('ÂÄíÂ∫èÊéíÂàóÂêéÁöÑNFT Token IDs:', userTokenIds);
                    
                    // Âä†ËΩΩÊØè‰∏™NFTÁöÑËØ¶ÁªÜÊï∞ÊçÆ
                    for (const tokenId of userTokenIds) {
                        try {
                            updateScanningStatus(`üì¶ Ê≠£Âú®Âä†ËΩΩNFT ${tokenId}...`);
                            const nftData = await loadNFTData(tokenId);
                            if (nftData) {
                                userNFTs.push(nftData);
                                console.log(`üì¶ Â∑≤Ê∑ªÂä†NFT ${tokenId}ÔºåÂΩìÂâçÊÄªÊï∞: ${userNFTs.length}`);
                            }
                        } catch (nftError) {
                            console.error(`Âä†ËΩΩNFT ${tokenId} Êï∞ÊçÆÂ§±Ë¥•:`, nftError);
                            // ÁªßÁª≠Âä†ËΩΩÂÖ∂‰ªñNFT
                        }
                    }
                    
                    updateScanningStatus(`‚úÖ ÂÆåÊàêÔºÅÊàêÂäüÂä†ËΩΩ ${userNFTs.length} ‰∏™NFT`);
                } else {
                    updateScanningStatus('üì≠ ÊÇ®ËøòÊ≤°Êúâ‰ªª‰ΩïNFT');
                    console.log('Áî®Êà∑Ê≤°ÊúâÊâæÂà∞‰ªª‰ΩïNFTÔºåÂèØËÉΩÁöÑÂéüÂõ†:');
                    console.log('1. Áî®Êà∑Á°ÆÂÆûÊ≤°ÊúâNFT');
                    console.log('2. ÁΩëÁªú‰∏çÂêåÊ≠•');
                    console.log('3. ÂêàÁ∫¶Ë∞ÉÁî®ÊùÉÈôêÈóÆÈ¢ò');
                    console.log('4. Èí±ÂåÖRPCËäÇÁÇπÈóÆÈ¢ò');
                }
                
                console.log(`üéâ ÊúÄÁªàÊâ´ÊèèÁªìÊûúÔºöÊâæÂà∞ ${userNFTs.length} ‰∏™Áî®Êà∑NFT`);
                return userNFTs;
                
            } catch (error) {
                console.error('‚ùå Êâ´ÊèèÁî®Êà∑NFTÂ§±Ë¥•:', error);
                updateScanningStatus('‚ùå Êâ´ÊèèÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
                return [];
            }
        }
        
        // Êõ¥Êñ∞Êâ´ÊèèÁä∂ÊÄÅÔºàËæÖÂä©ÂáΩÊï∞Ôºâ
        function updateScanningStatus(message) {
            // Â∞ùËØïÊõ¥Êñ∞‰∏çÂêå‰ΩçÁΩÆÁöÑÁä∂ÊÄÅÊòæÁ§∫
            const statusElements = [
                document.querySelector('#lottery-results .empty-state p'),
                document.querySelector('#owned-nfts .empty-state p'),
                document.querySelector('.nft-status') // Â¶ÇÊûúÊúâÁä∂ÊÄÅÊ†è
            ];
            
            statusElements.forEach(element => {
                if (element) {
                    element.textContent = message;
                }
            });
            
            console.log(`[Áä∂ÊÄÅÊõ¥Êñ∞] ${message}`);
        }

        // ÂÆåÊï¥ÁöÑÁî®Êà∑NFTÂä†ËΩΩÂáΩÊï∞ÔºàÁ±ª‰ººlottery-realÁöÑÂÆûÁé∞Ôºâ
        async function loadUserNFTsComplete() {
            if (!walletProvider || !userAccount) {
                showStatus('‚ùå ËØ∑ÂÖàËøûÊé•Èí±ÂåÖ', 'error');
                return;
            }
            
            try {
                console.log('=== ÂºÄÂßãÂÆåÊï¥Âä†ËΩΩÁî®Êà∑NFT ===');
                console.log('Áî®Êà∑Âú∞ÂùÄ:', userAccount);
                console.log('ÂêàÁ∫¶Âú∞ÂùÄ:', CONTRACT_ADDRESS);
                
                // Ëé∑ÂèñÊÄª‰æõÂ∫îÈáè
                const totalSupplyResult = await rawContractCall(ABI_SIGNATURES.totalSupply);
                const totalSupply = parseInt(totalSupplyResult || '0');
                console.log('ÊÄª‰æõÂ∫îÈáè:', totalSupply.toString());
                
                if (totalSupply === 0) {
                    showStatus('üì≠ ÁõÆÂâçËøòÊ≤°Êúâ‰ªª‰ΩïNFT', 'info');
                    return [];
                }
                
                showStatus('üîç Ê≠£Âú®Êü•ÊâæÊÇ®ÁöÑNFT...', 'info');
                console.log('ÂºÄÂßãÊü•ÊâæÁî®Êà∑NFTÔºåÁî®Êà∑Âú∞ÂùÄ:', userAccount);
                
                // ÈÅçÂéÜÊâÄÊúâÂèØËÉΩÁöÑtokenIdÔºåÊ£ÄÊü•Áî®Êà∑ÊòØÂê¶Êã•Êúâ
                let userNFTCount = 0;
                const maxSupply = Math.min(totalSupply, 1000); // ÈôêÂà∂Êâ´ÊèèËåÉÂõ¥
                const userNFTs = []; // Â≠òÂÇ®ÊâæÂà∞ÁöÑNFT‰ø°ÊÅØ
                
                // ÂàÜÊâπÂ§ÑÁêÜÔºåÈÅøÂÖç‰∏ÄÊ¨°ÊÄßÂ§ÑÁêÜÂ§™Â§öËØ∑Ê±Ç
                const batchSize = 30;
                let processedCount = 0;
                
                for (let tokenId = 0; tokenId < maxSupply; tokenId++) {
                    try {
                        // Ê£ÄÊü•tokenÊòØÂê¶Â≠òÂú®
                        const ownerResult = await rawContractCall(
                            ABI_SIGNATURES.ownerOf + 
                            tokenId.toString(16).padStart(64, '0'),
                            'address'
                        );
                        
                        if (processedCount < 10) { // Âè™ËÆ∞ÂΩïÂâç10‰∏™ÁöÑËØ¶ÁªÜ‰ø°ÊÅØ
                            console.log(`Token ${tokenId} ÁöÑÊâÄÊúâËÄÖ:`, ownerResult);
                        }
                        
                        if (ownerResult && ownerResult !== '0x' && 
                            ownerResult !== '0x0000000000000000000000000000000000000000' &&
                            ownerResult === userAccount.toLowerCase()) {
                            // Áî®Êà∑Êã•ÊúâËøô‰∏™NFTÔºåÂÖàÊî∂ÈõÜ‰ø°ÊÅØÔºå‰∏çÁ´ãÂç≥ÁîüÊàêÂç°Áâá
                            console.log(`‚úÖ ÊâæÂà∞Áî®Êà∑Êã•ÊúâÁöÑNFT: Token ${tokenId}`);
                            userNFTs.push(tokenId);
                            userNFTCount++;
                        }
                        
                        processedCount++;
                        
                        // ÊØèÂ§ÑÁêÜ‰∏ÄÊâπÔºåÊõ¥Êñ∞Áä∂ÊÄÅ
                        if (processedCount % batchSize === 0) {
                            showStatus(`üîç Â∑≤Ê£ÄÊü• ${processedCount}/${maxSupply} ‰∏™TokenÔºåÊâæÂà∞ ${userNFTCount} ‰∏™NFT...`, 'info');
                            console.log(`Â∑≤Â§ÑÁêÜ ${processedCount}/${maxSupply} ‰∏™TokenÔºåÊâæÂà∞ ${userNFTCount} ‰∏™NFT`);
                            
                            // Ê∑ªÂä†Áü≠ÊöÇÂª∂ËøüÔºåÈÅøÂÖçËØ∑Ê±ÇËøá‰∫éÈ¢ëÁπÅ
                            await new Promise(resolve => setTimeout(resolve, 50));
                        }
                        
                    } catch (error) {
                        // token‰∏çÂ≠òÂú®ÔºåÁªßÁª≠‰∏ã‰∏Ä‰∏™
                        if (processedCount < 10) { // Âè™ËÆ∞ÂΩïÂâç10‰∏™ÈîôËØØ
                            console.log(`Token ${tokenId} ‰∏çÂ≠òÂú®ÊàñÂá∫Èîô:`, error.message);
                        }
                        processedCount++;
                        continue;
                    }
                }
                
                console.log('=== Êü•ÊâæÂÆåÊàê ===');
                console.log('Áî®Êà∑Êã•ÊúâNFTÊï∞Èáè:', userNFTCount);
                console.log('ÊâæÂà∞ÁöÑNFT Token IDs:', userNFTs);
                
                if (userNFTCount > 0) {
                    showStatus(`‚úÖ ÊâæÂà∞ ${userNFTCount} ‰∏™NFTÔºåÊ≠£Âú®Âä†ËΩΩËØ¶ÁªÜ‰ø°ÊÅØ...`, 'success');
                    
                    // ÊåâÂÄíÂ∫èÊéíÂàóÔºåÊúÄÊñ∞ÁöÑÊéíÂú®ÂâçÈù¢
                    userNFTs.sort((a, b) => b - a);
                    console.log('ÂÄíÂ∫èÊéíÂàóÂêéÁöÑNFT Token IDs:', userNFTs);
                    
                    // Âä†ËΩΩNFTËØ¶ÁªÜÊï∞ÊçÆ
                    const nftDataList = [];
                    for (const tokenId of userNFTs) {
                        try {
                            const nftData = await loadNFTData(tokenId);
                            if (nftData) {
                                nftDataList.push(nftData);
                                console.log(`üì¶ Â∑≤Âä†ËΩΩNFT ${tokenId} ËØ¶ÁªÜ‰ø°ÊÅØ`);
                            }
                        } catch (nftError) {
                            console.error(`Âä†ËΩΩNFT ${tokenId} Êï∞ÊçÆÂ§±Ë¥•:`, nftError);
                        }
                    }
                    
                    showStatus(`‚úÖ ÊàêÂäüÂä†ËΩΩ ${nftDataList.length} ‰∏™NFTÔºÅ`, 'success');
                    
                    // ÊòæÁ§∫Âú®‰∏§‰∏™Ê†áÁ≠æÈ°µ
                    const lotteryContainer = document.getElementById('lottery-nfts');
                    const ownedContainer = document.getElementById('owned-nfts-grid');
                    
                    // ÊòæÁ§∫ÊúÄÊñ∞ÁöÑ5‰∏™Âú®ÊäΩÂ•ñÁªìÊûúÈ°µ
                    const recentNFTs = nftDataList.slice(0, 5);
                    displayNFTs(recentNFTs, lotteryContainer);
                    document.querySelector('#lottery-results .empty-state').style.display = 'none';
                    
                    // ÊòæÁ§∫ÊâÄÊúâÁöÑÂú®Êã•ÊúâÈ°µÈù¢
                    displayNFTs(nftDataList, ownedContainer);
                    document.querySelector('#owned-nfts .empty-state').style.display = 'none';
                    
                    return nftDataList;
                    
                } else {
                    showStatus('üì≠ ÊÇ®ËøòÊ≤°Êúâ‰ªª‰ΩïNFT', 'info');
                    console.log('Áî®Êà∑Ê≤°ÊúâÊâæÂà∞‰ªª‰ΩïNFTÔºåÂèØËÉΩÁöÑÂéüÂõ†:');
                    console.log('1. Áî®Êà∑Á°ÆÂÆûÊ≤°ÊúâNFT');
                    console.log('2. ÁΩëÁªú‰∏çÂêåÊ≠•');
                    console.log('3. ÂêàÁ∫¶Ë∞ÉÁî®ÊùÉÈôêÈóÆÈ¢ò');
                    console.log('4. Èí±ÂåÖRPCËäÇÁÇπÈóÆÈ¢ò');
                    return [];
                }
                
            } catch (error) {
                console.error('Âä†ËΩΩÁî®Êà∑NFTÂ§±Ë¥•:', error);
                console.error('ÈîôËØØËØ¶ÊÉÖ:', error.message, error.stack);
                showStatus('‚ö†Ô∏è Âä†ËΩΩÁî®Êà∑NFTÂ§±Ë¥•: ' + error.message, 'error');
                return [];
            }
        }

        // Ë∞ÉËØïNFTÂä†ËΩΩÂäüËÉΩ
        async function debugNFTLoading() {
            if (!walletProvider || !userAccount) {
                showStatus('‚ùå ËØ∑ÂÖàËøûÊé•Èí±ÂåÖ', 'error');
                return;
            }

            console.log('üêõ ÂºÄÂßãË∞ÉËØïNFTÂä†ËΩΩ...');
            showStatus('üêõ ÂºÄÂßãË∞ÉËØïNFTÂä†ËΩΩÔºåËØ∑Êü•ÁúãÊµèËßàÂô®ÊéßÂà∂Âè∞', 'info');
            
            try {
                // ‰ΩøÁî®ÂÆåÊï¥ÁöÑNFTÂä†ËΩΩÂáΩÊï∞ËøõË°åË∞ÉËØï
                const nfts = await loadUserNFTsComplete();
                
                if (nfts.length > 0) {
                    console.log('‚úÖ Ë∞ÉËØïÊàêÂäüÔºÅÊâæÂà∞NFT:', nfts.length);
                    showStatus(`‚úÖ Ë∞ÉËØïÊàêÂäüÔºÅÊâæÂà∞Âπ∂ÊòæÁ§∫‰∫Ü ${nfts.length} ‰∏™NFT`, 'success');
                } else {
                    console.log('‚ùå Ë∞ÉËØïÂÆåÊàêÔºå‰ΩÜÊ≤°ÊúâÊâæÂà∞‰ªª‰ΩïNFT');
                    showStatus('‚ùå Ë∞ÉËØïÂÆåÊàêÔºå‰ΩÜÊ≤°ÊúâÊâæÂà∞‰ªª‰ΩïNFT', 'error');
                }
                
            } catch (error) {
                console.error('‚ùå Ë∞ÉËØïËøáÁ®ã‰∏≠ÂèëÁîüÈîôËØØ:', error);
                showStatus(`‚ùå Ë∞ÉËØïÂ§±Ë¥•: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>