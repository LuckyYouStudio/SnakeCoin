<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ€ LuckYou é’±åŒ…è¿æ¥è°ƒè¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .debug-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid #007bff;
        }
        .error { background: #f8d7da; border-left-color: #dc3545; color: #721c24; }
        .success { background: #d4edda; border-left-color: #28a745; color: #155724; }
        .warning { background: #fff3cd; border-left-color: #ffc107; color: #856404; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .log {
            background: #f8f9fa;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 3px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin: 10px 0;
            white-space: pre-wrap;
        }
        .info { color: #0066cc; }
        .error-log { color: #dc3545; }
        .success-log { color: #28a745; }
        .warning-log { color: #ff8c00; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ€ LuckYou é’±åŒ…è¿æ¥è°ƒè¯•</h1>
        <p>ä¸“é—¨ç”¨äºè°ƒè¯•LuckYoué’±åŒ…è¿æ¥é—®é¢˜çš„è¯¦ç»†è°ƒè¯•é¡µé¢</p>

        <!-- æ£€æµ‹çŠ¶æ€ -->
        <div class="debug-section">
            <h3>ğŸ” æ£€æµ‹çŠ¶æ€</h3>
            <p><strong>window.ethereum:</strong> <span id="windowEthereum">æ£€æµ‹ä¸­...</span></p>
            <p><strong>window.luckyouWallet:</strong> <span id="windowLuckyou">æ£€æµ‹ä¸­...</span></p>
            <p><strong>isLuckYouWallet:</strong> <span id="isLuckyouWallet">æ£€æµ‹ä¸­...</span></p>
            <p><strong>Providerç±»å‹:</strong> <span id="providerType">æœªçŸ¥</span></p>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="debug-section">
            <h3>ğŸ® æ§åˆ¶é¢æ¿</h3>
            <button onclick="detectProviders()">ğŸ” æ£€æµ‹Provider</button>
            <button onclick="testBasicConnection()">ğŸ”Œ æµ‹è¯•åŸºæœ¬è¿æ¥</button>
            <button onclick="requestAccounts()">ğŸ‘¤ è¯·æ±‚è´¦æˆ·</button>
            <button onclick="getAccounts()">ğŸ“‹ è·å–è´¦æˆ·</button>
            <button onclick="getChainId()">ğŸŒ è·å–Chain ID</button>
            <button onclick="clearLog()">ğŸ§¹ æ¸…é™¤æ—¥å¿—</button>
        </div>

        <!-- è°ƒè¯•æ—¥å¿— -->
        <div class="debug-section">
            <h3>ğŸ“ è¯¦ç»†æ—¥å¿—</h3>
            <div id="debugLog" class="log">ç­‰å¾…æ“ä½œ...</div>
        </div>

        <!-- è§£å†³æ–¹æ¡ˆå»ºè®® -->
        <div class="debug-section">
            <h3>ğŸ’¡ è§£å†³æ–¹æ¡ˆå»ºè®®</h3>
            <div id="suggestions">
                <p>æ ¹æ®è°ƒè¯•ç»“æœï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºå…·ä½“çš„è§£å†³å»ºè®®...</p>
            </div>
        </div>
    </div>

    <script>
        let luckyouProvider = null;

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('debugLog');
            const logClass = type === 'error' ? 'error-log' : 
                            type === 'success' ? 'success-log' : 
                            type === 'warning' ? 'warning-log' : 'info';
            logElement.innerHTML += `<div class="${logClass}">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLog() {
            document.getElementById('debugLog').innerHTML = 'æ—¥å¿—å·²æ¸…é™¤\n';
        }

        // æ£€æµ‹æ‰€æœ‰provider
        function detectProviders() {
            log('=== å¼€å§‹æ£€æµ‹Provider ===');
            
            // æ£€æµ‹ window.ethereum
            const hasWindowEthereum = !!window.ethereum;
            document.getElementById('windowEthereum').textContent = hasWindowEthereum ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨';
            log(`window.ethereum: ${hasWindowEthereum}`);
            
            if (hasWindowEthereum) {
                log(`window.ethereum.isMetaMask: ${window.ethereum.isMetaMask}`);
                log(`window.ethereum.isLuckYouWallet: ${window.ethereum.isLuckYouWallet}`);
                
                // æ£€æŸ¥æ‰€æœ‰å¯èƒ½çš„æ ‡è¯†
                const identifiers = ['isMetaMask', 'isLuckYouWallet', 'isEIP6963', 'isCoinbaseWallet', 'isBraveWallet'];
                identifiers.forEach(id => {
                    if (window.ethereum[id]) {
                        log(`  - ${id}: ${window.ethereum[id]}`);
                    }
                });
            }

            // æ£€æµ‹ window.luckyouWallet
            const hasLuckyouWallet = !!window.luckyouWallet;
            document.getElementById('windowLuckyou').textContent = hasLuckyouWallet ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨';
            log(`window.luckyouWallet: ${hasLuckyouWallet}`);

            // ç¡®å®š LuckYou æ ‡è¯†
            const isLuckYou = (window.ethereum && window.ethereum.isLuckYouWallet) || hasLuckyouWallet;
            document.getElementById('isLuckyouWallet').textContent = isLuckYou ? 'âœ… æ˜¯' : 'âŒ å¦';

            // ç¡®å®šä½¿ç”¨å“ªä¸ªprovider
            if (hasLuckyouWallet) {
                luckyouProvider = window.luckyouWallet;
                document.getElementById('providerType').textContent = 'window.luckyouWallet';
                log('âœ… å°†ä½¿ç”¨ window.luckyouWallet', 'success');
            } else if (window.ethereum && window.ethereum.isLuckYouWallet) {
                luckyouProvider = window.ethereum;
                document.getElementById('providerType').textContent = 'window.ethereum (LuckYouæ ‡è¯†)';
                log('âœ… å°†ä½¿ç”¨ window.ethereum (å¸¦LuckYouæ ‡è¯†)', 'success');
            } else {
                document.getElementById('providerType').textContent = 'âŒ æœªæ‰¾åˆ°';
                log('âŒ æœªæ‰¾åˆ°LuckYou Provider', 'error');
                showSuggestion('æœªæ£€æµ‹åˆ°LuckYoué’±åŒ…ã€‚è¯·ç¡®ä¿ï¼š\n1. LuckYoué’±åŒ…æ‰©å±•å·²å®‰è£…\n2. æ‰©å±•å·²å¯ç”¨\n3. é¡µé¢å·²åˆ·æ–°');
                return;
            }

            // æ£€æŸ¥providerçš„æ–¹æ³•
            const methods = ['request', 'on', 'removeListener', 'isConnected'];
            methods.forEach(method => {
                if (luckyouProvider[method]) {
                    log(`  âœ… ${method} æ–¹æ³•å­˜åœ¨`);
                } else {
                    log(`  âŒ ${method} æ–¹æ³•ç¼ºå¤±`, 'warning');
                }
            });

            log('=== Provideræ£€æµ‹å®Œæˆ ===', 'success');
        }

        // æµ‹è¯•åŸºæœ¬è¿æ¥
        async function testBasicConnection() {
            if (!luckyouProvider) {
                log('âŒ è¯·å…ˆæ£€æµ‹Provider', 'error');
                return;
            }

            log('=== æµ‹è¯•åŸºæœ¬è¿æ¥ ===');

            try {
                // æµ‹è¯• isConnected æ–¹æ³•
                if (typeof luckyouProvider.isConnected === 'function') {
                    const connected = luckyouProvider.isConnected();
                    log(`isConnected(): ${connected}`);
                } else {
                    log('âš ï¸ isConnected æ–¹æ³•ä¸å­˜åœ¨', 'warning');
                }

                // æµ‹è¯• request æ–¹æ³•æ˜¯å¦å­˜åœ¨
                if (typeof luckyouProvider.request === 'function') {
                    log('âœ… request æ–¹æ³•å­˜åœ¨');
                } else {
                    log('âŒ request æ–¹æ³•ä¸å­˜åœ¨', 'error');
                    return;
                }

                log('åŸºæœ¬è¿æ¥æµ‹è¯•é€šè¿‡', 'success');
            } catch (error) {
                log(`åŸºæœ¬è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // è¯·æ±‚è´¦æˆ·è®¿é—®
        async function requestAccounts() {
            if (!luckyouProvider) {
                log('âŒ è¯·å…ˆæ£€æµ‹Provider', 'error');
                return;
            }

            log('=== è¯·æ±‚è´¦æˆ·è®¿é—® ===');

            try {
                log('å‘é€ eth_requestAccounts è¯·æ±‚...');
                
                // è®¾ç½®è¶…æ—¶
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('è¯·æ±‚è¶…æ—¶ (30ç§’)')), 30000)
                );

                const requestPromise = luckyouProvider.request({ 
                    method: 'eth_requestAccounts' 
                });

                log('ç­‰å¾…ç”¨æˆ·å“åº”...');
                
                const accounts = await Promise.race([requestPromise, timeoutPromise]);
                
                if (accounts && accounts.length > 0) {
                    log(`âœ… è·å–åˆ°è´¦æˆ·: ${accounts[0]}`, 'success');
                    log(`è´¦æˆ·æ•°é‡: ${accounts.length}`);
                    accounts.forEach((account, index) => {
                        log(`  è´¦æˆ·${index + 1}: ${account}`);
                    });
                } else {
                    log('âŒ æœªè·å–åˆ°è´¦æˆ·', 'error');
                }

            } catch (error) {
                log(`âŒ è¯·æ±‚è´¦æˆ·å¤±è´¥: ${error.message}`, 'error');
                
                // è¯¦ç»†é”™è¯¯åˆ†æ
                if (error.code) {
                    log(`é”™è¯¯ä»£ç : ${error.code}`, 'error');
                }
                
                if (error.message.includes('User rejected')) {
                    showSuggestion('ç”¨æˆ·æ‹’ç»äº†è¿æ¥è¯·æ±‚ã€‚è¯·åœ¨LuckYoué’±åŒ…ä¸­ç‚¹å‡»"è¿æ¥"æŒ‰é’®ã€‚');
                } else if (error.message.includes('timeout')) {
                    showSuggestion('è¯·æ±‚è¶…æ—¶ã€‚å¯èƒ½çš„åŸå› ï¼š\n1. LuckYoué’±åŒ…æ‰©å±•æœªå“åº”\n2. æ‰©å±•å†…éƒ¨é”™è¯¯\n3. é’±åŒ…æœªè§£é”');
                } else if (error.message.includes('No wallet found')) {
                    showSuggestion('LuckYoué’±åŒ…å†…éƒ¨é”™è¯¯ï¼šæœªæ‰¾åˆ°é’±åŒ…ã€‚è¯·ï¼š\n1. ç¡®ä¿å·²åˆ›å»ºæˆ–å¯¼å…¥é’±åŒ…\n2. æ£€æŸ¥é’±åŒ…æ˜¯å¦å·²è§£é”\n3. é‡å¯æ‰©å±•');
                }

                console.error('è¯¦ç»†é”™è¯¯ä¿¡æ¯:', error);
            }
        }

        // è·å–å·²è¿æ¥çš„è´¦æˆ·
        async function getAccounts() {
            if (!luckyouProvider) {
                log('âŒ è¯·å…ˆæ£€æµ‹Provider', 'error');
                return;
            }

            log('=== è·å–å·²è¿æ¥è´¦æˆ· ===');

            try {
                const accounts = await luckyouProvider.request({ 
                    method: 'eth_accounts' 
                });

                if (accounts && accounts.length > 0) {
                    log(`âœ… å·²è¿æ¥è´¦æˆ·æ•°é‡: ${accounts.length}`, 'success');
                    accounts.forEach((account, index) => {
                        log(`  è´¦æˆ·${index + 1}: ${account}`);
                    });
                } else {
                    log('â„¹ï¸ å½“å‰æ— å·²è¿æ¥è´¦æˆ·');
                }

            } catch (error) {
                log(`âŒ è·å–è´¦æˆ·å¤±è´¥: ${error.message}`, 'error');
                console.error('è¯¦ç»†é”™è¯¯ä¿¡æ¯:', error);
            }
        }

        // è·å–ç½‘ç»œID
        async function getChainId() {
            if (!luckyouProvider) {
                log('âŒ è¯·å…ˆæ£€æµ‹Provider', 'error');
                return;
            }

            log('=== è·å–ç½‘ç»œä¿¡æ¯ ===');

            try {
                const chainId = await luckyouProvider.request({ 
                    method: 'eth_chainId' 
                });

                log(`âœ… Chain ID: ${chainId}`, 'success');
                
                // è½¬æ¢ä¸ºåè¿›åˆ¶
                const decimalChainId = parseInt(chainId, 16);
                log(`åè¿›åˆ¶ Chain ID: ${decimalChainId}`);

                // ç½‘ç»œåç§°æ˜ å°„
                const networks = {
                    1: 'Ethereum Mainnet',
                    11155111: 'Sepolia Testnet',
                    31337: 'Hardhat Local'
                };

                const networkName = networks[decimalChainId] || 'æœªçŸ¥ç½‘ç»œ';
                log(`ç½‘ç»œåç§°: ${networkName}`);

                if (decimalChainId !== 11155111) {
                    log('âš ï¸ å½“å‰ä¸åœ¨Sepoliaæµ‹è¯•ç½‘', 'warning');
                }

            } catch (error) {
                log(`âŒ è·å–ç½‘ç»œä¿¡æ¯å¤±è´¥: ${error.message}`, 'error');
                console.error('è¯¦ç»†é”™è¯¯ä¿¡æ¯:', error);
            }
        }

        // æ˜¾ç¤ºå»ºè®®
        function showSuggestion(suggestion) {
            const suggestionsDiv = document.getElementById('suggestions');
            suggestionsDiv.innerHTML = `<div class="warning"><strong>å»ºè®®è§£å†³æ–¹æ¡ˆ:</strong><br><pre>${suggestion}</pre></div>`;
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æµ‹
        window.addEventListener('load', () => {
            log('ğŸ€ LuckYoué’±åŒ…è°ƒè¯•é¡µé¢å·²åŠ è½½');
            log('è¯·å…ˆç‚¹å‡»"æ£€æµ‹Provider"å¼€å§‹è°ƒè¯•');
            
            // ç­‰å¾…ä¸€ä¸‹å†è‡ªåŠ¨æ£€æµ‹ï¼Œç¡®ä¿æ‰©å±•å·²åŠ è½½
            setTimeout(() => {
                detectProviders();
            }, 1000);
        });

        // ç›‘å¬æ‰©å±•æ¶ˆæ¯ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type) {
                log(`ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ${event.data.type}`, 'info');
                if (event.data.type.includes('LUCKYOU')) {
                    log(`LuckYouæ¶ˆæ¯è¯¦æƒ…: ${JSON.stringify(event.data)}`, 'info');
                }
            }
        });
    </script>
</body>
</html>