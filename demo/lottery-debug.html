<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”§ è›‡å¸NFTæŠ½å¥–è°ƒè¯•ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 3rem;
            color: #333;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2rem;
            color: #666;
        }

        .debug-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .debug-section h2 {
            color: #333;
            margin-bottom: 15px;
        }

        .debug-info {
            background: #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            font-family: monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
        }

        .status-check {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 5px;
        }

        .status-check.success {
            background: #d4edda;
            color: #155724;
        }

        .status-check.error {
            background: #f8d7da;
            color: #721c24;
        }

        .status-check.warning {
            background: #fff3cd;
            color: #856404;
        }

        .status-icon {
            margin-right: 10px;
            font-size: 1.2rem;
        }

        .wallet-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .connect-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .connect-btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .connect-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .wallet-info {
            margin-top: 15px;
            padding: 15px;
            background: #e9ecef;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.9rem;
        }

        .lottery-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .lottery-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .info-card h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .info-card p {
            font-size: 1.5rem;
            font-weight: bold;
            color: #007bff;
        }

        .lottery-btn {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            border: none;
            padding: 20px 40px;
            border-radius: 50px;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            display: block;
        }

        .lottery-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
        }

        .lottery-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .status {
            text-align: center;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            font-weight: bold;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .nft-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .nft-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .nft-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .nft-card h3 {
            text-align: center;
            margin-bottom: 15px;
            color: #333;
        }

        .nft-svg {
            width: 100%;
            height: 200px;
            border: 1px solid #eee;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .nft-info {
            font-size: 0.9rem;
            color: #666;
        }

        .nft-info p {
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ è›‡å¸NFTæŠ½å¥–è°ƒè¯•ç‰ˆ</h1>
            <p>è¯Šæ–­MetaMaskè¿æ¥é—®é¢˜å¹¶æä¾›è§£å†³æ–¹æ¡ˆ</p>
        </div>

        <div class="debug-section">
            <h2>ğŸ” ç³»ç»Ÿè¯Šæ–­</h2>
            <div id="diagnosticResults">
                <!-- è¯Šæ–­ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>

        <div class="wallet-section">
            <h2>ğŸ”— é’±åŒ…è¿æ¥</h2>
            <button id="diagnoseBtn" class="connect-btn" onclick="runDiagnostics()">
                è¿è¡Œè¯Šæ–­
            </button>
            <button id="connectBtn" class="connect-btn" onclick="connectWallet()" disabled>
                è¿æ¥MetaMaské’±åŒ…
            </button>
            <button id="switchNetworkBtn" class="connect-btn" onclick="switchToLocalhost()" disabled>
                åˆ‡æ¢åˆ°æœ¬åœ°ç½‘ç»œ
            </button>
            <div id="walletInfo" class="wallet-info" style="display: none;">
                <!-- é’±åŒ…ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>

        <div class="lottery-section">
            <h2>ğŸ¯ æŠ½å¥–ä¿¡æ¯</h2>
            
            <div class="lottery-info">
                <div class="info-card">
                    <h3>æŠ½å¥–ä»·æ ¼</h3>
                    <p id="lotteryPrice">0.0001 ETH</p>
                </div>
                <div class="info-card">
                    <h3>æ± å­å¤§å°</h3>
                    <p id="poolSize">-</p>
                </div>
                <div class="info-card">
                    <h3>å·²é“¸é€ </h3>
                    <p id="totalMinted">-</p>
                </div>
                <div class="info-card">
                    <h3>å‰©ä½™æ•°é‡</h3>
                    <p id="remainingSupply">-</p>
                </div>
            </div>

            <button id="lotteryBtn" class="lottery-btn" onclick="playLottery()" disabled>
                è¯·å…ˆè¿æ¥é’±åŒ…
            </button>

            <div id="statusDiv"></div>
        </div>

        <div class="nft-grid" id="nftGrid">
            <!-- æŠ½ä¸­çš„NFTå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
    </div>

    <script>
        // åˆçº¦é…ç½®
        const CONTRACT_ADDRESS = "0x8A791620dd6260079BF849Dc5567aDC3F2FdC318";
        const CONTRACT_ABI = [
            "function lotteryPrice() view returns (uint256)",
            "function getPoolSize() view returns (uint256)",
            "function totalSupply() view returns (uint256)",
            "function remainingSupply() view returns (uint256)",
            "function playLottery() payable",
            "function generateSnakeSVG(uint256 tokenId) view returns (string)",
            "function tokenURI(uint256 tokenId) view returns (string)",
            "function getLotteryInfo() view returns (uint256 price, uint256 poolSize, uint256 totalMinted, uint256 remaining)",
            "event LotteryWon(address indexed winner, uint256 indexed tokenId, uint256 price)"
        ];

        let web3;
        let contract;
        let userAccount;
        let userBalance;

        // è¿è¡Œè¯Šæ–­
        async function runDiagnostics() {
            const diagnosticResults = document.getElementById('diagnosticResults');
            diagnosticResults.innerHTML = '<div class="status-check"><span class="status-icon">â³</span>æ­£åœ¨è¿è¡Œè¯Šæ–­...</div>';

            const checks = [];

            // æ£€æŸ¥1: MetaMaskæ˜¯å¦å®‰è£…
            try {
                if (typeof window.ethereum !== 'undefined') {
                    checks.push({
                        name: 'MetaMaskå®‰è£…',
                        status: 'success',
                        message: 'âœ… MetaMaskå·²å®‰è£…',
                        details: `ç‰ˆæœ¬: ${window.ethereum.version || 'æœªçŸ¥'}`
                    });
                } else {
                    checks.push({
                        name: 'MetaMaskå®‰è£…',
                        status: 'error',
                        message: 'âŒ MetaMaskæœªå®‰è£…',
                        details: 'è¯·å®‰è£…MetaMaskæµè§ˆå™¨æ‰©å±•'
                    });
                }
            } catch (error) {
                checks.push({
                    name: 'MetaMaskå®‰è£…',
                    status: 'error',
                    message: 'âŒ æ£€æŸ¥MetaMaskæ—¶å‡ºé”™',
                    details: error.message
                });
            }

            // æ£€æŸ¥2: Web3.jsæ˜¯å¦åŠ è½½
            try {
                if (typeof Web3 !== 'undefined') {
                    checks.push({
                        name: 'Web3.jsåŠ è½½',
                        status: 'success',
                        message: 'âœ… Web3.jså·²åŠ è½½',
                        details: `ç‰ˆæœ¬: ${Web3.version || 'æœªçŸ¥'}`
                    });
                } else {
                    checks.push({
                        name: 'Web3.jsåŠ è½½',
                        status: 'error',
                        message: 'âŒ Web3.jsæœªåŠ è½½',
                        details: 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–åˆ·æ–°é¡µé¢'
                    });
                }
            } catch (error) {
                checks.push({
                    name: 'Web3.jsåŠ è½½',
                    status: 'error',
                    message: 'âŒ æ£€æŸ¥Web3.jsæ—¶å‡ºé”™',
                    details: error.message
                });
            }

            // æ£€æŸ¥3: ç½‘ç»œè¿æ¥
            try {
                if (typeof window.ethereum !== 'undefined') {
                    const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                    const networkName = getNetworkName(chainId);
                    checks.push({
                        name: 'ç½‘ç»œè¿æ¥',
                        status: 'success',
                        message: 'âœ… ç½‘ç»œå·²è¿æ¥',
                        details: `å½“å‰ç½‘ç»œ: ${networkName} (Chain ID: ${chainId})`
                    });
                } else {
                    checks.push({
                        name: 'ç½‘ç»œè¿æ¥',
                        status: 'error',
                        message: 'âŒ æ— æ³•è·å–ç½‘ç»œä¿¡æ¯',
                        details: 'MetaMaskæœªå®‰è£…æˆ–æœªè¿æ¥'
                    });
                }
            } catch (error) {
                checks.push({
                    name: 'ç½‘ç»œè¿æ¥',
                    status: 'error',
                    message: 'âŒ æ£€æŸ¥ç½‘ç»œæ—¶å‡ºé”™',
                    details: error.message
                });
            }

            // æ£€æŸ¥4: è´¦æˆ·è¿æ¥çŠ¶æ€
            try {
                if (typeof window.ethereum !== 'undefined') {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        checks.push({
                            name: 'è´¦æˆ·è¿æ¥',
                            status: 'success',
                            message: 'âœ… è´¦æˆ·å·²è¿æ¥',
                            details: `åœ°å€: ${accounts[0]}`
                        });
                    } else {
                        checks.push({
                            name: 'è´¦æˆ·è¿æ¥',
                            status: 'warning',
                            message: 'âš ï¸ è´¦æˆ·æœªè¿æ¥',
                            details: 'è¯·ç‚¹å‡»"è¿æ¥MetaMaské’±åŒ…"æŒ‰é’®'
                        });
                    }
                } else {
                    checks.push({
                        name: 'è´¦æˆ·è¿æ¥',
                        status: 'error',
                        message: 'âŒ æ— æ³•æ£€æŸ¥è´¦æˆ·çŠ¶æ€',
                        details: 'MetaMaskæœªå®‰è£…'
                    });
                }
            } catch (error) {
                checks.push({
                    name: 'è´¦æˆ·è¿æ¥',
                    status: 'error',
                    message: 'âŒ æ£€æŸ¥è´¦æˆ·æ—¶å‡ºé”™',
                    details: error.message
                });
            }

            // æ£€æŸ¥5: åˆçº¦åœ°å€æ ¼å¼
            try {
                if (CONTRACT_ADDRESS && CONTRACT_ADDRESS.startsWith('0x') && CONTRACT_ADDRESS.length === 42) {
                    checks.push({
                        name: 'åˆçº¦åœ°å€',
                        status: 'success',
                        message: 'âœ… åˆçº¦åœ°å€æ ¼å¼æ­£ç¡®',
                        details: `åœ°å€: ${CONTRACT_ADDRESS}`
                    });
                } else {
                    checks.push({
                        name: 'åˆçº¦åœ°å€',
                        status: 'error',
                        message: 'âŒ åˆçº¦åœ°å€æ ¼å¼é”™è¯¯',
                        details: `å½“å‰åœ°å€: ${CONTRACT_ADDRESS}`
                    });
                }
            } catch (error) {
                checks.push({
                    name: 'åˆçº¦åœ°å€',
                    status: 'error',
                    message: 'âŒ æ£€æŸ¥åˆçº¦åœ°å€æ—¶å‡ºé”™',
                    details: error.message
                });
            }

            // æ˜¾ç¤ºè¯Šæ–­ç»“æœ
            let resultsHTML = '';
            checks.forEach(check => {
                resultsHTML += `
                    <div class="status-check ${check.status}">
                        <span class="status-icon">${check.status === 'success' ? 'âœ…' : check.status === 'error' ? 'âŒ' : 'âš ï¸'}</span>
                        <div>
                            <strong>${check.name}:</strong> ${check.message}<br>
                            <small>${check.details}</small>
                        </div>
                    </div>
                `;
            });

            // æ·»åŠ å»ºè®®
            const hasErrors = checks.some(check => check.status === 'error');
            const hasWarnings = checks.some(check => check.status === 'warning');
            
            if (hasErrors) {
                resultsHTML += `
                    <div class="debug-info">
                        <strong>ğŸ”§ ä¿®å¤å»ºè®®:</strong>
                        1. ç¡®ä¿å·²å®‰è£…MetaMaskæµè§ˆå™¨æ‰©å±•
                        2. ç¡®ä¿MetaMaskå·²è§£é”å¹¶è¿æ¥åˆ°æ­£ç¡®çš„ç½‘ç»œ
                        3. åˆ·æ–°é¡µé¢é‡è¯•
                        4. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯
                    </div>
                `;
            } else if (hasWarnings) {
                resultsHTML += `
                    <div class="debug-info">
                        <strong>ğŸ’¡ ä¸‹ä¸€æ­¥:</strong>
                        ç‚¹å‡»"è¿æ¥MetaMaské’±åŒ…"æŒ‰é’®å®Œæˆè¿æ¥
                    </div>
                `;
            } else {
                resultsHTML += `
                    <div class="debug-info">
                        <strong>ğŸ‰ æ‰€æœ‰æ£€æŸ¥é€šè¿‡!</strong>
                        ç³»ç»ŸçŠ¶æ€æ­£å¸¸ï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨
                    </div>
                `;
            }

            diagnosticResults.innerHTML = resultsHTML;

            // æ ¹æ®è¯Šæ–­ç»“æœå¯ç”¨/ç¦ç”¨æŒ‰é’®
            const connectBtn = document.getElementById('connectBtn');
            const switchNetworkBtn = document.getElementById('switchNetworkBtn');
            
            if (!hasErrors) {
                connectBtn.disabled = false;
                switchNetworkBtn.disabled = false;
            }
        }

        // è·å–ç½‘ç»œåç§°
        function getNetworkName(chainId) {
            const networks = {
                '0x1': 'Ethereum Mainnet',
                '0x3': 'Ropsten Testnet',
                '0x4': 'Rinkeby Testnet',
                '0x5': 'Goerli Testnet',
                '0x2a': 'Kovan Testnet',
                '0x7a69': 'Hardhat Local Network',
                '0x539': 'Hardhat Local Network'
            };
            return networks[chainId] || `Chain ID: ${chainId}`;
        }

        // åˆ‡æ¢åˆ°æœ¬åœ°ç½‘ç»œ
        async function switchToLocalhost() {
            try {
                const switchBtn = document.getElementById('switchNetworkBtn');
                switchBtn.disabled = true;
                switchBtn.innerHTML = '<span class="spinner"></span> åˆ‡æ¢ä¸­...';

                // å°è¯•åˆ‡æ¢åˆ°æœ¬åœ°ç½‘ç»œ
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: '0x7a69' }],
                });

                showStatus('âœ… å·²åˆ‡æ¢åˆ°æœ¬åœ°ç½‘ç»œ', 'success');
                runDiagnostics(); // é‡æ–°è¿è¡Œè¯Šæ–­

            } catch (switchError) {
                // å¦‚æœç½‘ç»œä¸å­˜åœ¨ï¼Œå°è¯•æ·»åŠ 
                if (switchError.code === 4902) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: '0x7a69',
                                chainName: 'Hardhat Local Network',
                                nativeCurrency: {
                                    name: 'ETH',
                                    symbol: 'ETH',
                                    decimals: 18
                                },
                                rpcUrls: ['http://127.0.0.1:8545'],
                                blockExplorerUrls: []
                            }],
                        });
                        showStatus('âœ… å·²æ·»åŠ å¹¶åˆ‡æ¢åˆ°æœ¬åœ°ç½‘ç»œ', 'success');
                    } catch (addError) {
                        showStatus(`âŒ æ·»åŠ ç½‘ç»œå¤±è´¥: ${addError.message}`, 'error');
                    }
                } else {
                    showStatus(`âŒ åˆ‡æ¢ç½‘ç»œå¤±è´¥: ${switchError.message}`, 'error');
                }
            } finally {
                const switchBtn = document.getElementById('switchNetworkBtn');
                switchBtn.disabled = false;
                switchBtn.innerHTML = 'åˆ‡æ¢åˆ°æœ¬åœ°ç½‘ç»œ';
            }
        }

        // è¿æ¥é’±åŒ…
        async function connectWallet() {
            const connectBtn = document.getElementById('connectBtn');
            const walletInfo = document.getElementById('walletInfo');
            
            try {
                connectBtn.disabled = true;
                connectBtn.innerHTML = '<span class="spinner"></span> è¿æ¥ä¸­...';

                // æ£€æŸ¥MetaMaskæ˜¯å¦å®‰è£…
                if (typeof window.ethereum === 'undefined') {
                    throw new Error('è¯·å®‰è£…MetaMaské’±åŒ…ï¼');
                }

                // è¯·æ±‚è´¦æˆ·è¿æ¥
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });

                userAccount = accounts[0];
                
                // æ£€æŸ¥ç½‘ç»œ
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                const networkName = getNetworkName(chainId);
                
                // åˆå§‹åŒ–Web3å’Œåˆçº¦
                web3 = new Web3(window.ethereum);
                contract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
                
                // è·å–ç”¨æˆ·ä½™é¢
                userBalance = await web3.eth.getBalance(userAccount);
                
                // æ›´æ–°UI
                updateWalletInfo(userAccount, userBalance, networkName);
                updateLotteryInfo();
                enableLottery();
                
                showStatus('âœ… é’±åŒ…è¿æ¥æˆåŠŸï¼', 'success');
                
            } catch (error) {
                console.error('è¿æ¥å¤±è´¥:', error);
                showStatus(`âŒ è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                
                // æä¾›å…·ä½“çš„é”™è¯¯å»ºè®®
                if (error.code === 4001) {
                    showStatus('âŒ ç”¨æˆ·æ‹’ç»äº†è¿æ¥è¯·æ±‚', 'error');
                } else if (error.code === -32002) {
                    showStatus('âŒ è¯·æ£€æŸ¥MetaMaskå¼¹çª—å¹¶ç¡®è®¤è¿æ¥', 'error');
                } else if (error.message.includes('MetaMask')) {
                    showStatus('âŒ è¯·ç¡®ä¿MetaMaskå·²å®‰è£…å¹¶è§£é”', 'error');
                }
                
                connectBtn.disabled = false;
                connectBtn.innerHTML = 'è¿æ¥MetaMaské’±åŒ…';
            }
        }

        // æ›´æ–°é’±åŒ…ä¿¡æ¯
        function updateWalletInfo(account, balance, network) {
            const walletInfo = document.getElementById('walletInfo');
            
            walletInfo.style.display = 'block';
            walletInfo.innerHTML = `
                <p><strong>è´¦æˆ·åœ°å€:</strong> ${account}</p>
                <p><strong>è´¦æˆ·ä½™é¢:</strong> ${web3.utils.fromWei(balance, 'ether')} ETH</p>
                <p><strong>ç½‘ç»œ:</strong> ${network}</p>
                <p><strong>åˆçº¦åœ°å€:</strong> ${CONTRACT_ADDRESS}</p>
            `;
        }

        // å¯ç”¨æŠ½å¥–
        function enableLottery() {
            const lotteryBtn = document.getElementById('lotteryBtn');
            lotteryBtn.disabled = false;
            lotteryBtn.innerHTML = 'ğŸ² å¼€å§‹æŠ½å¥– (0.0001 ETH)';
        }

        // æ›´æ–°æŠ½å¥–ä¿¡æ¯
        async function updateLotteryInfo() {
            if (!contract) return;
            
            try {
                const lotteryInfo = await contract.methods.getLotteryInfo().call();
                const price = web3.utils.fromWei(lotteryInfo.price, 'ether');
                
                document.getElementById('lotteryPrice').textContent = `${price} ETH`;
                document.getElementById('poolSize').textContent = lotteryInfo.poolSize.toString();
                document.getElementById('totalMinted').textContent = lotteryInfo.totalMinted.toString();
                document.getElementById('remainingSupply').textContent = lotteryInfo.remaining.toString();
                
            } catch (error) {
                console.error('è·å–æŠ½å¥–ä¿¡æ¯å¤±è´¥:', error);
                showStatus('âš ï¸ æ— æ³•è·å–æŠ½å¥–ä¿¡æ¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'info');
            }
        }

        // çœŸå®æŠ½å¥–
        async function playLottery() {
            if (!contract || !userAccount) {
                showStatus('âŒ è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
                return;
            }

            const lotteryBtn = document.getElementById('lotteryBtn');
            const originalText = lotteryBtn.innerHTML;
            
            try {
                // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                lotteryBtn.disabled = true;
                lotteryBtn.innerHTML = '<span class="spinner"></span> æŠ½å¥–ä¸­...';
                
                // è·å–æŠ½å¥–ä»·æ ¼
                const price = await contract.methods.lotteryPrice().call();
                
                // æ£€æŸ¥ç”¨æˆ·ä½™é¢
                if (web3.utils.toBN(userBalance).lt(web3.utils.toBN(price))) {
                    throw new Error('ä½™é¢ä¸è¶³ï¼Œæ— æ³•æ”¯ä»˜æŠ½å¥–è´¹ç”¨');
                }
                
                // æ‰§è¡ŒæŠ½å¥–äº¤æ˜“
                const result = await contract.methods.playLottery().send({
                    from: userAccount,
                    value: price,
                    gas: 300000
                });
                
                // æŸ¥æ‰¾æŠ½å¥–äº‹ä»¶
                const lotteryEvent = result.events.LotteryWon;
                if (lotteryEvent) {
                    const tokenId = lotteryEvent.returnValues.tokenId;
                    const winner = lotteryEvent.returnValues.winner;
                    const paidAmount = lotteryEvent.returnValues.price;
                    
                    showStatus(`ğŸ‰ æŠ½å¥–æˆåŠŸï¼è·å¾— SnakeCoin #${tokenId}`, 'success');
                    
                    // ç”ŸæˆNFTå¡ç‰‡
                    await generateNFTCard(tokenId);
                    
                    // æ›´æ–°ä¿¡æ¯
                    updateLotteryInfo();
                    
                    // æ›´æ–°ç”¨æˆ·ä½™é¢
                    userBalance = await web3.eth.getBalance(userAccount);
                    updateWalletInfo(userAccount, userBalance, getNetworkName(await window.ethereum.request({ method: 'eth_chainId' })));
                    
                } else {
                    throw new Error('æŠ½å¥–äº‹ä»¶æœªæ‰¾åˆ°');
                }
                
            } catch (error) {
                console.error('æŠ½å¥–å¤±è´¥:', error);
                showStatus(`âŒ æŠ½å¥–å¤±è´¥: ${error.message}`, 'error');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                lotteryBtn.disabled = false;
                lotteryBtn.innerHTML = originalText;
            }
        }

        // ç”ŸæˆNFTå¡ç‰‡
        async function generateNFTCard(tokenId) {
            try {
                // è·å–SVG
                const svg = await contract.methods.generateSnakeSVG(tokenId).call();
                
                // è·å–TokenURI
                const tokenURI = await contract.methods.tokenURI(tokenId).call();
                
                // è§£ç Base64è·å–å…ƒæ•°æ®
                const base64Data = tokenURI.replace("data:application/json;base64,", "");
                const jsonData = JSON.parse(atob(base64Data));
                
                // åˆ›å»ºNFTå¡ç‰‡
                const nftGrid = document.getElementById('nftGrid');
                const nftCard = document.createElement('div');
                nftCard.className = 'nft-card';
                nftCard.innerHTML = `
                    <h3>${jsonData.name}</h3>
                    <div class="nft-svg">
                        ${svg}
                    </div>
                    <div class="nft-info">
                        <p><strong>Token ID:</strong> ${tokenId}</p>
                        <p><strong>æè¿°:</strong> ${jsonData.description}</p>
                        <p><strong>è›‡ç :</strong> ${jsonData.attributes[0].value}</p>
                        <p><strong>é¢œè‰²ä¸»é¢˜:</strong> <span style="color: ${jsonData.attributes[1].value}">${jsonData.attributes[1].value}</span></p>
                        <p><strong>å›¾æ¡ˆç±»å‹:</strong> ${jsonData.attributes[2].value}</p>
                    </div>
                `;
                
                // æ’å…¥åˆ°ç½‘æ ¼å¼€å¤´
                nftGrid.insertBefore(nftCard, nftGrid.firstChild);
                
            } catch (error) {
                console.error('ç”ŸæˆNFTå¡ç‰‡å¤±è´¥:', error);
                showStatus('âš ï¸ NFTç”ŸæˆæˆåŠŸï¼Œä½†æ˜¾ç¤ºå¤±è´¥', 'info');
            }
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusDiv');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 5000);
        }

        // é¡µé¢åŠ è½½æ—¶è¿è¡Œè¯Šæ–­
        window.onload = function() {
            runDiagnostics();
        };

        // ç›‘å¬è´¦æˆ·å˜åŒ–
        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.on('accountsChanged', function (accounts) {
                if (accounts.length === 0) {
                    // ç”¨æˆ·æ–­å¼€è¿æ¥
                    location.reload();
                } else {
                    // è´¦æˆ·åˆ‡æ¢
                    userAccount = accounts[0];
                    location.reload();
                }
            });

            window.ethereum.on('chainChanged', function (chainId) {
                // ç½‘ç»œåˆ‡æ¢
                location.reload();
            });
        }
    </script>

    <!-- Web3.js åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
</body>
</html>


