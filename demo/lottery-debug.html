<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔧 蛇币NFT抽奖调试版</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 3rem;
            color: #333;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2rem;
            color: #666;
        }

        .debug-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .debug-section h2 {
            color: #333;
            margin-bottom: 15px;
        }

        .debug-info {
            background: #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            font-family: monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
        }

        .status-check {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 5px;
        }

        .status-check.success {
            background: #d4edda;
            color: #155724;
        }

        .status-check.error {
            background: #f8d7da;
            color: #721c24;
        }

        .status-check.warning {
            background: #fff3cd;
            color: #856404;
        }

        .status-icon {
            margin-right: 10px;
            font-size: 1.2rem;
        }

        .wallet-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .connect-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .connect-btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .connect-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .wallet-info {
            margin-top: 15px;
            padding: 15px;
            background: #e9ecef;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.9rem;
        }

        .lottery-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .lottery-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .info-card h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .info-card p {
            font-size: 1.5rem;
            font-weight: bold;
            color: #007bff;
        }

        .lottery-btn {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            border: none;
            padding: 20px 40px;
            border-radius: 50px;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            display: block;
        }

        .lottery-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
        }

        .lottery-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .status {
            text-align: center;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            font-weight: bold;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .nft-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .nft-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .nft-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .nft-card h3 {
            text-align: center;
            margin-bottom: 15px;
            color: #333;
        }

        .nft-svg {
            width: 100%;
            height: 200px;
            border: 1px solid #eee;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .nft-info {
            font-size: 0.9rem;
            color: #666;
        }

        .nft-info p {
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔧 蛇币NFT抽奖调试版</h1>
            <p>诊断MetaMask连接问题并提供解决方案</p>
        </div>

        <div class="debug-section">
            <h2>🔍 系统诊断</h2>
            <div id="diagnosticResults">
                <!-- 诊断结果将在这里显示 -->
            </div>
        </div>

        <div class="wallet-section">
            <h2>🔗 钱包连接</h2>
            <button id="diagnoseBtn" class="connect-btn" onclick="runDiagnostics()">
                运行诊断
            </button>
            <button id="connectBtn" class="connect-btn" onclick="connectWallet()" disabled>
                连接MetaMask钱包
            </button>
            <button id="switchNetworkBtn" class="connect-btn" onclick="switchToLocalhost()" disabled>
                切换到本地网络
            </button>
            <div id="walletInfo" class="wallet-info" style="display: none;">
                <!-- 钱包信息将在这里显示 -->
            </div>
        </div>

        <div class="lottery-section">
            <h2>🎯 抽奖信息</h2>
            
            <div class="lottery-info">
                <div class="info-card">
                    <h3>抽奖价格</h3>
                    <p id="lotteryPrice">0.0001 ETH</p>
                </div>
                <div class="info-card">
                    <h3>池子大小</h3>
                    <p id="poolSize">-</p>
                </div>
                <div class="info-card">
                    <h3>已铸造</h3>
                    <p id="totalMinted">-</p>
                </div>
                <div class="info-card">
                    <h3>剩余数量</h3>
                    <p id="remainingSupply">-</p>
                </div>
            </div>

            <button id="lotteryBtn" class="lottery-btn" onclick="playLottery()" disabled>
                请先连接钱包
            </button>

            <div id="statusDiv"></div>
        </div>

        <div class="nft-grid" id="nftGrid">
            <!-- 抽中的NFT将在这里显示 -->
        </div>
    </div>

    <script>
        // 合约配置
        const CONTRACT_ADDRESS = "0x8A791620dd6260079BF849Dc5567aDC3F2FdC318";
        const CONTRACT_ABI = [
            "function lotteryPrice() view returns (uint256)",
            "function getPoolSize() view returns (uint256)",
            "function totalSupply() view returns (uint256)",
            "function remainingSupply() view returns (uint256)",
            "function playLottery() payable",
            "function generateSnakeSVG(uint256 tokenId) view returns (string)",
            "function tokenURI(uint256 tokenId) view returns (string)",
            "function getLotteryInfo() view returns (uint256 price, uint256 poolSize, uint256 totalMinted, uint256 remaining)",
            "event LotteryWon(address indexed winner, uint256 indexed tokenId, uint256 price)"
        ];

        let web3;
        let contract;
        let userAccount;
        let userBalance;

        // 运行诊断
        async function runDiagnostics() {
            const diagnosticResults = document.getElementById('diagnosticResults');
            diagnosticResults.innerHTML = '<div class="status-check"><span class="status-icon">⏳</span>正在运行诊断...</div>';

            const checks = [];

            // 检查1: MetaMask是否安装
            try {
                if (typeof window.ethereum !== 'undefined') {
                    checks.push({
                        name: 'MetaMask安装',
                        status: 'success',
                        message: '✅ MetaMask已安装',
                        details: `版本: ${window.ethereum.version || '未知'}`
                    });
                } else {
                    checks.push({
                        name: 'MetaMask安装',
                        status: 'error',
                        message: '❌ MetaMask未安装',
                        details: '请安装MetaMask浏览器扩展'
                    });
                }
            } catch (error) {
                checks.push({
                    name: 'MetaMask安装',
                    status: 'error',
                    message: '❌ 检查MetaMask时出错',
                    details: error.message
                });
            }

            // 检查2: Web3.js是否加载
            try {
                if (typeof Web3 !== 'undefined') {
                    checks.push({
                        name: 'Web3.js加载',
                        status: 'success',
                        message: '✅ Web3.js已加载',
                        details: `版本: ${Web3.version || '未知'}`
                    });
                } else {
                    checks.push({
                        name: 'Web3.js加载',
                        status: 'error',
                        message: '❌ Web3.js未加载',
                        details: '请检查网络连接或刷新页面'
                    });
                }
            } catch (error) {
                checks.push({
                    name: 'Web3.js加载',
                    status: 'error',
                    message: '❌ 检查Web3.js时出错',
                    details: error.message
                });
            }

            // 检查3: 网络连接
            try {
                if (typeof window.ethereum !== 'undefined') {
                    const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                    const networkName = getNetworkName(chainId);
                    checks.push({
                        name: '网络连接',
                        status: 'success',
                        message: '✅ 网络已连接',
                        details: `当前网络: ${networkName} (Chain ID: ${chainId})`
                    });
                } else {
                    checks.push({
                        name: '网络连接',
                        status: 'error',
                        message: '❌ 无法获取网络信息',
                        details: 'MetaMask未安装或未连接'
                    });
                }
            } catch (error) {
                checks.push({
                    name: '网络连接',
                    status: 'error',
                    message: '❌ 检查网络时出错',
                    details: error.message
                });
            }

            // 检查4: 账户连接状态
            try {
                if (typeof window.ethereum !== 'undefined') {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        checks.push({
                            name: '账户连接',
                            status: 'success',
                            message: '✅ 账户已连接',
                            details: `地址: ${accounts[0]}`
                        });
                    } else {
                        checks.push({
                            name: '账户连接',
                            status: 'warning',
                            message: '⚠️ 账户未连接',
                            details: '请点击"连接MetaMask钱包"按钮'
                        });
                    }
                } else {
                    checks.push({
                        name: '账户连接',
                        status: 'error',
                        message: '❌ 无法检查账户状态',
                        details: 'MetaMask未安装'
                    });
                }
            } catch (error) {
                checks.push({
                    name: '账户连接',
                    status: 'error',
                    message: '❌ 检查账户时出错',
                    details: error.message
                });
            }

            // 检查5: 合约地址格式
            try {
                if (CONTRACT_ADDRESS && CONTRACT_ADDRESS.startsWith('0x') && CONTRACT_ADDRESS.length === 42) {
                    checks.push({
                        name: '合约地址',
                        status: 'success',
                        message: '✅ 合约地址格式正确',
                        details: `地址: ${CONTRACT_ADDRESS}`
                    });
                } else {
                    checks.push({
                        name: '合约地址',
                        status: 'error',
                        message: '❌ 合约地址格式错误',
                        details: `当前地址: ${CONTRACT_ADDRESS}`
                    });
                }
            } catch (error) {
                checks.push({
                    name: '合约地址',
                    status: 'error',
                    message: '❌ 检查合约地址时出错',
                    details: error.message
                });
            }

            // 显示诊断结果
            let resultsHTML = '';
            checks.forEach(check => {
                resultsHTML += `
                    <div class="status-check ${check.status}">
                        <span class="status-icon">${check.status === 'success' ? '✅' : check.status === 'error' ? '❌' : '⚠️'}</span>
                        <div>
                            <strong>${check.name}:</strong> ${check.message}<br>
                            <small>${check.details}</small>
                        </div>
                    </div>
                `;
            });

            // 添加建议
            const hasErrors = checks.some(check => check.status === 'error');
            const hasWarnings = checks.some(check => check.status === 'warning');
            
            if (hasErrors) {
                resultsHTML += `
                    <div class="debug-info">
                        <strong>🔧 修复建议:</strong>
                        1. 确保已安装MetaMask浏览器扩展
                        2. 确保MetaMask已解锁并连接到正确的网络
                        3. 刷新页面重试
                        4. 检查浏览器控制台是否有错误信息
                    </div>
                `;
            } else if (hasWarnings) {
                resultsHTML += `
                    <div class="debug-info">
                        <strong>💡 下一步:</strong>
                        点击"连接MetaMask钱包"按钮完成连接
                    </div>
                `;
            } else {
                resultsHTML += `
                    <div class="debug-info">
                        <strong>🎉 所有检查通过!</strong>
                        系统状态正常，可以正常使用
                    </div>
                `;
            }

            diagnosticResults.innerHTML = resultsHTML;

            // 根据诊断结果启用/禁用按钮
            const connectBtn = document.getElementById('connectBtn');
            const switchNetworkBtn = document.getElementById('switchNetworkBtn');
            
            if (!hasErrors) {
                connectBtn.disabled = false;
                switchNetworkBtn.disabled = false;
            }
        }

        // 获取网络名称
        function getNetworkName(chainId) {
            const networks = {
                '0x1': 'Ethereum Mainnet',
                '0x3': 'Ropsten Testnet',
                '0x4': 'Rinkeby Testnet',
                '0x5': 'Goerli Testnet',
                '0x2a': 'Kovan Testnet',
                '0x7a69': 'Hardhat Local Network',
                '0x539': 'Hardhat Local Network'
            };
            return networks[chainId] || `Chain ID: ${chainId}`;
        }

        // 切换到本地网络
        async function switchToLocalhost() {
            try {
                const switchBtn = document.getElementById('switchNetworkBtn');
                switchBtn.disabled = true;
                switchBtn.innerHTML = '<span class="spinner"></span> 切换中...';

                // 尝试切换到本地网络
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: '0x7a69' }],
                });

                showStatus('✅ 已切换到本地网络', 'success');
                runDiagnostics(); // 重新运行诊断

            } catch (switchError) {
                // 如果网络不存在，尝试添加
                if (switchError.code === 4902) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: '0x7a69',
                                chainName: 'Hardhat Local Network',
                                nativeCurrency: {
                                    name: 'ETH',
                                    symbol: 'ETH',
                                    decimals: 18
                                },
                                rpcUrls: ['http://127.0.0.1:8545'],
                                blockExplorerUrls: []
                            }],
                        });
                        showStatus('✅ 已添加并切换到本地网络', 'success');
                    } catch (addError) {
                        showStatus(`❌ 添加网络失败: ${addError.message}`, 'error');
                    }
                } else {
                    showStatus(`❌ 切换网络失败: ${switchError.message}`, 'error');
                }
            } finally {
                const switchBtn = document.getElementById('switchNetworkBtn');
                switchBtn.disabled = false;
                switchBtn.innerHTML = '切换到本地网络';
            }
        }

        // 连接钱包
        async function connectWallet() {
            const connectBtn = document.getElementById('connectBtn');
            const walletInfo = document.getElementById('walletInfo');
            
            try {
                connectBtn.disabled = true;
                connectBtn.innerHTML = '<span class="spinner"></span> 连接中...';

                // 检查MetaMask是否安装
                if (typeof window.ethereum === 'undefined') {
                    throw new Error('请安装MetaMask钱包！');
                }

                // 请求账户连接
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });

                userAccount = accounts[0];
                
                // 检查网络
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                const networkName = getNetworkName(chainId);
                
                // 初始化Web3和合约
                web3 = new Web3(window.ethereum);
                contract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
                
                // 获取用户余额
                userBalance = await web3.eth.getBalance(userAccount);
                
                // 更新UI
                updateWalletInfo(userAccount, userBalance, networkName);
                updateLotteryInfo();
                enableLottery();
                
                showStatus('✅ 钱包连接成功！', 'success');
                
            } catch (error) {
                console.error('连接失败:', error);
                showStatus(`❌ 连接失败: ${error.message}`, 'error');
                
                // 提供具体的错误建议
                if (error.code === 4001) {
                    showStatus('❌ 用户拒绝了连接请求', 'error');
                } else if (error.code === -32002) {
                    showStatus('❌ 请检查MetaMask弹窗并确认连接', 'error');
                } else if (error.message.includes('MetaMask')) {
                    showStatus('❌ 请确保MetaMask已安装并解锁', 'error');
                }
                
                connectBtn.disabled = false;
                connectBtn.innerHTML = '连接MetaMask钱包';
            }
        }

        // 更新钱包信息
        function updateWalletInfo(account, balance, network) {
            const walletInfo = document.getElementById('walletInfo');
            
            walletInfo.style.display = 'block';
            walletInfo.innerHTML = `
                <p><strong>账户地址:</strong> ${account}</p>
                <p><strong>账户余额:</strong> ${web3.utils.fromWei(balance, 'ether')} ETH</p>
                <p><strong>网络:</strong> ${network}</p>
                <p><strong>合约地址:</strong> ${CONTRACT_ADDRESS}</p>
            `;
        }

        // 启用抽奖
        function enableLottery() {
            const lotteryBtn = document.getElementById('lotteryBtn');
            lotteryBtn.disabled = false;
            lotteryBtn.innerHTML = '🎲 开始抽奖 (0.0001 ETH)';
        }

        // 更新抽奖信息
        async function updateLotteryInfo() {
            if (!contract) return;
            
            try {
                const lotteryInfo = await contract.methods.getLotteryInfo().call();
                const price = web3.utils.fromWei(lotteryInfo.price, 'ether');
                
                document.getElementById('lotteryPrice').textContent = `${price} ETH`;
                document.getElementById('poolSize').textContent = lotteryInfo.poolSize.toString();
                document.getElementById('totalMinted').textContent = lotteryInfo.totalMinted.toString();
                document.getElementById('remainingSupply').textContent = lotteryInfo.remaining.toString();
                
            } catch (error) {
                console.error('获取抽奖信息失败:', error);
                showStatus('⚠️ 无法获取抽奖信息，请检查网络连接', 'info');
            }
        }

        // 真实抽奖
        async function playLottery() {
            if (!contract || !userAccount) {
                showStatus('❌ 请先连接钱包', 'error');
                return;
            }

            const lotteryBtn = document.getElementById('lotteryBtn');
            const originalText = lotteryBtn.innerHTML;
            
            try {
                // 禁用按钮并显示加载状态
                lotteryBtn.disabled = true;
                lotteryBtn.innerHTML = '<span class="spinner"></span> 抽奖中...';
                
                // 获取抽奖价格
                const price = await contract.methods.lotteryPrice().call();
                
                // 检查用户余额
                if (web3.utils.toBN(userBalance).lt(web3.utils.toBN(price))) {
                    throw new Error('余额不足，无法支付抽奖费用');
                }
                
                // 执行抽奖交易
                const result = await contract.methods.playLottery().send({
                    from: userAccount,
                    value: price,
                    gas: 300000
                });
                
                // 查找抽奖事件
                const lotteryEvent = result.events.LotteryWon;
                if (lotteryEvent) {
                    const tokenId = lotteryEvent.returnValues.tokenId;
                    const winner = lotteryEvent.returnValues.winner;
                    const paidAmount = lotteryEvent.returnValues.price;
                    
                    showStatus(`🎉 抽奖成功！获得 SnakeCoin #${tokenId}`, 'success');
                    
                    // 生成NFT卡片
                    await generateNFTCard(tokenId);
                    
                    // 更新信息
                    updateLotteryInfo();
                    
                    // 更新用户余额
                    userBalance = await web3.eth.getBalance(userAccount);
                    updateWalletInfo(userAccount, userBalance, getNetworkName(await window.ethereum.request({ method: 'eth_chainId' })));
                    
                } else {
                    throw new Error('抽奖事件未找到');
                }
                
            } catch (error) {
                console.error('抽奖失败:', error);
                showStatus(`❌ 抽奖失败: ${error.message}`, 'error');
            } finally {
                // 恢复按钮状态
                lotteryBtn.disabled = false;
                lotteryBtn.innerHTML = originalText;
            }
        }

        // 生成NFT卡片
        async function generateNFTCard(tokenId) {
            try {
                // 获取SVG
                const svg = await contract.methods.generateSnakeSVG(tokenId).call();
                
                // 获取TokenURI
                const tokenURI = await contract.methods.tokenURI(tokenId).call();
                
                // 解码Base64获取元数据
                const base64Data = tokenURI.replace("data:application/json;base64,", "");
                const jsonData = JSON.parse(atob(base64Data));
                
                // 创建NFT卡片
                const nftGrid = document.getElementById('nftGrid');
                const nftCard = document.createElement('div');
                nftCard.className = 'nft-card';
                nftCard.innerHTML = `
                    <h3>${jsonData.name}</h3>
                    <div class="nft-svg">
                        ${svg}
                    </div>
                    <div class="nft-info">
                        <p><strong>Token ID:</strong> ${tokenId}</p>
                        <p><strong>描述:</strong> ${jsonData.description}</p>
                        <p><strong>蛇码:</strong> ${jsonData.attributes[0].value}</p>
                        <p><strong>颜色主题:</strong> <span style="color: ${jsonData.attributes[1].value}">${jsonData.attributes[1].value}</span></p>
                        <p><strong>图案类型:</strong> ${jsonData.attributes[2].value}</p>
                    </div>
                `;
                
                // 插入到网格开头
                nftGrid.insertBefore(nftCard, nftGrid.firstChild);
                
            } catch (error) {
                console.error('生成NFT卡片失败:', error);
                showStatus('⚠️ NFT生成成功，但显示失败', 'info');
            }
        }

        // 显示状态消息
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusDiv');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 5000);
        }

        // 页面加载时运行诊断
        window.onload = function() {
            runDiagnostics();
        };

        // 监听账户变化
        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.on('accountsChanged', function (accounts) {
                if (accounts.length === 0) {
                    // 用户断开连接
                    location.reload();
                } else {
                    // 账户切换
                    userAccount = accounts[0];
                    location.reload();
                }
            });

            window.ethereum.on('chainChanged', function (chainId) {
                // 网络切换
                location.reload();
            });
        }
    </script>

    <!-- Web3.js 库 -->
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
</body>
</html>


